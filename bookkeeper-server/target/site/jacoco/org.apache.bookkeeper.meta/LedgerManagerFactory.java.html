<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LedgerManagerFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.meta</a> &gt; <span class="el_source">LedgerManagerFactory.java</span></div><h1>LedgerManagerFactory.java</h1><pre class="source lang-java linenums">package org.apache.bookkeeper.meta;

/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import java.io.IOException;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.apache.bookkeeper.replication.ReplicationException;
import org.apache.bookkeeper.conf.AbstractConfiguration;
import org.apache.bookkeeper.util.ReflectionUtils;
import org.apache.bookkeeper.util.ZkUtils;
import org.apache.commons.configuration.ConfigurationException;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.ZooKeeper;
import org.apache.zookeeper.data.ACL;

<span class="fc" id="L36">public abstract class LedgerManagerFactory {</span>

<span class="fc" id="L38">    static final Logger LOG = LoggerFactory.getLogger(LedgerManagerFactory.class);</span>
    // v1 layout
    static final int V1 = 1;

    /**
     * Return current factory version.
     *
     * @return current version used by factory.
     */
    public abstract int getCurrentVersion();

    /**
     * Initialize a factory.
     *
     * @param conf
     *          Configuration object used to initialize factory
     * @param zk
     *          Available zookeeper handle for ledger manager to use.
     * @param factoryVersion
     *          What version used to initialize factory.
     * @return ledger manager factory instance
     * @throws IOException when fail to initialize the factory.
     */
    public abstract LedgerManagerFactory initialize(final AbstractConfiguration conf,
                                                    final ZooKeeper zk,
                                                    final int factoryVersion)
    throws IOException;

    /**
     * Uninitialize the factory.
     *
     * @throws IOException when fail to uninitialize the factory.
     */
    public abstract void uninitialize() throws IOException;

    /**
     * Return the ledger id generator, which is used for global unique ledger id
     * generation.
     *
     * @return ledger id generator.
     */
    public abstract LedgerIdGenerator newLedgerIdGenerator();

    /**
     * return ledger manager for client-side to manage ledger metadata.
     *
     * @return ledger manager
     * @see LedgerManager
     */
    public abstract LedgerManager newLedgerManager();

    /**
     * Return a ledger underreplication manager, which is used to
     * mark ledgers as unreplicated, and to retrieve a ledger which
     * is underreplicated so that it can be rereplicated.
     *
     * @return ledger underreplication manager
     * @see LedgerUnderreplicationManager
     */
    public abstract LedgerUnderreplicationManager newLedgerUnderreplicationManager()
            throws KeeperException, InterruptedException, ReplicationException.CompatibilityException;

    /**
     * Create new Ledger Manager Factory.
     *
     * @param conf
     *          Configuration Object.
     * @param zk
     *          ZooKeeper Client Handle, talk to zk to know which ledger manager is used.
     * @return new ledger manager factory
     * @throws IOException
     */
    public static LedgerManagerFactory newLedgerManagerFactory(
        final AbstractConfiguration conf, final ZooKeeper zk)
            throws IOException, KeeperException, InterruptedException {
        Class&lt;? extends LedgerManagerFactory&gt; factoryClass;
        try {
<span class="fc" id="L115">            factoryClass = conf.getLedgerManagerFactoryClass();</span>
<span class="nc" id="L116">        } catch (Exception e) {</span>
<span class="nc" id="L117">            throw new IOException(&quot;Failed to get ledger manager factory class from configuration : &quot;, e);</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">        String ledgerRootPath = conf.getZkLedgersRootPath();</span>

<span class="pc bpc" id="L121" title="2 of 4 branches missed.">        if (null == ledgerRootPath || ledgerRootPath.length() == 0) {</span>
<span class="nc" id="L122">            throw new IOException(&quot;Empty Ledger Root Path.&quot;);</span>
        }

        // if zk is null, return the default ledger manager
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (zk == null) {</span>
<span class="nc" id="L127">            return new FlatLedgerManagerFactory()</span>
<span class="nc" id="L128">                   .initialize(conf, null, FlatLedgerManagerFactory.CUR_VERSION);</span>
        }

        LedgerManagerFactory lmFactory;

        // check that the configured ledger manager is
        // compatible with the existing layout
<span class="fc" id="L135">        LedgerLayout layout = LedgerLayout.readLayout(zk, ledgerRootPath);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (layout == null) { // no existing layout</span>
<span class="fc" id="L137">            lmFactory = createNewLMFactory(conf, zk, factoryClass);</span>
<span class="fc" id="L138">            return lmFactory</span>
<span class="fc" id="L139">                    .initialize(conf, zk, lmFactory.getCurrentVersion());</span>
        }
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L142">            LOG.debug(&quot;read ledger layout {}&quot;, layout);</span>
        }

        // there is existing layout, we need to look into the layout.
        // handle pre V2 layout
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (layout.getLayoutFormatVersion() &lt;= V1) {</span>
            // pre V2 layout we use type of ledger manager
            @SuppressWarnings(&quot;deprecation&quot;)
<span class="nc" id="L150">            String lmType = conf.getLedgerManagerType();</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">            if (lmType != null &amp;&amp; !layout.getManagerFactoryClass().equals(lmType)) {</span>
<span class="nc" id="L152">                throw new IOException(&quot;Configured layout &quot; + lmType</span>
<span class="nc" id="L153">                        + &quot; does not match existing layout &quot;  + layout.getManagerFactoryClass());</span>
            }

            // create the ledger manager
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (FlatLedgerManagerFactory.NAME.equals(layout.getManagerFactoryClass())) {</span>
<span class="nc" id="L158">                lmFactory = new FlatLedgerManagerFactory();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            } else if (HierarchicalLedgerManagerFactory.NAME.equals(layout.getManagerFactoryClass())) {</span>
<span class="nc" id="L160">                lmFactory = new HierarchicalLedgerManagerFactory();</span>
            } else {
<span class="nc" id="L162">                throw new IOException(&quot;Unknown ledger manager type: &quot; + lmType);</span>
            }
<span class="nc" id="L164">            return lmFactory.initialize(conf, zk, layout.getManagerVersion());</span>
        }

        // handle V2 layout case
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (factoryClass != null &amp;&amp;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            !layout.getManagerFactoryClass().equals(factoryClass.getName()) &amp;&amp;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            conf.getProperty(AbstractConfiguration.LEDGER_MANAGER_FACTORY_DISABLE_CLASS_CHECK) == null) { // Disable should ONLY happen during compatibility testing.</span>

<span class="nc" id="L172">            throw new IOException(&quot;Configured layout &quot; + factoryClass.getName()</span>
<span class="nc" id="L173">                                + &quot; does not match existing layout &quot;  + layout.getManagerFactoryClass());</span>
        }
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (factoryClass == null) {</span>
            // no factory specified in configuration
            try {
<span class="fc" id="L178">                Class&lt;?&gt; theCls = Class.forName(layout.getManagerFactoryClass());</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                if (!LedgerManagerFactory.class.isAssignableFrom(theCls)) {</span>
<span class="nc" id="L180">                    throw new IOException(&quot;Wrong ledger manager factory &quot; + layout.getManagerFactoryClass());</span>
                }
<span class="fc" id="L182">                factoryClass = theCls.asSubclass(LedgerManagerFactory.class);</span>
<span class="nc" id="L183">            } catch (ClassNotFoundException cnfe) {</span>
<span class="nc" id="L184">                throw new IOException(&quot;Failed to instantiate ledger manager factory &quot; + layout.getManagerFactoryClass());</span>
<span class="fc" id="L185">            }</span>
        }
        // instantiate a factory
<span class="fc" id="L188">        lmFactory = ReflectionUtils.newInstance(factoryClass);</span>
<span class="fc" id="L189">        return lmFactory.initialize(conf, zk, layout.getManagerVersion());</span>
    }

    /**
     * Creates the new layout and stores in zookeeper and returns the
     * LedgerManagerFactory instance.
     */
    private static LedgerManagerFactory createNewLMFactory(
            final AbstractConfiguration conf, final ZooKeeper zk,
            Class&lt;? extends LedgerManagerFactory&gt; factoryClass)
            throws IOException, KeeperException, InterruptedException {

<span class="fc" id="L201">        String ledgerRootPath = conf.getZkLedgersRootPath();</span>
        LedgerManagerFactory lmFactory;
        LedgerLayout layout;
        // use default ledger manager factory if no one provided
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        if (factoryClass == null) {</span>
            // for backward compatibility, check manager type
            @SuppressWarnings(&quot;deprecation&quot;)
<span class="fc" id="L208">            String lmType = conf.getLedgerManagerType();</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">            if (lmType == null) {</span>
<span class="fc" id="L210">                factoryClass = FlatLedgerManagerFactory.class;</span>
            } else {
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (FlatLedgerManagerFactory.NAME.equals(lmType)) {</span>
<span class="nc" id="L213">                    factoryClass = FlatLedgerManagerFactory.class;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                } else if (HierarchicalLedgerManagerFactory.NAME.equals(lmType)) {</span>
<span class="nc" id="L215">                    factoryClass = HierarchicalLedgerManagerFactory.class;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                } else if (LongHierarchicalLedgerManagerFactory.NAME.equals(lmType)) {</span>
<span class="nc" id="L217">                    factoryClass = LongHierarchicalLedgerManagerFactory.class;</span>
                } else {
<span class="nc" id="L219">                    throw new IOException(&quot;Unknown ledger manager type: &quot;</span>
                            + lmType);
                }
            }
        }

<span class="fc" id="L225">        lmFactory = ReflectionUtils.newInstance(factoryClass);</span>

<span class="fc" id="L227">        layout = new LedgerLayout(factoryClass.getName(),</span>
<span class="fc" id="L228">                lmFactory.getCurrentVersion());</span>
<span class="fc" id="L229">        List&lt;ACL&gt; zkAcls = ZkUtils.getACLs(conf);</span>
        try {
<span class="fc" id="L231">            layout.store(zk, ledgerRootPath, zkAcls);</span>
<span class="nc" id="L232">        } catch (KeeperException.NodeExistsException nee) {</span>
<span class="nc" id="L233">            LedgerLayout layout2 = LedgerLayout.readLayout(zk, ledgerRootPath);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (!layout2.equals(layout)) {</span>
<span class="nc" id="L235">                throw new IOException(</span>
                        &quot;Contention writing to layout to zookeeper, &quot;
                                + &quot; other layout &quot; + layout2
                                + &quot; is incompatible with our &quot; + &quot;layout &quot;
                                + layout);
            }
<span class="fc" id="L241">        }</span>
<span class="fc" id="L242">        return lmFactory;</span>
    }

    /**
     * Format the ledger metadata for LedgerManager
     *
     * @param conf
     *            Configuration instance
     * @param zk
     *            Zookeeper instance
     */
    public void format(final AbstractConfiguration conf, final ZooKeeper zk)
            throws InterruptedException, KeeperException, IOException {

        Class&lt;? extends LedgerManagerFactory&gt; factoryClass;
        try {
<span class="nc" id="L258">            factoryClass = conf.getLedgerManagerFactoryClass();</span>
<span class="nc" id="L259">        } catch (ConfigurationException e) {</span>
<span class="nc" id="L260">            throw new IOException(&quot;Failed to get ledger manager factory class from configuration : &quot;, e);</span>
<span class="nc" id="L261">        }</span>

<span class="nc" id="L263">        LedgerLayout layout = LedgerLayout.readLayout(zk,</span>
<span class="nc" id="L264">                conf.getZkLedgersRootPath());</span>
<span class="nc" id="L265">        layout.delete(zk, conf.getZkLedgersRootPath());</span>
        // Create new layout information again.
<span class="nc" id="L267">        createNewLMFactory(conf, zk, factoryClass);</span>
<span class="nc" id="L268">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>