<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocalBookKeeper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.util</a> &gt; <span class="el_source">LocalBookKeeper.java</span></div><h1>LocalBookKeeper.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.bookkeeper.util;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.InetAddress;
import java.net.Socket;
import java.util.ArrayList;
import java.util.List;

import org.apache.bookkeeper.client.BKException;
import org.apache.bookkeeper.shims.zk.ZooKeeperServerShim;
import org.apache.bookkeeper.shims.zk.ZooKeeperServerShimFactory;
import org.apache.bookkeeper.zookeeper.ZooKeeperClient;
import org.apache.commons.io.FileUtils;
import org.apache.bookkeeper.bookie.BookieException;
import org.apache.bookkeeper.conf.ServerConfiguration;
import org.apache.bookkeeper.proto.BookieServer;
import org.apache.bookkeeper.replication.ReplicationException.CompatibilityException;
import org.apache.bookkeeper.replication.ReplicationException.UnavailableException;
import org.apache.bookkeeper.stats.StatsLogger;
import org.apache.bookkeeper.stats.StatsProvider;
import org.apache.bookkeeper.tls.SecurityException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.apache.zookeeper.CreateMode;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.ZooDefs.Ids;

import static com.google.common.base.Charsets.UTF_8;

public class LocalBookKeeper {
<span class="nc" id="L52">    protected static final Logger LOG = LoggerFactory.getLogger(LocalBookKeeper.class);</span>
    public static final int CONNECTION_TIMEOUT = 30000;

    int numberOfBookies;

    public LocalBookKeeper() {
<span class="nc" id="L58">        this(3);</span>
<span class="nc" id="L59">    }</span>

    public LocalBookKeeper(int numberOfBookies) {
<span class="nc" id="L62">        this(numberOfBookies, 5000);</span>
<span class="nc" id="L63">    }</span>

<span class="nc" id="L65">    public LocalBookKeeper(int numberOfBookies, int initialPort) {</span>
<span class="nc" id="L66">        this.numberOfBookies = numberOfBookies;</span>
<span class="nc" id="L67">        this.initialPort = initialPort;</span>
<span class="nc" id="L68">        LOG.info(&quot;Running {} bookie(s) on zkServer {}.&quot;, this.numberOfBookies);</span>
<span class="nc" id="L69">    }</span>

<span class="nc" id="L71">    static String ZooKeeperDefaultHost = &quot;127.0.0.1&quot;;</span>
<span class="nc" id="L72">    static int ZooKeeperDefaultPort = 2181;</span>
<span class="nc" id="L73">    static int zkSessionTimeOut = 5000;</span>
<span class="nc" id="L74">    static Integer BookieDefaultInitialPort = 5000;</span>

    //BookKeeper variables
    File journalDirs[];
    BookieServer bs[];
    ServerConfiguration bsConfs[];
<span class="nc" id="L80">    Integer initialPort = 5000;</span>

    /**
     * @param maxCC
     *          Max Concurrency of Client
     * @param zookeeperPort
     *          ZooKeeper Server Port
     */
    public static ZooKeeperServerShim runZookeeper(int maxCC, int zookeeperPort) throws IOException {
<span class="nc" id="L89">        File zkTmpDir = IOUtils.createTempDir(&quot;zookeeper&quot;, &quot;localbookkeeper&quot;);</span>
<span class="nc" id="L90">        return runZookeeper(maxCC, zookeeperPort, zkTmpDir);</span>
    }

    public static ZooKeeperServerShim runZookeeper(int maxCC, int zookeeperPort, File zkDir) throws IOException {
<span class="nc" id="L94">        LOG.info(&quot;Starting ZK server&quot;);</span>
<span class="nc" id="L95">        ZooKeeperServerShim server = ZooKeeperServerShimFactory.createServer(zkDir, zkDir, zookeeperPort, maxCC);</span>
<span class="nc" id="L96">        server.start();</span>

<span class="nc" id="L98">        boolean b = waitForServerUp(InetAddress.getLoopbackAddress().getHostAddress() + &quot;:&quot; + zookeeperPort,</span>
          CONNECTION_TIMEOUT);
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L101">            LOG.debug(&quot;ZooKeeper server up: {}&quot;, b);</span>
        }
<span class="nc" id="L103">        return server;</span>
    }

    private void initializeZookeeper(String zkHost, int zkPort) throws IOException {
<span class="nc" id="L107">        LOG.info(&quot;Instantiate ZK Client&quot;);</span>
        //initialize the zk client with values
<span class="nc" id="L109">        ZooKeeperClient zkc = null;</span>
        try {
<span class="nc" id="L111">            zkc = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L112">                    .connectString(zkHost + &quot;:&quot; + zkPort)</span>
<span class="nc" id="L113">                    .sessionTimeoutMs(zkSessionTimeOut)</span>
<span class="nc" id="L114">                    .build();</span>
<span class="nc" id="L115">            zkc.create(&quot;/ledgers&quot;, new byte[0], Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span>
<span class="nc" id="L116">            zkc.create(&quot;/ledgers/available&quot;, new byte[0], Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span>
            // No need to create an entry for each requested bookie anymore as the
            // BookieServers will register themselves with ZooKeeper on startup.
<span class="nc" id="L119">        } catch (KeeperException e) {</span>
<span class="nc" id="L120">            LOG.error(&quot;Exception while creating znodes&quot;, e);</span>
<span class="nc" id="L121">            throw new IOException(&quot;Error creating znodes : &quot;, e);</span>
<span class="nc" id="L122">        } catch (InterruptedException e) {</span>
<span class="nc" id="L123">            LOG.error(&quot;Interrupted while creating znodes&quot;, e);</span>
<span class="nc" id="L124">            throw new IOException(&quot;Error creating znodes : &quot;, e);</span>
<span class="nc" id="L125">        }</span>
<span class="nc" id="L126">    }</span>

    private static void cleanupDirectories(List&lt;File&gt; dirs) throws IOException {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        for (File dir : dirs) {</span>
<span class="nc" id="L130">            FileUtils.deleteDirectory(dir);</span>
<span class="nc" id="L131">        }</span>
<span class="nc" id="L132">    }</span>

    private List&lt;File&gt; runBookies(ServerConfiguration baseConf, String dirSuffix)
            throws IOException, KeeperException, InterruptedException, BookieException,
            UnavailableException, CompatibilityException, SecurityException, BKException {
<span class="nc" id="L137">        List&lt;File&gt; tempDirs = new ArrayList&lt;File&gt;();</span>
        try {
<span class="nc" id="L139">            runBookies(baseConf, tempDirs, dirSuffix);</span>
<span class="nc" id="L140">            return tempDirs;</span>
<span class="nc" id="L141">        } catch (IOException ioe) {</span>
<span class="nc" id="L142">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L143">            throw ioe;</span>
<span class="nc" id="L144">        } catch (KeeperException ke) {</span>
<span class="nc" id="L145">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L146">            throw ke;</span>
<span class="nc" id="L147">        } catch (InterruptedException ie) {</span>
<span class="nc" id="L148">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L149">            throw ie;</span>
<span class="nc" id="L150">        } catch (BookieException be) {</span>
<span class="nc" id="L151">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L152">            throw be;</span>
<span class="nc" id="L153">        } catch (UnavailableException ue) {</span>
<span class="nc" id="L154">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L155">            throw ue;</span>
<span class="nc" id="L156">        } catch (CompatibilityException ce) {</span>
<span class="nc" id="L157">            cleanupDirectories(tempDirs);</span>
<span class="nc" id="L158">            throw ce;</span>
        }
    }

    @SuppressWarnings(&quot;deprecation&quot;)
    private void runBookies(ServerConfiguration baseConf, List&lt;File&gt; tempDirs, String dirSuffix)
            throws IOException, KeeperException, InterruptedException, BookieException, UnavailableException,
            CompatibilityException, SecurityException, BKException {
<span class="nc" id="L166">        LOG.info(&quot;Starting Bookie(s)&quot;);</span>
        // Create Bookie Servers (B1, B2, B3)

<span class="nc" id="L169">        journalDirs = new File[numberOfBookies];</span>
<span class="nc" id="L170">        bs = new BookieServer[numberOfBookies];</span>
<span class="nc" id="L171">        bsConfs = new ServerConfiguration[numberOfBookies];</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">        for(int i = 0; i &lt; numberOfBookies; i++) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (null == baseConf.getJournalDirNameWithoutDefault()) {</span>
<span class="nc" id="L175">                journalDirs[i] = IOUtils.createTempDir(&quot;localbookkeeper&quot; + Integer.toString(i), dirSuffix);</span>
<span class="nc" id="L176">                tempDirs.add(journalDirs[i]);</span>
            } else {
<span class="nc" id="L178">                journalDirs[i] = new File(baseConf.getJournalDirName(), &quot;bookie&quot; + Integer.toString(i));</span>
            }
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (journalDirs[i].exists()) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (journalDirs[i].isDirectory()) {</span>
<span class="nc" id="L182">                    FileUtils.deleteDirectory(journalDirs[i]);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                } else if (!journalDirs[i].delete()) {</span>
<span class="nc" id="L184">                    throw new IOException(&quot;Couldn't cleanup bookie journal dir &quot; + journalDirs[i]);</span>
                }
            }
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (!journalDirs[i].mkdirs()) {</span>
<span class="nc" id="L188">                throw new IOException(&quot;Couldn't create bookie journal dir &quot; + journalDirs[i]);</span>
            }

<span class="nc" id="L191">            String [] ledgerDirs = baseConf.getLedgerDirWithoutDefault();</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">            if ((null == ledgerDirs) || (0 == ledgerDirs.length)) {</span>
<span class="nc" id="L193">                ledgerDirs = new String[] { journalDirs[i].getPath() };</span>
            } else {
<span class="nc bnc" id="L195" title="All 2 branches missed.">                for (int l = 0; l &lt; ledgerDirs.length; l++) {</span>
<span class="nc" id="L196">                    File dir = new File(ledgerDirs[l], &quot;bookie&quot; + Integer.toString(i));</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                    if (dir.exists()) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                        if (dir.isDirectory()) {</span>
<span class="nc" id="L199">                            FileUtils.deleteDirectory(dir);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                        } else if (!dir.delete()) {</span>
<span class="nc" id="L201">                            throw new IOException(&quot;Couldn't cleanup bookie ledger dir &quot; + dir);</span>
                        }
                    }
<span class="nc bnc" id="L204" title="All 2 branches missed.">                    if (!dir.mkdirs()) {</span>
<span class="nc" id="L205">                        throw new IOException(&quot;Couldn't create bookie ledger dir &quot; + dir);</span>
                    }
<span class="nc" id="L207">                    ledgerDirs[l] = dir.getPath();</span>
                }
            }

<span class="nc" id="L211">            bsConfs[i] = new ServerConfiguration(baseConf);</span>

            // If the caller specified ephemeral ports then use ephemeral ports for all
            // the bookies else use numBookie ports starting at initialPort
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (0 == initialPort) {</span>
<span class="nc" id="L216">                bsConfs[i].setBookiePort(0);</span>
            } else {
<span class="nc" id="L218">                bsConfs[i].setBookiePort(initialPort + i);</span>
            }

<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (null == baseConf.getZkServers()) {</span>
<span class="nc" id="L222">                bsConfs[i].setZkServers(InetAddress.getLocalHost().getHostAddress() + &quot;:&quot;</span>
                                  + ZooKeeperDefaultPort);
            }


<span class="nc" id="L227">            bsConfs[i].setJournalDirName(journalDirs[i].getPath());</span>
<span class="nc" id="L228">            bsConfs[i].setLedgerDirNames(ledgerDirs);</span>

<span class="nc" id="L230">            bs[i] = new BookieServer(bsConfs[i]);</span>
<span class="nc" id="L231">            bs[i].start();</span>
        }
<span class="nc" id="L233">    }</span>

    public static void startLocalBookies(String zkHost,
                                         int zkPort,
                                         int numBookies,
                                         boolean shouldStartZK,
                                         int initialBookiePort)
            throws Exception {
<span class="nc" id="L241">        ServerConfiguration conf = new ServerConfiguration();</span>
<span class="nc" id="L242">        startLocalBookiesInternal(conf, zkHost, zkPort, numBookies, shouldStartZK, initialBookiePort, true, &quot;test&quot;);</span>
<span class="nc" id="L243">    }</span>

    public static void startLocalBookies(String zkHost,
                                         int zkPort,
                                         int numBookies,
                                         boolean shouldStartZK,
                                         int initialBookiePort,
                                         ServerConfiguration conf)
            throws Exception {
<span class="nc" id="L252">        startLocalBookiesInternal(conf, zkHost, zkPort, numBookies, shouldStartZK, initialBookiePort, true, &quot;test&quot;);</span>
<span class="nc" id="L253">    }</span>

    public static void startLocalBookies(String zkHost,
                                         int zkPort,
                                         int numBookies,
                                         boolean shouldStartZK,
                                         int initialBookiePort,
                                         String dirSuffix)
            throws Exception {
<span class="nc" id="L262">        ServerConfiguration conf = new ServerConfiguration();</span>
<span class="nc" id="L263">        startLocalBookiesInternal(conf, zkHost, zkPort, numBookies, shouldStartZK, initialBookiePort, true, dirSuffix);</span>
<span class="nc" id="L264">    }</span>

    static void startLocalBookiesInternal(ServerConfiguration conf,
                                          String zkHost,
                                          int zkPort,
                                          int numBookies,
                                          boolean shouldStartZK,
                                          int initialBookiePort,
                                          boolean stopOnExit,
                                          String dirSuffix)
            throws Exception {
<span class="nc" id="L275">        LocalBookKeeper lb = new LocalBookKeeper(numBookies, initialBookiePort);</span>

<span class="nc" id="L277">        ZooKeeperServerShim zks = null;</span>
<span class="nc" id="L278">        File zkTmpDir = null;</span>
<span class="nc" id="L279">        List&lt;File&gt; bkTmpDirs = null;</span>
        try {
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (shouldStartZK) {</span>
<span class="nc" id="L282">                zkTmpDir = IOUtils.createTempDir(&quot;zookeeper&quot;, dirSuffix);</span>
<span class="nc" id="L283">                zks = LocalBookKeeper.runZookeeper(1000, zkPort, zkTmpDir);</span>
            }

<span class="nc" id="L286">            lb.initializeZookeeper(zkHost, zkPort);</span>
<span class="nc" id="L287">            conf.setZkServers(zkHost + &quot;:&quot; + zkPort);</span>
<span class="nc" id="L288">            bkTmpDirs = lb.runBookies(conf, dirSuffix);</span>

            try {
                while (true) {
<span class="nc" id="L292">                    Thread.sleep(5000);</span>
                }
<span class="nc" id="L294">            } catch (InterruptedException ie) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                if (stopOnExit) {</span>
<span class="nc" id="L296">                    lb.shutdownBookies();</span>

<span class="nc bnc" id="L298" title="All 2 branches missed.">                    if (null != zks) {</span>
<span class="nc" id="L299">                        zks.stop();</span>
                    }
                }
<span class="nc" id="L302">                throw ie;</span>
            }
<span class="nc" id="L304">        } catch (Exception e) {</span>
<span class="nc" id="L305">            LOG.error(&quot;Failed to run {} bookies : zk ensemble = '{}:{}'&quot;,</span>
<span class="nc" id="L306">                new Object[] { numBookies, zkHost, zkPort, e });</span>
<span class="nc" id="L307">            throw e;</span>
        } finally {
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (stopOnExit) {</span>
<span class="nc" id="L310">                cleanupDirectories(bkTmpDirs);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                if (null != zkTmpDir) {</span>
<span class="nc" id="L312">                    FileUtils.deleteDirectory(zkTmpDir);</span>
                }
            }
        }
    }

    public static void main(String[] args) throws Exception, SecurityException {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if(args.length &lt; 1) {</span>
<span class="nc" id="L320">            usage();</span>
<span class="nc" id="L321">            System.exit(-1);</span>
        }

<span class="nc" id="L324">        int numBookies = Integer.parseInt(args[0]);</span>

<span class="nc" id="L326">        ServerConfiguration conf = new ServerConfiguration();</span>
<span class="nc" id="L327">        conf.setAllowLoopback(true);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (args.length &gt;= 2) {</span>
<span class="nc" id="L329">            String confFile = args[1];</span>
            try {
<span class="nc" id="L331">                conf.loadConf(new File(confFile).toURI().toURL());</span>
<span class="nc" id="L332">                LOG.info(&quot;Using configuration file &quot; + confFile);</span>
<span class="nc" id="L333">            } catch (Exception e) {</span>
                // load conf failed
<span class="nc" id="L335">                LOG.warn(&quot;Error loading configuration file &quot; + confFile, e);</span>
<span class="nc" id="L336">            }</span>
        }

<span class="nc" id="L339">        startLocalBookiesInternal(conf, ZooKeeperDefaultHost, ZooKeeperDefaultPort,</span>
<span class="nc" id="L340">                numBookies, true, BookieDefaultInitialPort, false, &quot;test&quot;);</span>
<span class="nc" id="L341">    }</span>

    private static void usage() {
<span class="nc" id="L344">        System.err.println(&quot;Usage: LocalBookKeeper number-of-bookies&quot;);</span>
<span class="nc" id="L345">    }</span>

    public static boolean waitForServerUp(String hp, long timeout) {
<span class="nc" id="L348">        long start = MathUtils.now();</span>
<span class="nc" id="L349">        String split[] = hp.split(&quot;:&quot;);</span>
<span class="nc" id="L350">        String host = split[0];</span>
<span class="nc" id="L351">        int port = Integer.parseInt(split[1]);</span>
        while (true) {
            try {
<span class="nc" id="L354">                Socket sock = new Socket(host, port);</span>
<span class="nc" id="L355">                BufferedReader reader = null;</span>
                try {
<span class="nc" id="L357">                    OutputStream outstream = sock.getOutputStream();</span>
<span class="nc" id="L358">                    outstream.write(&quot;stat&quot;.getBytes(UTF_8));</span>
<span class="nc" id="L359">                    outstream.flush();</span>

<span class="nc" id="L361">                    reader =</span>
                        new BufferedReader(
<span class="nc" id="L363">                                new InputStreamReader(sock.getInputStream(), UTF_8));</span>
<span class="nc" id="L364">                    String line = reader.readLine();</span>
<span class="nc bnc" id="L365" title="All 4 branches missed.">                    if (line != null &amp;&amp; line.startsWith(&quot;Zookeeper version:&quot;)) {</span>
<span class="nc" id="L366">                        LOG.info(&quot;Server UP&quot;);</span>
<span class="nc" id="L367">                        return true;</span>
                    }
                } finally {
<span class="nc" id="L370">                    sock.close();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                    if (reader != null) {</span>
<span class="nc" id="L372">                        reader.close();</span>
                    }
                }
<span class="nc" id="L375">            } catch (IOException e) {</span>
                // ignore as this is expected
<span class="nc" id="L377">                LOG.info(&quot;server &quot; + hp + &quot; not up &quot; + e);</span>
<span class="nc" id="L378">            }</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (MathUtils.now() &gt; start + timeout) {</span>
<span class="nc" id="L381">                break;</span>
            }
            try {
<span class="nc" id="L384">                Thread.sleep(250);</span>
<span class="nc" id="L385">            } catch (InterruptedException e) {</span>
                // ignore
<span class="nc" id="L387">            }</span>
        }
<span class="nc" id="L389">        return false;</span>
    }

    public void shutdownBookies() {
<span class="nc bnc" id="L393" title="All 2 branches missed.">        for (BookieServer bookieServer: bs) {</span>
<span class="nc" id="L394">            bookieServer.shutdown();</span>
        }
<span class="nc" id="L396">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>