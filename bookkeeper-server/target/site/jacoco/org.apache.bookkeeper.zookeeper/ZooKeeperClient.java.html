<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ZooKeeperClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.zookeeper</a> &gt; <span class="el_source">ZooKeeperClient.java</span></div><h1>ZooKeeperClient.java</h1><pre class="source lang-java linenums">/**
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */
package org.apache.bookkeeper.zookeeper;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.util.concurrent.RateLimiter;
import com.google.common.util.concurrent.ThreadFactoryBuilder;
import java.io.IOException;
import java.util.List;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicReference;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.bookkeeper.stats.OpStatsLogger;
import org.apache.bookkeeper.stats.StatsLogger;
import org.apache.bookkeeper.zookeeper.ZooWorker.ZooCallable;
import org.apache.zookeeper.AsyncCallback.ACLCallback;
import org.apache.zookeeper.AsyncCallback.Children2Callback;
import org.apache.zookeeper.AsyncCallback.ChildrenCallback;
import org.apache.zookeeper.AsyncCallback.Create2Callback;
import org.apache.zookeeper.AsyncCallback.DataCallback;
import org.apache.zookeeper.AsyncCallback.MultiCallback;
import org.apache.zookeeper.AsyncCallback.StatCallback;
import org.apache.zookeeper.AsyncCallback.StringCallback;
import org.apache.zookeeper.AsyncCallback.VoidCallback;
import org.apache.zookeeper.CreateMode;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.Op;
import org.apache.zookeeper.OpResult;
import org.apache.zookeeper.Transaction;
import org.apache.zookeeper.WatchedEvent;
import org.apache.zookeeper.Watcher;
import org.apache.zookeeper.Watcher.Event.EventType;
import org.apache.zookeeper.Watcher.Event.KeeperState;
import org.apache.zookeeper.ZooKeeper;
import org.apache.zookeeper.data.ACL;
import org.apache.zookeeper.data.Stat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Provide a zookeeper client to handle session expire.
 */
public class ZooKeeperClient extends ZooKeeper implements Watcher {

<span class="fc" id="L73">    private static final Logger logger = LoggerFactory.getLogger(ZooKeeperClient.class);</span>

    private static final int DEFAULT_RETRY_EXECUTOR_THREAD_COUNT = 1;

    // ZooKeeper client connection variables
    private final String connectString;
    private final int sessionTimeoutMs;

    // state for the zookeeper client
<span class="fc" id="L82">    private final AtomicReference&lt;ZooKeeper&gt; zk = new AtomicReference&lt;ZooKeeper&gt;();</span>
<span class="fc" id="L83">    private final AtomicBoolean closed = new AtomicBoolean(false);</span>
    private final ZooKeeperWatcherBase watcherManager;

    private final ScheduledExecutorService retryExecutor;
    private final ExecutorService connectExecutor;

    // rate limiter
    private final RateLimiter rateLimiter;

    // retry polices
    private final RetryPolicy connectRetryPolicy;
    private final RetryPolicy operationRetryPolicy;

    // Stats Logger
    private final OpStatsLogger createStats;
    private final OpStatsLogger getStats;
    private final OpStatsLogger setStats;
    private final OpStatsLogger deleteStats;
    private final OpStatsLogger getChildrenStats;
    private final OpStatsLogger existsStats;
    private final OpStatsLogger multiStats;
    private final OpStatsLogger getACLStats;
    private final OpStatsLogger setACLStats;
    private final OpStatsLogger syncStats;
    private final OpStatsLogger createClientStats;

<span class="fc" id="L109">    private final Callable&lt;ZooKeeper&gt; clientCreator = new Callable&lt;ZooKeeper&gt;() {</span>

        @Override
        public ZooKeeper call() throws Exception {
            try {
<span class="nc" id="L114">                return ZooWorker.syncCallWithRetries(null, new ZooCallable&lt;ZooKeeper&gt;() {</span>

                    @Override
                    public ZooKeeper call() throws KeeperException, InterruptedException {
<span class="nc" id="L118">                        logger.info(&quot;Reconnecting zookeeper {}.&quot;, connectString);</span>
                        // close the previous one
<span class="nc" id="L120">                        closeZkHandle();</span>
                        ZooKeeper newZk;
                        try {
<span class="nc" id="L123">                            newZk = createZooKeeper();</span>
<span class="nc" id="L124">                        } catch (IOException ie) {</span>
<span class="nc" id="L125">                            logger.error(&quot;Failed to create zookeeper instance to &quot; + connectString, ie);</span>
<span class="nc" id="L126">                            throw KeeperException.create(KeeperException.Code.CONNECTIONLOSS);</span>
<span class="nc" id="L127">                        }</span>
<span class="nc" id="L128">                        waitForConnection();</span>
<span class="nc" id="L129">                        zk.set(newZk);</span>
<span class="nc" id="L130">                        logger.info(&quot;ZooKeeper session {} is created to {}.&quot;,</span>
<span class="nc" id="L131">                                Long.toHexString(newZk.getSessionId()), connectString);</span>
<span class="nc" id="L132">                        return newZk;</span>
                    }

                    @Override
                    public String toString() {
<span class="nc" id="L137">                        return String.format(&quot;ZooKeeper Client Creator (%s)&quot;, connectString);</span>
                    }

<span class="nc" id="L140">                }, connectRetryPolicy, rateLimiter, createClientStats);</span>
<span class="nc" id="L141">            } catch (Exception e) {</span>
<span class="nc" id="L142">                logger.error(&quot;Gave up reconnecting to ZooKeeper : &quot;, e);</span>
<span class="nc" id="L143">                Runtime.getRuntime().exit(-1);</span>
<span class="nc" id="L144">                return null;</span>
            }
        }

    };

    @VisibleForTesting
    static ZooKeeperClient createConnectedZooKeeperClient(
            String connectString, int sessionTimeoutMs, Set&lt;Watcher&gt; childWatchers,
            RetryPolicy operationRetryPolicy)
                    throws KeeperException, InterruptedException, IOException {
<span class="nc" id="L155">        return ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L156">                .connectString(connectString)</span>
<span class="nc" id="L157">                .sessionTimeoutMs(sessionTimeoutMs)</span>
<span class="nc" id="L158">                .watchers(childWatchers)</span>
<span class="nc" id="L159">                .operationRetryPolicy(operationRetryPolicy)</span>
<span class="nc" id="L160">                .build();</span>
    }

    /**
     * A builder to build retryable zookeeper client.
     */
    public static class Builder {
<span class="fc" id="L167">        String connectString = null;</span>
<span class="fc" id="L168">        int sessionTimeoutMs = 10000;</span>
<span class="fc" id="L169">        Set&lt;Watcher&gt; watchers = null;</span>
<span class="fc" id="L170">        RetryPolicy connectRetryPolicy = null;</span>
<span class="fc" id="L171">        RetryPolicy operationRetryPolicy = null;</span>
<span class="fc" id="L172">        StatsLogger statsLogger = NullStatsLogger.INSTANCE;</span>
<span class="fc" id="L173">        int retryExecThreadCount = DEFAULT_RETRY_EXECUTOR_THREAD_COUNT;</span>
<span class="fc" id="L174">        double requestRateLimit = 0;</span>

<span class="fc" id="L176">        private Builder() {}</span>

        public Builder connectString(String connectString) {
<span class="fc" id="L179">            this.connectString = connectString;</span>
<span class="fc" id="L180">            return this;</span>
        }

        public Builder sessionTimeoutMs(int sessionTimeoutMs) {
<span class="fc" id="L184">            this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="fc" id="L185">            return this;</span>
        }

        public Builder watchers(Set&lt;Watcher&gt; watchers) {
<span class="fc" id="L189">            this.watchers = watchers;</span>
<span class="fc" id="L190">            return this;</span>
        }

        public Builder connectRetryPolicy(RetryPolicy retryPolicy) {
<span class="nc" id="L194">            this.connectRetryPolicy = retryPolicy;</span>
<span class="nc" id="L195">            return this;</span>
        }

        public Builder operationRetryPolicy(RetryPolicy retryPolicy) {
<span class="fc" id="L199">            this.operationRetryPolicy = retryPolicy;</span>
<span class="fc" id="L200">            return this;</span>
        }

        public Builder statsLogger(StatsLogger statsLogger) {
<span class="fc" id="L204">            this.statsLogger = statsLogger;</span>
<span class="fc" id="L205">            return this;</span>
        }

        public Builder requestRateLimit(double requestRateLimit) {
<span class="fc" id="L209">            this.requestRateLimit = requestRateLimit;</span>
<span class="fc" id="L210">            return this;</span>
        }

        public Builder retryThreadCount(int numThreads) {
<span class="nc" id="L214">            this.retryExecThreadCount = numThreads;</span>
<span class="nc" id="L215">            return this;</span>
        }

        public ZooKeeperClient build() throws IOException, KeeperException, InterruptedException {
<span class="fc" id="L219">            checkNotNull(connectString);</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">            checkArgument(sessionTimeoutMs &gt; 0);</span>
<span class="fc" id="L221">            checkNotNull(statsLogger);</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">            checkArgument(retryExecThreadCount &gt; 0);</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">            if (null == connectRetryPolicy) {</span>
<span class="fc" id="L225">                connectRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(sessionTimeoutMs, sessionTimeoutMs, Integer.MAX_VALUE);
            }
<span class="fc bfc" id="L228" title="All 2 branches covered.">            if (null == operationRetryPolicy) {</span>
<span class="fc" id="L229">                operationRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(sessionTimeoutMs, sessionTimeoutMs, 0);
            }

            // Create a watcher manager
<span class="fc" id="L234">            StatsLogger watcherStatsLogger = statsLogger.scope(&quot;watcher&quot;);</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">            ZooKeeperWatcherBase watcherManager =</span>
                    null == watchers ? new ZooKeeperWatcherBase(sessionTimeoutMs, watcherStatsLogger) :
                            new ZooKeeperWatcherBase(sessionTimeoutMs, watchers, watcherStatsLogger);
<span class="fc" id="L238">            ZooKeeperClient client = new ZooKeeperClient(</span>
                    connectString,
                    sessionTimeoutMs,
                    watcherManager,
                    connectRetryPolicy,
                    operationRetryPolicy,
                    statsLogger,
                    retryExecThreadCount,
                    requestRateLimit
            );
            // Wait for connection to be established.
            try {
<span class="fc" id="L250">                watcherManager.waitForConnection();</span>
<span class="nc" id="L251">            } catch (KeeperException ke) {</span>
<span class="nc" id="L252">                client.close();</span>
<span class="nc" id="L253">                throw ke;</span>
<span class="nc" id="L254">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L255">                client.close();</span>
<span class="nc" id="L256">                throw ie;</span>
<span class="fc" id="L257">            }</span>
<span class="fc" id="L258">            return client;</span>
        }
    }

    public static Builder newBuilder() {
<span class="fc" id="L263">        return new Builder();</span>
    }

    ZooKeeperClient(String connectString,
                    int sessionTimeoutMs,
                    ZooKeeperWatcherBase watcherManager,
                    RetryPolicy connectRetryPolicy,
                    RetryPolicy operationRetryPolicy,
                    StatsLogger statsLogger,
                    int retryExecThreadCount,
                    double rate) throws IOException {
<span class="fc" id="L274">        super(connectString, sessionTimeoutMs, watcherManager);</span>
<span class="fc" id="L275">        this.connectString = connectString;</span>
<span class="fc" id="L276">        this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="fc" id="L277">        this.watcherManager = watcherManager;</span>
<span class="fc" id="L278">        this.connectRetryPolicy = connectRetryPolicy;</span>
<span class="fc" id="L279">        this.operationRetryPolicy = operationRetryPolicy;</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        this.rateLimiter = rate &gt; 0 ? RateLimiter.create(rate) : null;</span>
<span class="fc" id="L281">        this.retryExecutor =</span>
<span class="fc" id="L282">                Executors.newScheduledThreadPool(retryExecThreadCount,</span>
<span class="fc" id="L283">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-retry-executor-%d&quot;).build());</span>
<span class="fc" id="L284">        this.connectExecutor =</span>
<span class="fc" id="L285">                Executors.newSingleThreadExecutor(</span>
<span class="fc" id="L286">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-connect-executor-%d&quot;).build());</span>
        // added itself to the watcher
<span class="fc" id="L288">        watcherManager.addChildWatcher(this);</span>

        // Stats
<span class="fc" id="L291">        StatsLogger scopedStatsLogger = statsLogger.scope(&quot;zk&quot;);</span>
<span class="fc" id="L292">        createClientStats = scopedStatsLogger.getOpStatsLogger(&quot;create_client&quot;);</span>
<span class="fc" id="L293">        createStats = scopedStatsLogger.getOpStatsLogger(&quot;create&quot;);</span>
<span class="fc" id="L294">        getStats = scopedStatsLogger.getOpStatsLogger(&quot;get_data&quot;);</span>
<span class="fc" id="L295">        setStats = scopedStatsLogger.getOpStatsLogger(&quot;set_data&quot;);</span>
<span class="fc" id="L296">        deleteStats = scopedStatsLogger.getOpStatsLogger(&quot;delete&quot;);</span>
<span class="fc" id="L297">        getChildrenStats = scopedStatsLogger.getOpStatsLogger(&quot;get_children&quot;);</span>
<span class="fc" id="L298">        existsStats = scopedStatsLogger.getOpStatsLogger(&quot;exists&quot;);</span>
<span class="fc" id="L299">        multiStats = scopedStatsLogger.getOpStatsLogger(&quot;multi&quot;);</span>
<span class="fc" id="L300">        getACLStats = scopedStatsLogger.getOpStatsLogger(&quot;get_acl&quot;);</span>
<span class="fc" id="L301">        setACLStats = scopedStatsLogger.getOpStatsLogger(&quot;set_acl&quot;);</span>
<span class="fc" id="L302">        syncStats = scopedStatsLogger.getOpStatsLogger(&quot;sync&quot;);</span>
<span class="fc" id="L303">    }</span>

    @Override
    public void close() throws InterruptedException {
<span class="fc" id="L307">        closed.set(true);</span>
<span class="fc" id="L308">        connectExecutor.shutdown();</span>
<span class="fc" id="L309">        retryExecutor.shutdown();</span>
<span class="fc" id="L310">        closeZkHandle();</span>
<span class="fc" id="L311">    }</span>

    private void closeZkHandle() throws InterruptedException {
<span class="fc" id="L314">        ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        if (null == zkHandle) {</span>
<span class="fc" id="L316">            super.close();</span>
        } else {
<span class="nc" id="L318">            zkHandle.close();</span>
        }
<span class="fc" id="L320">    }</span>

    protected void waitForConnection() throws KeeperException, InterruptedException {
<span class="fc" id="L323">        watcherManager.waitForConnection();</span>
<span class="fc" id="L324">    }</span>

    protected ZooKeeper createZooKeeper() throws IOException {
<span class="nc" id="L327">        return new ZooKeeper(connectString, sessionTimeoutMs, watcherManager);</span>
    }

    @Override
    public void process(WatchedEvent event) {
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (event.getType() == EventType.None</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            &amp;&amp; event.getState() == KeeperState.Expired) {</span>
<span class="nc" id="L334">            onExpired();</span>
        }
<span class="fc" id="L336">    }</span>

    private void onExpired() {
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (closed.get()) {</span>
            // we don't schedule any tries if the client is closed.
<span class="nc" id="L341">            return;</span>
        }

<span class="nc" id="L344">        logger.info(&quot;ZooKeeper session {} is expired from {}.&quot;,</span>
<span class="nc" id="L345">                Long.toHexString(getSessionId()), connectString);</span>
        try {
<span class="nc" id="L347">            connectExecutor.submit(clientCreator);</span>
<span class="nc" id="L348">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L350">                logger.error(&quot;ZooKeeper reconnect task is rejected : &quot;, ree);</span>
            }
<span class="nc" id="L352">        } catch (Exception t) {</span>
<span class="nc" id="L353">            logger.error(&quot;Failed to submit zookeeper reconnect task due to runtime exception : &quot;, t);</span>
<span class="nc" id="L354">        }</span>
<span class="nc" id="L355">    }</span>

    /**
     * A runnable that retries zookeeper operations.
     */
    abstract static class ZkRetryRunnable implements Runnable {

        final ZooWorker worker;
        final RateLimiter rateLimiter;
        final Runnable that;

        ZkRetryRunnable(RetryPolicy retryPolicy,
                        RateLimiter rateLimiter,
<span class="fc" id="L368">                        OpStatsLogger statsLogger) {</span>
<span class="fc" id="L369">            this.worker = new ZooWorker(retryPolicy, statsLogger);</span>
<span class="fc" id="L370">            this.rateLimiter = rateLimiter;</span>
<span class="fc" id="L371">            that = this;</span>
<span class="fc" id="L372">        }</span>

        @Override
        public void run() {
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">            if (null != rateLimiter) {</span>
<span class="nc" id="L377">                rateLimiter.acquire();</span>
            }
<span class="fc" id="L379">            zkRun();</span>
<span class="fc" id="L380">        }</span>

        abstract void zkRun();
    }

    // inherits from ZooKeeper client for all operations

    @Override
    public long getSessionId() {
<span class="fc" id="L389">        ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">        if (null == zkHandle) {</span>
<span class="fc" id="L391">            return super.getSessionId();</span>
        }
<span class="nc" id="L393">        return zkHandle.getSessionId();</span>
    }

    @Override
    public byte[] getSessionPasswd() {
<span class="nc" id="L398">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L400">            return super.getSessionPasswd();</span>
        }
<span class="nc" id="L402">        return zkHandle.getSessionPasswd();</span>
    }

    @Override
    public int getSessionTimeout() {
<span class="nc" id="L407">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L409">            return super.getSessionTimeout();</span>
        }
<span class="nc" id="L411">        return zkHandle.getSessionTimeout();</span>
    }

    @Override
    public void addAuthInfo(String scheme, byte[] auth) {
<span class="nc" id="L416">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L418">            super.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L419">            return;</span>
        }
<span class="nc" id="L421">        zkHandle.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L422">    }</span>

    private void backOffAndRetry(Runnable r, long nextRetryWaitTimeMs) {
        try {
<span class="nc" id="L426">            retryExecutor.schedule(r, nextRetryWaitTimeMs, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L427">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L429">                logger.error(&quot;ZooKeeper Operation {} is rejected : &quot;, r, ree);</span>
            }
<span class="nc" id="L431">        }</span>
<span class="nc" id="L432">    }</span>

    private boolean allowRetry(ZooWorker worker, int rc) {
<span class="pc bpc" id="L435" title="3 of 4 branches missed.">        return worker.allowRetry(rc) &amp;&amp; !closed.get();</span>
    }

    @Override
    public synchronized void register(Watcher watcher) {
<span class="nc" id="L440">        watcherManager.addChildWatcher(watcher);</span>
<span class="nc" id="L441">    }</span>

    @Override
    public List&lt;OpResult&gt; multi(final Iterable&lt;Op&gt; ops) throws InterruptedException, KeeperException {
<span class="fc" id="L445">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;OpResult&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L449">                return &quot;multi&quot;;</span>
            }

            @Override
            public List&lt;OpResult&gt; call() throws KeeperException, InterruptedException {
<span class="fc" id="L454">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L456">                    return ZooKeeperClient.super.multi(ops);</span>
                }
<span class="nc" id="L458">                return zkHandle.multi(ops);</span>
            }

        }, operationRetryPolicy, rateLimiter, multiStats);
    }

    @Override
    public void multi(final Iterable&lt;Op&gt; ops,
                      final MultiCallback cb,
                      final Object context) {
<span class="nc" id="L468">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L470">            final MultiCallback multiCb = new MultiCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;OpResult&gt; results) {
<span class="nc" id="L474">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L476">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L478">                        cb.processResult(rc, path, context, results);</span>
                    }
<span class="nc" id="L480">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L486">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L488">                    ZooKeeperClient.super.multi(ops, multiCb, worker);</span>
                } else {
<span class="nc" id="L490">                    zkHandle.multi(ops, multiCb, worker);</span>
                }
<span class="nc" id="L492">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L496">                return &quot;multi&quot;;</span>
            }
        };
        // execute it immediately
<span class="nc" id="L500">        proc.run();</span>
<span class="nc" id="L501">    }</span>

    @Override
    @Deprecated
    public Transaction transaction() {
        // since there is no reference about which client that the transaction could use
        // so just use ZooKeeper instance directly.
        // you'd better to use {@link #multi}.
<span class="fc" id="L509">        ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">        if (null == zkHandle) {</span>
<span class="fc" id="L511">            return super.transaction();</span>
        }
<span class="nc" id="L513">        return zkHandle.transaction();</span>
    }

    @Override
    public List&lt;ACL&gt; getACL(final String path, final Stat stat) throws KeeperException, InterruptedException {
<span class="nc" id="L518">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;ACL&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L522">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            public List&lt;ACL&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L527">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L529">                    return ZooKeeperClient.super.getACL(path, stat);</span>
                }
<span class="nc" id="L531">                return zkHandle.getACL(path, stat);</span>
            }

        }, operationRetryPolicy, rateLimiter, getACLStats);
    }

    @Override
    public void getACL(final String path, final Stat stat, final ACLCallback cb, final Object context) {
<span class="nc" id="L539">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getACLStats) {</span>

<span class="nc" id="L541">            final ACLCallback aclCb = new ACLCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;ACL&gt; acl, Stat stat) {
<span class="nc" id="L545">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L547">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L549">                        cb.processResult(rc, path, context, acl, stat);</span>
                    }
<span class="nc" id="L551">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L557">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L562">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L564">                    ZooKeeperClient.super.getACL(path, stat, aclCb, worker);</span>
                } else {
<span class="nc" id="L566">                    zkHandle.getACL(path, stat, aclCb, worker);</span>
                }
<span class="nc" id="L568">            }</span>
        };
        // execute it immediately
<span class="nc" id="L571">        proc.run();</span>
<span class="nc" id="L572">    }</span>

    @Override
    public Stat setACL(final String path, final List&lt;ACL&gt; acl, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L577">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L581">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L586">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L588">                    return ZooKeeperClient.super.setACL(path, acl, version);</span>
                }
<span class="nc" id="L590">                return zkHandle.setACL(path, acl, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setACLStats);
    }

    @Override
    public void setACL(final String path, final List&lt;ACL&gt; acl, final int version,
            final StatCallback cb, final Object context) {
<span class="nc" id="L599">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setACLStats) {</span>

<span class="nc" id="L601">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L605">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L607">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L609">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L611">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L617">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L622">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L624">                    ZooKeeperClient.super.setACL(path, acl, version, stCb, worker);</span>
                } else {
<span class="nc" id="L626">                    zkHandle.setACL(path, acl, version, stCb, worker);</span>
                }
<span class="nc" id="L628">            }</span>
        };
        // execute it immediately
<span class="nc" id="L631">        proc.run();</span>
<span class="nc" id="L632">    }</span>

    @Override
    public void sync(final String path, final VoidCallback cb, final Object context) {
<span class="fc" id="L636">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, syncStats) {</span>

<span class="fc" id="L638">            final VoidCallback vCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="fc" id="L642">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L644">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L646">                        cb.processResult(rc, path, context);</span>
                    }
<span class="fc" id="L648">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L654">                return String.format(&quot;sync (%s)&quot;, path);</span>
            }

            @Override
            void zkRun() {
<span class="fc" id="L659">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L661">                    ZooKeeperClient.super.sync(path, vCb, worker);</span>
                } else {
<span class="nc" id="L663">                    zkHandle.sync(path, vCb, worker);</span>
                }
<span class="fc" id="L665">            }</span>
        };
        // execute it immediately
<span class="fc" id="L668">        proc.run();</span>
<span class="fc" id="L669">    }</span>

    @Override
    public States getState() {
<span class="nc" id="L673">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L675">            return ZooKeeperClient.super.getState();</span>
        } else {
<span class="nc" id="L677">            return zkHandle.getState();</span>
        }
    }

    @Override
    public String toString() {
<span class="nc" id="L683">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L685">            return ZooKeeperClient.super.toString();</span>
        } else {
<span class="nc" id="L687">            return zkHandle.toString();</span>
        }
    }

    @Override
    public String create(final String path, final byte[] data,
            final List&lt;ACL&gt; acl, final CreateMode createMode)
                    throws KeeperException, InterruptedException {
<span class="fc" id="L695">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;String&gt;() {</span>

            @Override
            public String call() throws KeeperException, InterruptedException {
<span class="fc" id="L699">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L701">                    return ZooKeeperClient.super.create(path, data, acl, createMode);</span>
                }
<span class="nc" id="L703">                return zkHandle.create(path, data, acl, createMode);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L708">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }

        }, operationRetryPolicy, rateLimiter, createStats);
    }

    @Override
    public void create(final String path, final byte[] data, final List&lt;ACL&gt; acl,
            final CreateMode createMode, final StringCallback cb, final Object context) {
<span class="fc" id="L717">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="fc" id="L719">            final StringCallback createCb = new StringCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, String name) {
<span class="fc" id="L723">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L725">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L727">                        cb.processResult(rc, path, context, name);</span>
                    }
<span class="fc" id="L729">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L735">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L736" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L737">                    ZooKeeperClient.super.create(path, data, acl, createMode, createCb, worker);</span>
                } else {
<span class="nc" id="L739">                    zkHandle.create(path, data, acl, createMode, createCb, worker);</span>
                }
<span class="fc" id="L741">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L745">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L749">        proc.run();</span>
<span class="fc" id="L750">    }</span>

    @Override
    public String create(final String path,
                         final byte[] data,
                         final List&lt;ACL&gt; acl,
                         final CreateMode createMode,
                         final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L759">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;String&gt;() {</span>

            @Override
            public String call() throws KeeperException, InterruptedException {
<span class="nc" id="L763">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L765">                    return ZooKeeperClient.super.create(path, data, acl, createMode);</span>
                }
<span class="nc" id="L767">                return zkHandle.create(path, data, acl, createMode);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L772">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }

        }, operationRetryPolicy, rateLimiter, createStats);
    }

    @Override
    public void create(final String path,
                       final byte[] data,
                       final List&lt;ACL&gt; acl,
                       final CreateMode createMode,
                       final Create2Callback cb,
                       final Object context) {
<span class="nc" id="L785">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L787">            final Create2Callback createCb = new Create2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, String name, Stat stat) {
<span class="nc" id="L791">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L793">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L795">                        cb.processResult(rc, path, context, name, stat);</span>
                    }
<span class="nc" id="L797">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L803">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L805">                    ZooKeeperClient.super.create(path, data, acl, createMode, createCb, worker);</span>
                } else {
<span class="nc" id="L807">                    zkHandle.create(path, data, acl, createMode, createCb, worker);</span>
                }
<span class="nc" id="L809">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L813">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L817">        proc.run();</span>
<span class="nc" id="L818">    }</span>

    @Override
    public void delete(final String path, final int version) throws KeeperException, InterruptedException {
<span class="nc" id="L822">        ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Void&gt;() {</span>

            @Override
            public Void call() throws KeeperException, InterruptedException {
<span class="nc" id="L826">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L828">                    ZooKeeperClient.super.delete(path, version);</span>
                } else {
<span class="nc" id="L830">                    zkHandle.delete(path, version);</span>
                }
<span class="nc" id="L832">                return null;</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L837">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, deleteStats);
<span class="nc" id="L841">    }</span>

    @Override
    public void delete(final String path, final int version, final VoidCallback cb, final Object context) {
<span class="fc" id="L845">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, deleteStats) {</span>

<span class="fc" id="L847">            final VoidCallback deleteCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="fc" id="L851">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L853">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L855">                        cb.processResult(rc, path, context);</span>
                    }
<span class="fc" id="L857">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L863">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L864" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L865">                    ZooKeeperClient.super.delete(path, version, deleteCb, worker);</span>
                } else {
<span class="nc" id="L867">                    zkHandle.delete(path, version, deleteCb, worker);</span>
                }
<span class="fc" id="L869">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L873">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L877">        proc.run();</span>
<span class="fc" id="L878">    }</span>

    @Override
    public Stat exists(final String path, final Watcher watcher) throws KeeperException, InterruptedException {
<span class="fc" id="L882">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="fc" id="L886">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L887" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L888">                    return ZooKeeperClient.super.exists(path, watcher);</span>
                }
<span class="nc" id="L890">                return zkHandle.exists(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L895">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public Stat exists(final String path, final boolean watch) throws KeeperException, InterruptedException {
<span class="fc" id="L903">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="fc" id="L907">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L908" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L909">                    return ZooKeeperClient.super.exists(path, watch);</span>
                }
<span class="nc" id="L911">                return zkHandle.exists(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L916">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public void exists(final String path, final Watcher watcher, final StatCallback cb, final Object context) {
<span class="nc" id="L924">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L926">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L930">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L932">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L934">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L936">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L942">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L944">                    ZooKeeperClient.super.exists(path, watcher, stCb, worker);</span>
                } else {
<span class="nc" id="L946">                    zkHandle.exists(path, watcher, stCb, worker);</span>
                }
<span class="nc" id="L948">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L952">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L956">        proc.run();</span>
<span class="nc" id="L957">    }</span>

    @Override
    public void exists(final String path, final boolean watch, final StatCallback cb, final Object context) {
<span class="nc" id="L961">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L963">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L967">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L969">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L971">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L973">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L979">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L981">                    ZooKeeperClient.super.exists(path, watch, stCb, worker);</span>
                } else {
<span class="nc" id="L983">                    zkHandle.exists(path, watch, stCb, worker);</span>
                }
<span class="nc" id="L985">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L989">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L993">        proc.run();</span>
<span class="nc" id="L994">    }</span>

    @Override
    public byte[] getData(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="fc" id="L999">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="fc" id="L1003">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1004" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1005">                    return ZooKeeperClient.super.getData(path, watcher, stat);</span>
                }
<span class="nc" id="L1007">                return zkHandle.getData(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1012">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public byte[] getData(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="fc" id="L1021">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="fc" id="L1025">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1026" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1027">                    return ZooKeeperClient.super.getData(path, watch, stat);</span>
                }
<span class="nc" id="L1029">                return zkHandle.getData(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1034">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public void getData(final String path, final Watcher watcher, final DataCallback cb, final Object context) {
<span class="nc" id="L1042">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L1044">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L1048">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1050">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1052">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L1054">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1060">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1062">                    ZooKeeperClient.super.getData(path, watcher, dataCb, worker);</span>
                } else {
<span class="nc" id="L1064">                    zkHandle.getData(path, watcher, dataCb, worker);</span>
                }
<span class="nc" id="L1066">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1070">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1074">        proc.run();</span>
<span class="nc" id="L1075">    }</span>

    @Override
    public void getData(final String path, final boolean watch, final DataCallback cb, final Object context) {
<span class="nc" id="L1079">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L1081">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L1085">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1087">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1089">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L1091">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1097">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1099">                    ZooKeeperClient.super.getData(path, watch, dataCb, worker);</span>
                } else {
<span class="nc" id="L1101">                    zkHandle.getData(path, watch, dataCb, worker);</span>
                }
<span class="nc" id="L1103">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1107">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1111">        proc.run();</span>
<span class="nc" id="L1112">    }</span>

    @Override
    public Stat setData(final String path, final byte[] data, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1117">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L1121">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1123">                    return ZooKeeperClient.super.setData(path, data, version);</span>
                }
<span class="nc" id="L1125">                return zkHandle.setData(path, data, version);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1130">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setStats);
    }

    @Override
    public void setData(final String path, final byte[] data, final int version,
            final StatCallback cb, final Object context) {
<span class="fc" id="L1139">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setStats) {</span>

<span class="fc" id="L1141">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="fc" id="L1145">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L1146" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1147">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L1149">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="fc" id="L1151">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L1157">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1158" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1159">                    ZooKeeperClient.super.setData(path, data, version, stCb, worker);</span>
                } else {
<span class="nc" id="L1161">                    zkHandle.setData(path, data, version, stCb, worker);</span>
                }
<span class="fc" id="L1163">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1167">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L1171">        proc.run();</span>
<span class="fc" id="L1172">    }</span>

    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1177">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1181">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1183">                    return ZooKeeperClient.super.getChildren(path, watcher, stat);</span>
                }
<span class="nc" id="L1185">                return zkHandle.getChildren(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1190">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1199">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1203">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1205">                    return ZooKeeperClient.super.getChildren(path, watch, stat);</span>
                }
<span class="nc" id="L1207">                return zkHandle.getChildren(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1212">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final Children2Callback cb, final Object context) {
<span class="fc" id="L1221">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="fc" id="L1223">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="fc" id="L1228">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L1229" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1230">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L1232">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="fc" id="L1234">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L1240">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1241" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1242">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1244">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="fc" id="L1246">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1250">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L1254">        proc.run();</span>
<span class="fc" id="L1255">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch, final Children2Callback cb,
            final Object context) {
<span class="nc" id="L1260">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1262">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="nc" id="L1267">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1269">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1271">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="nc" id="L1273">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1279">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1281">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1283">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="nc" id="L1285">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1289">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1293">        proc.run();</span>
<span class="nc" id="L1294">    }</span>


    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1300">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1304">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1306">                    return ZooKeeperClient.super.getChildren(path, watcher);</span>
                }
<span class="nc" id="L1308">                return zkHandle.getChildren(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1313">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1322">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1326">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1328">                    return ZooKeeperClient.super.getChildren(path, watch);</span>
                }
<span class="nc" id="L1330">                return zkHandle.getChildren(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1335">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final ChildrenCallback cb, final Object context) {
<span class="fc" id="L1344">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="fc" id="L1346">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="fc" id="L1351">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L1352" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1353">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L1355">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="fc" id="L1357">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L1363">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1364" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1365">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1367">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="fc" id="L1369">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1373">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L1377">        proc.run();</span>
<span class="fc" id="L1378">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch,
            final ChildrenCallback cb, final Object context) {
<span class="fc" id="L1383">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="fc" id="L1385">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="fc" id="L1390">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="pc bpc" id="L1391" title="1 of 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1392">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="fc" id="L1394">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="fc" id="L1396">                }</span>

            };

            @Override
            void zkRun() {
<span class="fc" id="L1402">                ZooKeeper zkHandle = zk.get();</span>
<span class="pc bpc" id="L1403" title="1 of 2 branches missed.">                if (null == zkHandle) {</span>
<span class="fc" id="L1404">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1406">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="fc" id="L1408">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1412">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="fc" id="L1416">        proc.run();</span>
<span class="fc" id="L1417">    }</span>

    @Override
    public void removeWatches(String path, Watcher watcher, WatcherType watcherType, boolean local)
            throws InterruptedException, KeeperException {
<span class="nc" id="L1422">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L1424">            ZooKeeperClient.super.removeWatches(path, watcher, watcherType, local);</span>
        } else {
<span class="nc" id="L1426">            zkHandle.removeWatches(path, watcher, watcherType, local);</span>
        }
<span class="nc" id="L1428">    }</span>

    @Override
    public void removeWatches(String path,
                              Watcher watcher,
                              WatcherType watcherType,
                              boolean local,
                              VoidCallback cb,
                              Object ctx) {
<span class="nc" id="L1437">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L1439">            ZooKeeperClient.super.removeWatches(path, watcher, watcherType, local, cb, ctx);</span>
        } else {
<span class="nc" id="L1441">            zkHandle.removeWatches(path, watcher, watcherType, local, cb, ctx);</span>
        }
<span class="nc" id="L1443">    }</span>

    @Override
    public void removeAllWatches(String path, WatcherType watcherType, boolean local)
            throws InterruptedException, KeeperException {
<span class="nc" id="L1448">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1449" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L1450">            ZooKeeperClient.super.removeAllWatches(path, watcherType, local);</span>
        } else {
<span class="nc" id="L1452">            zkHandle.removeAllWatches(path, watcherType, local);</span>
        }
<span class="nc" id="L1454">    }</span>

    @Override
    public void removeAllWatches(String path, WatcherType watcherType, boolean local, VoidCallback cb, Object ctx) {
<span class="nc" id="L1458">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L1460">            ZooKeeperClient.super.removeAllWatches(path, watcherType, local, cb, ctx);</span>
        } else {
<span class="nc" id="L1462">            zkHandle.removeAllWatches(path, watcherType, local, cb, ctx);</span>
        }
<span class="nc" id="L1464">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>