<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InMemoryMetastoreTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.metastore</a> &gt; <span class="el_source">InMemoryMetastoreTable.java</span></div><h1>InMemoryMetastoreTable.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.bookkeeper.metastore;

import java.util.NavigableMap;
import java.util.Set;
import java.util.TreeMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;

import org.apache.bookkeeper.metastore.MSException.Code;
import org.apache.bookkeeper.versioning.Version;
import org.apache.bookkeeper.versioning.Versioned;

import com.google.common.util.concurrent.ThreadFactoryBuilder;

public class InMemoryMetastoreTable implements MetastoreScannableTable {

    public static class MetadataVersion implements Version {
        int version;

<span class="nc" id="L37">        public MetadataVersion(int v) {</span>
<span class="nc" id="L38">            this.version = v;</span>
<span class="nc" id="L39">        }</span>

<span class="nc" id="L41">        public MetadataVersion(MetadataVersion v) {</span>
<span class="nc" id="L42">            this.version = v.version;</span>
<span class="nc" id="L43">        }</span>

        public synchronized MetadataVersion incrementVersion() {
<span class="nc" id="L46">            ++version;</span>
<span class="nc" id="L47">            return this;</span>
        }

        @Override
        public Occurred compare(Version v) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (null == v) {</span>
<span class="nc" id="L53">                throw new NullPointerException(&quot;Version is not allowed to be null.&quot;);</span>
            }
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (v == Version.NEW) {</span>
<span class="nc" id="L56">                return Occurred.AFTER;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            } else if (v == Version.ANY) {</span>
<span class="nc" id="L58">                return Occurred.CONCURRENTLY;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">            } else if (!(v instanceof MetadataVersion)) {</span>
<span class="nc" id="L60">                throw new IllegalArgumentException(&quot;Invalid version type&quot;);</span>
            }
<span class="nc" id="L62">            MetadataVersion mv = (MetadataVersion)v;</span>
<span class="nc" id="L63">            int res = version - mv.version;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (res == 0) {</span>
<span class="nc" id="L65">                return Occurred.CONCURRENTLY;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            } else if (res &lt; 0) {</span>
<span class="nc" id="L67">                return Occurred.BEFORE;</span>
            } else {
<span class="nc" id="L69">                return Occurred.AFTER;</span>
            }
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L75" title="All 4 branches missed.">            if (null == obj ||</span>
                !(obj instanceof MetadataVersion)) {
<span class="nc" id="L77">                return false;</span>
            }
<span class="nc" id="L79">            MetadataVersion v = (MetadataVersion)obj;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            return 0 == (version - v.version);</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L85">            return &quot;version=&quot; + version;</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L90">            return version;</span>
        }
    }

    private String name;
<span class="nc" id="L95">    private TreeMap&lt;String, Versioned&lt;Value&gt;&gt; map = null;</span>
<span class="nc" id="L96">    private TreeMap&lt;String, MetastoreWatcher&gt; watcherMap = null;</span>
    private ScheduledExecutorService scheduler;

<span class="nc" id="L99">    public InMemoryMetastoreTable(InMemoryMetaStore metastore, String name) {</span>
<span class="nc" id="L100">        this.map = new TreeMap&lt;String, Versioned&lt;Value&gt;&gt;();</span>
<span class="nc" id="L101">        this.watcherMap = new TreeMap&lt;String,MetastoreWatcher&gt;();</span>
<span class="nc" id="L102">        this.name = name;</span>
<span class="nc" id="L103">        String thName = &quot;InMemoryMetastore-Table(&quot; + name + &quot;)-Scheduler-%d&quot;;</span>
<span class="nc" id="L104">        ThreadFactoryBuilder tfb = new ThreadFactoryBuilder()</span>
<span class="nc" id="L105">                .setNameFormat(thName);</span>
<span class="nc" id="L106">        this.scheduler = Executors</span>
<span class="nc" id="L107">                .newSingleThreadScheduledExecutor(tfb.build());</span>
<span class="nc" id="L108">    }</span>

    @Override
    public String getName () {
<span class="nc" id="L112">        return this.name;</span>
    }

    static Versioned&lt;Value&gt; cloneValue(Value value, Version version, Set&lt;String&gt; fields) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (null != value) {</span>
<span class="nc" id="L117">            Value newValue = new Value();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (ALL_FIELDS == fields) {</span>
<span class="nc" id="L119">                fields = value.getFields();</span>
            }
<span class="nc bnc" id="L121" title="All 2 branches missed.">            for (String f : fields) {</span>
<span class="nc" id="L122">                newValue.setField(f, value.getField(f));</span>
<span class="nc" id="L123">            }</span>
<span class="nc" id="L124">            value = newValue;</span>
        }

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (null == version) {</span>
<span class="nc" id="L128">            throw new NullPointerException(&quot;Version isn't allowed to be null.&quot;);</span>
        }
<span class="nc bnc" id="L130" title="All 4 branches missed.">        if (Version.ANY != version &amp;&amp; Version.NEW != version) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (version instanceof MetadataVersion) {</span>
<span class="nc" id="L132">                version = new MetadataVersion(((MetadataVersion)version).version);</span>
            } else {
<span class="nc" id="L134">                throw new IllegalStateException(&quot;Wrong version type.&quot;);</span>
            }
        }
<span class="nc" id="L137">        return new Versioned&lt;Value&gt;(value, version);</span>
    }

    @Override
    public void get(final String key, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb, final Object ctx) {
<span class="nc" id="L142">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L145">                scheduleGet(key, ALL_FIELDS, cb, ctx);</span>
<span class="nc" id="L146">            }</span>
        });
<span class="nc" id="L148">    }</span>
    
    @Override
    public void get(final String key, final MetastoreWatcher watcher, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb, final Object ctx) {
<span class="nc" id="L152">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L155">                scheduleGet(key, ALL_FIELDS, cb, ctx);</span>
<span class="nc" id="L156">                synchronized(watcherMap) {</span>
<span class="nc" id="L157">                    watcherMap.put( key, watcher );</span>
<span class="nc" id="L158">                }</span>
<span class="nc" id="L159">            }</span>
        });
<span class="nc" id="L161">    }</span>

    @Override
    public void get(final String key, final Set&lt;String&gt; fields, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb,
            final Object ctx) {
<span class="nc" id="L166">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L169">                scheduleGet(key, fields, cb, ctx);</span>
<span class="nc" id="L170">            }</span>
        });
<span class="nc" id="L172">    }</span>

    public synchronized void scheduleGet(String key, Set&lt;String&gt; fields, MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb,
            Object ctx) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (null == key) {</span>
<span class="nc" id="L177">            cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L178">            return;</span>
        }
<span class="nc" id="L180">        Versioned&lt;Value&gt; vv = get(key);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        int rc = null == vv ? Code.NoKey.getCode() : Code.OK.getCode();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (vv != null) {</span>
<span class="nc" id="L183">            vv = cloneValue(vv.getValue(), vv.getVersion(), fields);</span>
        }
<span class="nc" id="L185">        cb.complete(rc, vv, ctx);</span>
<span class="nc" id="L186">    }</span>

    @Override
    public void put(final String key, final Value value, final Version version, final MetastoreCallback&lt;Version&gt; cb,
            final Object ctx) {
<span class="nc" id="L191">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L194" title="All 6 branches missed.">                if (null == key || null == value || null == version) {</span>
<span class="nc" id="L195">                    cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L196">                    return;</span>
                }
<span class="nc" id="L198">                Result&lt;Version&gt; result = put(key, value, version);</span>
<span class="nc" id="L199">                cb.complete(result.code.getCode(), result.value, ctx);</span>
                
                /*
                 * If there is a watcher set for this key, we need
                 * to trigger it.
                 */
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if(result.code == MSException.Code.OK){</span>
<span class="nc" id="L206">                    triggerWatch(key, MSWatchedEvent.EventType.CHANGED);</span>
                }
<span class="nc" id="L208">            }</span>
        });
<span class="nc" id="L210">    }</span>
    
    @Override
    public void remove(final String key, final Version version, final MetastoreCallback&lt;Void&gt; cb, final Object ctx) {
<span class="nc" id="L214">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L217" title="All 4 branches missed.">                if (null == key || null == version) {</span>
<span class="nc" id="L218">                    cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L219">                    return;</span>
                }
<span class="nc" id="L221">                Code code = remove(key, version);</span>
<span class="nc" id="L222">                cb.complete(code.getCode(), null, ctx);</span>
                
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if(code == MSException.Code.OK){</span>
<span class="nc" id="L225">                    triggerWatch(key, MSWatchedEvent.EventType.REMOVED);</span>
                }
<span class="nc" id="L227">            }</span>
        });
<span class="nc" id="L229">    }</span>

    @Override
    public void openCursor(MetastoreCallback&lt;MetastoreCursor&gt; cb, Object ctx) {
<span class="nc" id="L233">        openCursor(EMPTY_START_KEY, true, EMPTY_END_KEY, true, Order.ASC,</span>
                   ALL_FIELDS, cb, ctx);
<span class="nc" id="L235">    }</span>

    @Override
    public void openCursor(Set&lt;String&gt; fields,
                           MetastoreCallback&lt;MetastoreCursor&gt; cb, Object ctx) {
<span class="nc" id="L240">        openCursor(EMPTY_START_KEY, true, EMPTY_END_KEY, true, Order.ASC,</span>
                   fields, cb, ctx);
<span class="nc" id="L242">    }</span>

    @Override
    public void openCursor(String firstKey, boolean firstInclusive,
                           String lastKey, boolean lastInclusive,
                           Order order, MetastoreCallback&lt;MetastoreCursor&gt; cb,
                           Object ctx) {
<span class="nc" id="L249">        openCursor(firstKey, firstInclusive, lastKey, lastInclusive,</span>
                   order, ALL_FIELDS, cb, ctx);
<span class="nc" id="L251">    }</span>

    @Override
    public void openCursor(final String firstKey, final boolean firstInclusive,
                           final String lastKey, final boolean lastInclusive,
                           final Order order, final Set&lt;String&gt; fields,
                           final MetastoreCallback&lt;MetastoreCursor&gt; cb, final Object ctx) {
<span class="nc" id="L258">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L261">                Result&lt;MetastoreCursor&gt; result = openCursor(firstKey, firstInclusive, lastKey, lastInclusive,</span>
                        order, fields);
<span class="nc" id="L263">                cb.complete(result.code.getCode(), result.value, ctx);</span>
<span class="nc" id="L264">            }</span>
        });
<span class="nc" id="L266">    }</span>

    private void triggerWatch(String key, MSWatchedEvent.EventType type) {
<span class="nc" id="L269">        synchronized(watcherMap){</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if(watcherMap.containsKey( key )) {</span>
<span class="nc" id="L271">                MSWatchedEvent event = new MSWatchedEvent(key, type);</span>
<span class="nc" id="L272">                watcherMap.get( key ).process( event );</span>
<span class="nc" id="L273">                watcherMap.remove( key );</span>
            }
<span class="nc" id="L275">        }</span>
<span class="nc" id="L276">    }</span>
    
    private synchronized Versioned&lt;Value&gt; get(String key) {
<span class="nc" id="L279">        return map.get(key);</span>
    }

    private synchronized Code remove(String key, Version version) {
<span class="nc" id="L283">        Versioned&lt;Value&gt; vv = map.get(key);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (null == vv) {</span>
<span class="nc" id="L285">            return Code.NoKey;</span>
        }
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (Version.Occurred.CONCURRENTLY != vv.getVersion().compare(version)) {</span>
<span class="nc" id="L288">            return Code.BadVersion;</span>
        }
<span class="nc" id="L290">        map.remove(key);</span>
<span class="nc" id="L291">        return Code.OK;</span>
    }

    static class Result&lt;T&gt; {
        Code code;
        T value;

<span class="nc" id="L298">        public Result(Code code, T value) {</span>
<span class="nc" id="L299">            this.code = code;</span>
<span class="nc" id="L300">            this.value = value;</span>
<span class="nc" id="L301">        }</span>
    }

    private synchronized Result&lt;Version&gt; put(String key, Value value, Version version) {
<span class="nc" id="L305">        Versioned&lt;Value&gt; vv = map.get(key);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (vv == null) {</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (Version.NEW != version) {</span>
<span class="nc" id="L308">                return new Result&lt;Version&gt;(Code.NoKey, null);</span>
            }
<span class="nc" id="L310">            vv = cloneValue(value, version, ALL_FIELDS);</span>
<span class="nc" id="L311">            vv.setVersion(new MetadataVersion(0));</span>
<span class="nc" id="L312">            map.put(key, vv);</span>
<span class="nc" id="L313">            return new Result&lt;Version&gt;(Code.OK, new MetadataVersion(0));</span>
        }
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (Version.NEW == version) {</span>
<span class="nc" id="L316">            return new Result&lt;Version&gt;(Code.KeyExists, null);</span>
        }
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (Version.Occurred.CONCURRENTLY != vv.getVersion().compare(version)) {</span>
<span class="nc" id="L319">            return new Result&lt;Version&gt;(Code.BadVersion, null);</span>
        }
<span class="nc" id="L321">        vv.setVersion(((MetadataVersion)vv.getVersion()).incrementVersion());</span>
<span class="nc" id="L322">        vv.setValue(vv.getValue().merge(value));</span>
<span class="nc" id="L323">        return new Result&lt;Version&gt;(Code.OK, new MetadataVersion((MetadataVersion)vv.getVersion()));</span>
    }

    private synchronized Result&lt;MetastoreCursor&gt; openCursor(
            String firstKey, boolean firstInclusive,
            String lastKey, boolean lastInclusive,
            Order order, Set&lt;String&gt; fields) {
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (0 == map.size()) {</span>
<span class="nc" id="L331">            return new Result&lt;MetastoreCursor&gt;(Code.OK, MetastoreCursor.EMPTY_CURSOR);</span>
        }

<span class="nc" id="L334">        boolean isLegalCursor = false;</span>
<span class="nc" id="L335">        NavigableMap&lt;String, Versioned&lt;Value&gt;&gt; myMap = null;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (Order.ASC == order) {</span>
<span class="nc" id="L337">            myMap = map;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (EMPTY_END_KEY == lastKey ||</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                lastKey.compareTo(myMap.lastKey()) &gt; 0) {</span>
<span class="nc" id="L340">                lastKey = myMap.lastKey();</span>
<span class="nc" id="L341">                lastInclusive = true;</span>
            }
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (EMPTY_START_KEY == firstKey ||</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                firstKey.compareTo(myMap.firstKey()) &lt; 0) {</span>
<span class="nc" id="L345">                firstKey = myMap.firstKey();</span>
<span class="nc" id="L346">                firstInclusive = true;</span>
            }
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (firstKey.compareTo(lastKey) &lt;= 0) {</span>
<span class="nc" id="L349">                isLegalCursor = true;</span>
            }
<span class="nc bnc" id="L351" title="All 2 branches missed.">        } else if (Order.DESC == order) {</span>
<span class="nc" id="L352">            myMap = map.descendingMap();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (EMPTY_START_KEY == lastKey ||</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                lastKey.compareTo(myMap.lastKey()) &lt; 0) {</span>
<span class="nc" id="L355">                lastKey = myMap.lastKey();</span>
<span class="nc" id="L356">                lastInclusive = true;</span>
            }
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (EMPTY_END_KEY == firstKey ||</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                firstKey.compareTo(myMap.firstKey()) &gt; 0) {</span>
<span class="nc" id="L360">                firstKey = myMap.firstKey();</span>
<span class="nc" id="L361">                firstInclusive = true;</span>
            }
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (firstKey.compareTo(lastKey) &gt;= 0) {</span>
<span class="nc" id="L364">                isLegalCursor = true;</span>
            }
        }

<span class="nc bnc" id="L368" title="All 4 branches missed.">        if (!isLegalCursor || null == myMap) {</span>
<span class="nc" id="L369">            return new Result&lt;MetastoreCursor&gt;(Code.IllegalOp, null);</span>
        }
<span class="nc" id="L371">        MetastoreCursor cursor = new InMemoryMetastoreCursor(</span>
<span class="nc" id="L372">                myMap.subMap(firstKey, firstInclusive, lastKey, lastInclusive), fields, scheduler);</span>
<span class="nc" id="L373">        return new Result&lt;MetastoreCursor&gt;(Code.OK, cursor);</span>
    }

    @Override
    public void close() {
        // do nothing
<span class="nc" id="L379">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>