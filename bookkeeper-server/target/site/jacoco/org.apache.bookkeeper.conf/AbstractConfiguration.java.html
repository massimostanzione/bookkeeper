<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.conf</a> &gt; <span class="el_source">AbstractConfiguration.java</span></div><h1>AbstractConfiguration.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.bookkeeper.conf;

import static org.apache.bookkeeper.conf.ClientConfiguration.CLIENT_AUTH_PROVIDER_FACTORY_CLASS;

import java.net.URL;
import java.util.Iterator;
import javax.net.ssl.SSLEngine;
import org.apache.bookkeeper.feature.Feature;
import org.apache.bookkeeper.meta.LedgerManagerFactory;
import org.apache.bookkeeper.util.ReflectionUtils;
import org.apache.commons.configuration.CompositeConfiguration;
import org.apache.commons.configuration.ConfigurationException;
import org.apache.commons.configuration.PropertiesConfiguration;
import org.apache.commons.configuration.SystemConfiguration;

/**
 * Abstract configuration.
 */
public abstract class AbstractConfiguration extends CompositeConfiguration {

    public static final String READ_SYSTEM_PROPERTIES_PROPERTY
                            = &quot;org.apache.bookkeeper.conf.readsystemproperties&quot;;
    /**
     * Enable the use of System Properties, which was the default behaviour till 4.4.0
     */
<span class="fc" id="L43">    private static final boolean READ_SYSTEM_PROPERTIES</span>
<span class="fc" id="L44">                                    = Boolean.getBoolean(READ_SYSTEM_PROPERTIES_PROPERTY);</span>

    protected static final ClassLoader defaultLoader;
    static {
<span class="fc" id="L48">        ClassLoader loader = Thread.currentThread().getContextClassLoader();</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        if (null == loader) {</span>
<span class="nc" id="L50">            loader = AbstractConfiguration.class.getClassLoader();</span>
        }
<span class="fc" id="L52">        defaultLoader = loader;</span>
<span class="fc" id="L53">    }</span>

    // Ledger Manager
    protected final static String LEDGER_MANAGER_TYPE = &quot;ledgerManagerType&quot;;
    protected final static String LEDGER_MANAGER_FACTORY_CLASS = &quot;ledgerManagerFactoryClass&quot;;
    protected final static String ZK_LEDGERS_ROOT_PATH = &quot;zkLedgersRootPath&quot;;
    protected final static String ZK_REQUEST_RATE_LIMIT = &quot;zkRequestRateLimit&quot;;
    protected final static String AVAILABLE_NODE = &quot;available&quot;;
    protected final static String REREPLICATION_ENTRY_BATCH_SIZE = &quot;rereplicationEntryBatchSize&quot;;

    // Metastore settings, only being used when LEDGER_MANAGER_FACTORY_CLASS is MSLedgerManagerFactory
    protected final static String METASTORE_IMPL_CLASS = &quot;metastoreImplClass&quot;;
    protected final static String METASTORE_MAX_ENTRIES_PER_SCAN = &quot;metastoreMaxEntriesPerScan&quot;;

    // Common TLS configuration
    // TLS Provider (JDK or OpenSSL)
    protected final static String TLS_PROVIDER = &quot;tlsProvider&quot;;

    // TLS provider factory class name
    protected final static String TLS_PROVIDER_FACTORY_CLASS = &quot;tlsProviderFactoryClass&quot;;

    // Enable authentication of the other connection end point (mutual authentication)
    protected final static String TLS_CLIENT_AUTHENTICATION = &quot;tlsClientAuthentication&quot;;

    /**
     * This list will be passed to {@link SSLEngine#setEnabledCipherSuites(java.lang.String[]) }.
     * Please refer to official JDK JavaDocs
    */
    protected final static String TLS_ENABLED_CIPHER_SUITES = &quot;tlsEnabledCipherSuites&quot;;

    /**
     * This list will be passed to {@link SSLEngine#setEnabledProtocols(java.lang.String[]) }.
     * Please refer to official JDK JavaDocs
    */
    protected final static String TLS_ENABLED_PROTOCOLS = &quot;tlsEnabledProtocols&quot;;

    //Netty configuration
    protected final static String NETTY_MAX_FRAME_SIZE = &quot;nettyMaxFrameSizeBytes&quot;;
    protected final static int DEFAULT_NETTY_MAX_FRAME_SIZE = 5 * 1024 * 1024; // 5MB

    // Zookeeper ACL settings
    protected final static String ZK_ENABLE_SECURITY = &quot;zkEnableSecurity&quot;;

    // Kluge for compatibility testing. Never set this outside tests.
    public final static String LEDGER_MANAGER_FACTORY_DISABLE_CLASS_CHECK = &quot;ledgerManagerFactoryDisableClassCheck&quot;;

    protected AbstractConfiguration() {
<span class="fc" id="L100">        super();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (READ_SYSTEM_PROPERTIES) {</span>
            // add configuration for system properties
<span class="nc" id="L103">            addConfiguration(new SystemConfiguration());</span>
        }
<span class="fc" id="L105">    }</span>

    /**
     * You can load configurations in precedence order. The first one takes
     * precedence over any loaded later.
     *
     * @param confURL
     *          Configuration URL
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void loadConf(URL confURL) throws ConfigurationException {
<span class="nc" id="L116">        PropertiesConfiguration loadedConf = new PropertiesConfiguration(confURL);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (Iterator&lt;String&gt; iter = loadedConf.getKeys(); iter.hasNext(); ) {</span>
<span class="nc" id="L118">            String key = iter.next();</span>
<span class="nc" id="L119">            setProperty(key, loadedConf.getProperty(key));</span>
<span class="nc" id="L120">        }</span>
<span class="nc" id="L121">    }</span>

    /**
     * You can load configuration from other configuration
     *
     * @param baseConf
     *          Other Configuration
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void loadConf(CompositeConfiguration baseConf) {
<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (Iterator&lt;String&gt; iter = baseConf.getKeys(); iter.hasNext(); ) {</span>
<span class="fc" id="L132">            String key = iter.next();</span>
<span class="fc" id="L133">            setProperty(key, baseConf.getProperty(key));</span>
<span class="fc" id="L134">        }</span>
<span class="fc" id="L135">    }</span>

    /**
     * Set Ledger Manager Type.
     *
     * @param lmType
     *          Ledger Manager Type
     * @deprecated replaced by {@link #setLedgerManagerFactoryClass}
     */
    @Deprecated
    public void setLedgerManagerType(String lmType) {
<span class="nc" id="L146">        setProperty(LEDGER_MANAGER_TYPE, lmType); </span>
<span class="nc" id="L147">    }</span>

    /**
     * Get Ledger Manager Type.
     *
     * @return ledger manager type
     * @throws ConfigurationException
     * @deprecated replaced by {@link #getLedgerManagerFactoryClass()}
     */
    @Deprecated
    public String getLedgerManagerType() {
<span class="fc" id="L158">        return getString(LEDGER_MANAGER_TYPE);</span>
    }

    /**
     * Set Ledger Manager Factory Class Name.
     *
     * @param factoryClassName
     *          Ledger Manager Factory Class Name
     */
    public void setLedgerManagerFactoryClassName(String factoryClassName) {
<span class="nc" id="L168">        setProperty(LEDGER_MANAGER_FACTORY_CLASS, factoryClassName);</span>
<span class="nc" id="L169">    }</span>

    /**
     * Set Ledger Manager Factory Class.
     *
     * @param factoryClass
     *          Ledger Manager Factory Class
     */
    public void setLedgerManagerFactoryClass(Class&lt;? extends LedgerManagerFactory&gt; factoryClass) {
<span class="nc" id="L178">        setProperty(LEDGER_MANAGER_FACTORY_CLASS, factoryClass.getName());</span>
<span class="nc" id="L179">    }</span>

    /**
     * Get ledger manager factory class.
     *
     * @return ledger manager factory class
     */
    public Class&lt;? extends LedgerManagerFactory&gt; getLedgerManagerFactoryClass()
        throws ConfigurationException {
<span class="fc" id="L188">        return ReflectionUtils.getClass(this, LEDGER_MANAGER_FACTORY_CLASS,</span>
                                        null, LedgerManagerFactory.class,
                                        defaultLoader);
    }

    /**
     * Set Zk Ledgers Root Path.
     *
     * @param zkLedgersPath zk ledgers root path
     */
    public void setZkLedgersRootPath(String zkLedgersPath) {
<span class="nc" id="L199">        setProperty(ZK_LEDGERS_ROOT_PATH, zkLedgersPath);</span>
<span class="nc" id="L200">    }</span>

    /**
     * Get Zk Ledgers Root Path.
     *
     * @return zk ledgers root path
     */
    public String getZkLedgersRootPath() {
<span class="fc" id="L208">        return getString(ZK_LEDGERS_ROOT_PATH, &quot;/ledgers&quot;);</span>
    }

    /**
     * Get zookeeper access request rate limit.
     *
     * @return zookeeper access request rate limit.
     */
    public double getZkRequestRateLimit() {
<span class="fc" id="L217">        return getDouble(ZK_REQUEST_RATE_LIMIT, 0);</span>
    }

    /**
     * Set zookeeper access request rate limit.
     *
     * @param rateLimit
     *          zookeeper access request rate limit.
     */
    public void setZkRequestRateLimit(double rateLimit) {
<span class="nc" id="L227">        setProperty(ZK_REQUEST_RATE_LIMIT, rateLimit);</span>
<span class="nc" id="L228">    }</span>

    /**
     * Are z-node created with strict ACLs
     *
     * @return usage of secure ZooKeeper ACLs
     */
    public boolean isZkEnableSecurity() {
<span class="fc" id="L236">        return getBoolean(ZK_ENABLE_SECURITY, false);</span>
    }

    /**
     * Set the usage of ACLs of new z-nodes
     *
     * @param zkEnableSecurity
     */
    public void setZkEnableSecurity(boolean zkEnableSecurity) {
<span class="nc" id="L245">        setProperty(ZK_ENABLE_SECURITY, zkEnableSecurity);</span>
<span class="nc" id="L246">    }</span>

    /**
     * Get the node under which available bookies are stored
     *
     * @return Node under which available bookies are stored.
     */
    public String getZkAvailableBookiesPath() {
<span class="fc" id="L254">        return getZkLedgersRootPath() + &quot;/&quot; + AVAILABLE_NODE;</span>
    }

    /**
     * Set the max entries to keep in fragment for re-replication. If fragment
     * has more entries than this count, then the original fragment will be
     * split into multiple small logical fragments by keeping max entries count
     * to rereplicationEntryBatchSize. So, re-replication will happen in batches
     * wise.
     */
    public void setRereplicationEntryBatchSize(long rereplicationEntryBatchSize) {
<span class="nc" id="L265">        setProperty(REREPLICATION_ENTRY_BATCH_SIZE, rereplicationEntryBatchSize);</span>
<span class="nc" id="L266">    }</span>

    /**
     * Get the re-replication entry batch size
     */
    public long getRereplicationEntryBatchSize() {
<span class="nc" id="L272">        return getLong(REREPLICATION_ENTRY_BATCH_SIZE, 10);</span>
    }

    /**
     * Get metastore implementation class.
     *
     * @return metastore implementation class name.
     */
    public String getMetastoreImplClass() {
<span class="nc" id="L281">        return getString(METASTORE_IMPL_CLASS);</span>
    }

    /**
     * Set metastore implementation class.
     *
     * @param metastoreImplClass
     *          Metastore implementation Class name.
     */
    public void setMetastoreImplClass(String metastoreImplClass) {
<span class="fc" id="L291">        setProperty(METASTORE_IMPL_CLASS, metastoreImplClass);</span>
<span class="fc" id="L292">    }</span>

    /**
     * Get max entries per scan in metastore.
     *
     * @return max entries per scan in metastore.
     */
    public int getMetastoreMaxEntriesPerScan() {
<span class="nc" id="L300">        return getInt(METASTORE_MAX_ENTRIES_PER_SCAN, 50);</span>
    }

    /**
     * Set max entries per scan in metastore.
     *
     * @param maxEntries
     *          Max entries per scan in metastore.
     */
    public void setMetastoreMaxEntriesPerScan(int maxEntries) {
<span class="nc" id="L310">        setProperty(METASTORE_MAX_ENTRIES_PER_SCAN, maxEntries);</span>
<span class="nc" id="L311">    }</span>

    public void setFeature(String configProperty, Feature feature) {
<span class="nc" id="L314">        setProperty(configProperty, feature);</span>
<span class="nc" id="L315">    }</span>

    public Feature getFeature(String configProperty, Feature defaultValue) {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (null == getProperty(configProperty)) {</span>
<span class="nc" id="L319">            return defaultValue;</span>
        } else {
<span class="nc" id="L321">            return (Feature)getProperty(configProperty);</span>
        }
    }

    /**
     * Set the client authentication provider factory class name.
     * If this is not set, no authentication will be used
     *
     * @param factoryClass
     *          the client authentication provider factory class name
     * @return client configuration
     */
    public AbstractConfiguration setClientAuthProviderFactoryClass(
            String factoryClass) {
<span class="nc" id="L335">        setProperty(CLIENT_AUTH_PROVIDER_FACTORY_CLASS, factoryClass);</span>
<span class="nc" id="L336">        return this;</span>
    }

    /**
     * Get the client authentication provider factory class name.
     * If this returns null, no authentication will take place.
     *
     * @return the client authentication provider factory class name or null.
     */
    public String getClientAuthProviderFactoryClass() {
<span class="fc" id="L346">        return getString(CLIENT_AUTH_PROVIDER_FACTORY_CLASS, null);</span>
    }

    /**
     * Get the maximum netty frame size in bytes.  Any message received larger
     * that this will be rejected.
     *
     * @return the maximum netty frame size in bytes.
     */
    public int getNettyMaxFrameSizeBytes() {
<span class="fc" id="L356">        return getInt(NETTY_MAX_FRAME_SIZE, DEFAULT_NETTY_MAX_FRAME_SIZE);</span>
    }

    /**
     * Set the max number of bytes a single message can be that is read by the bookie.
     * Any message larger than that size will be rejected.
     *
     * @param maxSize
     *          the max size in bytes
     * @return server configuration
     */
    public AbstractConfiguration setNettyMaxFrameSizeBytes(int maxSize) {
<span class="nc" id="L368">        setProperty(NETTY_MAX_FRAME_SIZE, String.valueOf(maxSize));</span>
<span class="nc" id="L369">        return this;</span>
    }

    /**
     * Get the security provider factory class name. If this returns null, no security will be enforced on the channel.
     *
     * @return the security provider factory class name or null.
     */
    public String getTLSProviderFactoryClass() {
<span class="fc" id="L378">        return getString(TLS_PROVIDER_FACTORY_CLASS, null);</span>
    }

    /**
     * Set the client security provider factory class name. If this is not set, no security will be used on the channel.
     *
     * @param factoryClass
     *            the client security provider factory class name
     * @return client configuration
     */
    public AbstractConfiguration setTLSProviderFactoryClass(String factoryClass) {
<span class="nc" id="L389">        setProperty(TLS_PROVIDER_FACTORY_CLASS, factoryClass);</span>
<span class="nc" id="L390">        return this;</span>
    }

    /**
     * Get TLS Provider (JDK or OpenSSL)
     * 
     * @return the TLS provider to use in creating TLS Context
     */
    public String getTLSProvider() {
<span class="nc" id="L399">        return getString(TLS_PROVIDER, &quot;OpenSSL&quot;);</span>
    }

    /**
     * Set TLS Provider (JDK or OpenSSL)
     * 
     * @param provider
     *            TLS Provider type
     * @return Client Configuration
     */
    public AbstractConfiguration setTLSProvider(String provider) {
<span class="nc" id="L410">        setProperty(TLS_PROVIDER, provider);</span>
<span class="nc" id="L411">        return this;</span>
    }

    /**
     * Whether the client will send an TLS certificate on TLS-handshake
     * 
     * @see #setTLSAuthentication(boolean)
     * @return whether TLS is enabled on the bookie or not.
     */
    public boolean getTLSClientAuthentication() {
<span class="nc" id="L421">        return getBoolean(TLS_CLIENT_AUTHENTICATION, false);</span>
    }

    /**
     * Specify whether the client will send an TLS certificate on TLS-handshake
     * 
     * @param enabled
     *            Whether to send a certificate or not
     * @return client configuration
     */
    public AbstractConfiguration setTLSClientAuthentication(boolean enabled) {
<span class="nc" id="L432">        setProperty(TLS_CLIENT_AUTHENTICATION, enabled);</span>
<span class="nc" id="L433">        return this;</span>
    }

    /**
     * Set the list of enabled TLS cipher suites. Leave null not to override default JDK list. This list will be passed
     * to {@link SSLEngine#setEnabledCipherSuites(java.lang.String[]) }. Please refer to official JDK JavaDocs
     *
     * @param list
     *            comma separated list of enabled TLS cipher suites
     * @return current configuration
     */
    public AbstractConfiguration setTLSEnabledCipherSuites(
            String list) {
<span class="nc" id="L446">        setProperty(TLS_ENABLED_CIPHER_SUITES, list);</span>
<span class="nc" id="L447">        return this;</span>
    }

    /**
     * Get the list of enabled TLS cipher suites
     *
     * @return this list of enabled TLS cipher suites
     *
     * @see #setTLSEnabledCipherSuites(java.lang.String)
     */
    public String getTLSEnabledCipherSuites() {
<span class="nc" id="L458">        return getString(TLS_ENABLED_CIPHER_SUITES, null);</span>
    }

    /**
     * Set the list of enabled TLS protocols. Leave null not to override default JDK list. This list will be passed to
     * {@link SSLEngine#setEnabledProtocols(java.lang.String[]) }. Please refer to official JDK JavaDocs
     *
     * @param list
     *            comma separated list of enabled TLS cipher suites
     * @return current configuration
     */
    public AbstractConfiguration setTLSEnabledProtocols(
            String list) {
<span class="nc" id="L471">        setProperty(TLS_ENABLED_PROTOCOLS, list);</span>
<span class="nc" id="L472">        return this;</span>
    }

    /**
     * Get the list of enabled TLS protocols
     *
     * @return the list of enabled TLS protocols.
     *
     * @see #setTLSEnabledProtocols(java.lang.String)
     */
    public String getTLSEnabledProtocols() {
<span class="nc" id="L483">        return getString(TLS_ENABLED_PROTOCOLS, null);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>