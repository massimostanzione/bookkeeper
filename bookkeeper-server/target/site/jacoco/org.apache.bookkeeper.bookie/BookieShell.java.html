<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookieShell.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.bookie</a> &gt; <span class="el_source">BookieShell.java</span></div><h1>BookieShell.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.bookkeeper.bookie;

import static com.google.common.base.Charsets.UTF_8;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.Lists;
import com.google.common.util.concurrent.AbstractFuture;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.Serializable;
import java.math.RoundingMode;
import java.nio.ByteBuffer;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.BasicFileAttributes;
import java.nio.file.attribute.FileTime;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Enumeration;
import java.util.Formatter;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.concurrent.TimeUnit;
import java.util.function.Predicate;
import org.apache.bookkeeper.bookie.BookieException.CookieNotFoundException;
import org.apache.bookkeeper.bookie.BookieException.InvalidCookieException;
import org.apache.bookkeeper.bookie.EntryLogger.EntryLogScanner;
import org.apache.bookkeeper.bookie.Journal.JournalScanner;
import org.apache.bookkeeper.client.BKException;
import org.apache.bookkeeper.client.BookKeeper;
import org.apache.bookkeeper.client.BookKeeper.DigestType;
import org.apache.bookkeeper.client.BookKeeperAdmin;
import org.apache.bookkeeper.client.BookieInfoReader.BookieInfo;
import org.apache.bookkeeper.client.LedgerEntry;
import org.apache.bookkeeper.client.LedgerHandle;
import org.apache.bookkeeper.client.LedgerMetadata;
import org.apache.bookkeeper.client.UpdateLedgerOp;
import org.apache.bookkeeper.conf.ClientConfiguration;
import org.apache.bookkeeper.conf.ServerConfiguration;
import org.apache.bookkeeper.discover.RegistrationManager;
import org.apache.bookkeeper.discover.ZKRegistrationManager;
import org.apache.bookkeeper.meta.LedgerManager;
import org.apache.bookkeeper.meta.LedgerManager.LedgerRange;
import org.apache.bookkeeper.meta.LedgerManager.LedgerRangeIterator;
import org.apache.bookkeeper.meta.LedgerManagerFactory;
import org.apache.bookkeeper.meta.LedgerUnderreplicationManager;
import org.apache.bookkeeper.net.BookieSocketAddress;
import org.apache.bookkeeper.proto.BookkeeperInternalCallbacks.GenericCallback;
import org.apache.bookkeeper.replication.AuditorElector;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.bookkeeper.util.DiskChecker;
import org.apache.bookkeeper.util.EntryFormatter;
import org.apache.bookkeeper.util.IOUtils;
import org.apache.bookkeeper.util.MathUtils;
import org.apache.bookkeeper.util.Tool;
import org.apache.bookkeeper.versioning.Version;
import org.apache.bookkeeper.versioning.Versioned;
import org.apache.bookkeeper.zookeeper.ZooKeeperClient;
import org.apache.commons.cli.BasicParser;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.MissingArgumentException;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.configuration.CompositeConfiguration;
import org.apache.commons.configuration.PropertiesConfiguration;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.mutable.MutableBoolean;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.ZooKeeper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Bookie Shell is to provide utilities for users to administer a bookkeeper cluster.
 */
<span class="nc" id="L108">public class BookieShell implements Tool {</span>

<span class="nc" id="L110">    static final Logger LOG = LoggerFactory.getLogger(BookieShell.class);</span>

    static final String ENTRY_FORMATTER_CLASS = &quot;entryFormatterClass&quot;;

    static final String CMD_METAFORMAT = &quot;metaformat&quot;;
    static final String CMD_BOOKIEFORMAT = &quot;bookieformat&quot;;
    static final String CMD_RECOVER = &quot;recover&quot;;
    static final String CMD_LEDGER = &quot;ledger&quot;;
    static final String CMD_READ_LEDGER_ENTRIES = &quot;readledger&quot;;
    static final String CMD_LISTLEDGERS = &quot;listledgers&quot;;
    static final String CMD_LEDGERMETADATA = &quot;ledgermetadata&quot;;
    static final String CMD_LISTUNDERREPLICATED = &quot;listunderreplicated&quot;;
    static final String CMD_WHOISAUDITOR = &quot;whoisauditor&quot;;
    static final String CMD_SIMPLETEST = &quot;simpletest&quot;;
    static final String CMD_BOOKIESANITYTEST = &quot;bookiesanity&quot;;
    static final String CMD_READLOG = &quot;readlog&quot;;
    static final String CMD_READJOURNAL = &quot;readjournal&quot;;
    static final String CMD_LASTMARK = &quot;lastmark&quot;;
    static final String CMD_AUTORECOVERY = &quot;autorecovery&quot;;
    static final String CMD_LISTBOOKIES = &quot;listbookies&quot;;
    static final String CMD_LISTFILESONDISC = &quot;listfilesondisc&quot;;
    static final String CMD_UPDATECOOKIE = &quot;updatecookie&quot;;
    static final String CMD_EXPANDSTORAGE = &quot;expandstorage&quot;;
    static final String CMD_UPDATELEDGER = &quot;updateledgers&quot;;
    static final String CMD_DELETELEDGER = &quot;deleteledger&quot;;
    static final String CMD_BOOKIEINFO = &quot;bookieinfo&quot;;
    static final String CMD_DECOMMISSIONBOOKIE = &quot;decommissionbookie&quot;;
    static final String CMD_LOSTBOOKIERECOVERYDELAY = &quot;lostbookierecoverydelay&quot;;
    static final String CMD_TRIGGERAUDIT = &quot;triggeraudit&quot;;
    static final String CMD_HELP = &quot;help&quot;;

<span class="nc" id="L141">    final ServerConfiguration bkConf = new ServerConfiguration();</span>
    File[] indexDirectories;
    File[] ledgerDirectories;
    File[] journalDirectories;

<span class="nc" id="L146">    EntryLogger entryLogger = null;</span>
<span class="nc" id="L147">    List&lt;Journal&gt; journals = null;</span>
    EntryFormatter formatter;

    int pageSize;
    int entriesPerPage;

    interface Command {
        int runCmd(String[] args) throws Exception;
        void printUsage();
    }

    abstract class MyCommand implements Command {
        abstract Options getOptions();
        abstract String getDescription();
        abstract String getUsage();
        abstract int runCmd(CommandLine cmdLine) throws Exception;

        String cmdName;

<span class="nc" id="L166">        MyCommand(String cmdName) {</span>
<span class="nc" id="L167">            this.cmdName = cmdName;</span>
<span class="nc" id="L168">        }</span>

        @Override
        public int runCmd(String[] args) throws Exception {
            try {
<span class="nc" id="L173">                BasicParser parser = new BasicParser();</span>
<span class="nc" id="L174">                CommandLine cmdLine = parser.parse(getOptions(), args);</span>
<span class="nc" id="L175">                return runCmd(cmdLine);</span>
<span class="nc" id="L176">            } catch (ParseException e) {</span>
<span class="nc" id="L177">                LOG.error(&quot;Error parsing command line arguments : &quot;, e);</span>
<span class="nc" id="L178">                printUsage();</span>
<span class="nc" id="L179">                return -1;</span>
            }
        }

        @Override
        public void printUsage() {
<span class="nc" id="L185">            HelpFormatter hf = new HelpFormatter();</span>
<span class="nc" id="L186">            System.err.println(cmdName + &quot;: &quot; + getDescription());</span>
<span class="nc" id="L187">            hf.printHelp(getUsage(), getOptions());</span>
<span class="nc" id="L188">        }</span>
    }

    /**
     * Format the bookkeeper metadata present in zookeeper.
     */
    class MetaFormatCmd extends MyCommand {
<span class="nc" id="L195">        Options opts = new Options();</span>

<span class="nc" id="L197">        MetaFormatCmd() {</span>
<span class="nc" id="L198">            super(CMD_METAFORMAT);</span>
<span class="nc" id="L199">            opts.addOption(&quot;n&quot;, &quot;nonInteractive&quot;, false,</span>
                    &quot;Whether to confirm if old data exists..?&quot;);
<span class="nc" id="L201">            opts.addOption(&quot;f&quot;, &quot;force&quot;, false,</span>
                    &quot;If [nonInteractive] is specified, then whether&quot;
                            + &quot; to force delete the old data without prompt.&quot;);
<span class="nc" id="L204">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L208">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L213">            return &quot;Format bookkeeper metadata in zookeeper.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L218">            return &quot;metaformat   [-nonInteractive] [-force]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc bnc" id="L223" title="All 2 branches missed.">            boolean interactive = (!cmdLine.hasOption(&quot;n&quot;));</span>
<span class="nc" id="L224">            boolean force = cmdLine.hasOption(&quot;f&quot;);</span>

<span class="nc" id="L226">            ClientConfiguration adminConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L227">            boolean result = BookKeeperAdmin.format(adminConf, interactive,</span>
                    force);
<span class="nc bnc" id="L229" title="All 2 branches missed.">            return (result) ? 0 : 1;</span>
        }
    }

    /**
     * Formats the local data present in current bookie server.
     */
    class BookieFormatCmd extends MyCommand {
<span class="nc" id="L237">        Options opts = new Options();</span>

<span class="nc" id="L239">        public BookieFormatCmd() {</span>
<span class="nc" id="L240">            super(CMD_BOOKIEFORMAT);</span>
<span class="nc" id="L241">            opts.addOption(&quot;n&quot;, &quot;nonInteractive&quot;, false,</span>
                    &quot;Whether to confirm if old data exists..?&quot;);
<span class="nc" id="L243">            opts.addOption(&quot;f&quot;, &quot;force&quot;, false,</span>
                    &quot;If [nonInteractive] is specified, then whether&quot;
                            + &quot; to force delete the old data without prompt..?&quot;);
<span class="nc" id="L246">            opts.addOption(&quot;d&quot;, &quot;deleteCookie&quot;, false, &quot;Delete its cookie on zookeeper&quot;);</span>
<span class="nc" id="L247">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L251">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L256">            return &quot;Format the current server contents.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L261">            return &quot;bookieformat [-nonInteractive] [-force] [-deleteCookie]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc bnc" id="L266" title="All 2 branches missed.">            boolean interactive = (!cmdLine.hasOption(&quot;n&quot;));</span>
<span class="nc" id="L267">            boolean force = cmdLine.hasOption(&quot;f&quot;);</span>

<span class="nc" id="L269">            ServerConfiguration conf = new ServerConfiguration(bkConf);</span>
<span class="nc" id="L270">            boolean result = Bookie.format(conf, interactive, force);</span>
            // delete cookie
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;d&quot;)) {</span>
<span class="nc" id="L273">                RegistrationManager rm = new ZKRegistrationManager();</span>
<span class="nc" id="L274">                rm.initialize(conf, () -&gt; {}, NullStatsLogger.INSTANCE);</span>
                try {
<span class="nc" id="L276">                    Versioned&lt;Cookie&gt; cookie = Cookie.readFromRegistrationManager(rm, conf);</span>
<span class="nc" id="L277">                    cookie.getValue().deleteFromRegistrationManager(rm, conf, cookie.getVersion());</span>
<span class="nc" id="L278">                } catch (CookieNotFoundException nne) {</span>
<span class="nc" id="L279">                    LOG.warn(&quot;No cookie to remove : &quot;, nne);</span>
                } finally {
<span class="nc" id="L281">                    rm.close();</span>
                }
            }
<span class="nc bnc" id="L284" title="All 2 branches missed.">            return (result) ? 0 : 1;</span>
        }
    }

    /**
     * Recover command for ledger data recovery for failed bookie.
     */
    class RecoverCmd extends MyCommand {
<span class="nc" id="L292">        Options opts = new Options();</span>

<span class="nc" id="L294">        public RecoverCmd() {</span>
<span class="nc" id="L295">            super(CMD_RECOVER);</span>
<span class="nc" id="L296">            opts.addOption(&quot;q&quot;, &quot;query&quot;, false, &quot;Query the ledgers that contain given bookies&quot;);</span>
<span class="nc" id="L297">            opts.addOption(&quot;dr&quot;, &quot;dryrun&quot;, false, &quot;Printing the recovery plan w/o doing actual recovery&quot;);</span>
<span class="nc" id="L298">            opts.addOption(&quot;f&quot;, &quot;force&quot;, false, &quot;Force recovery without confirmation&quot;);</span>
<span class="nc" id="L299">            opts.addOption(&quot;l&quot;, &quot;ledger&quot;, true, &quot;Recover a specific ledger&quot;);</span>
<span class="nc" id="L300">            opts.addOption(&quot;sk&quot;, &quot;skipOpenLedgers&quot;, false, &quot;Skip recovering open ledgers&quot;);</span>
<span class="nc" id="L301">            opts.addOption(&quot;d&quot;, &quot;deleteCookie&quot;, false, &quot;Delete cookie node for the bookie.&quot;);</span>
<span class="nc" id="L302">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L306">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L311">            return &quot;Recover the ledger data for failed bookie.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L316">            return &quot;recover [-deleteCookie] &lt;bookieSrc[:bookieSrc]&gt;&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L321">            String[] args = cmdLine.getArgs();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (args.length &lt; 1) {</span>
<span class="nc" id="L323">                throw new MissingArgumentException(</span>
                        &quot;'bookieSrc' argument required&quot;);
            }
<span class="nc bnc" id="L326" title="All 2 branches missed.">            if (args.length &gt; 1) {</span>
<span class="nc" id="L327">                System.err.println(&quot;The provided bookie dest &quot; + args[1] + &quot; will be ignored!&quot;);</span>
            }
<span class="nc" id="L329">            boolean query = cmdLine.hasOption(&quot;q&quot;);</span>
<span class="nc" id="L330">            boolean dryrun = cmdLine.hasOption(&quot;dr&quot;);</span>
<span class="nc" id="L331">            boolean force = cmdLine.hasOption(&quot;f&quot;);</span>
<span class="nc" id="L332">            boolean skipOpenLedgers = cmdLine.hasOption(&quot;sk&quot;);</span>
<span class="nc bnc" id="L333" title="All 4 branches missed.">            boolean removeCookies = !dryrun &amp;&amp; cmdLine.hasOption(&quot;d&quot;);</span>

<span class="nc" id="L335">            Long ledgerId = null;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;l&quot;)) {</span>
                try {
<span class="nc" id="L338">                    ledgerId = Long.parseLong(cmdLine.getOptionValue(&quot;l&quot;));</span>
<span class="nc" id="L339">                } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L340">                    throw new IOException(&quot;Invalid ledger id provided : &quot; + cmdLine.getOptionValue(&quot;l&quot;));</span>
<span class="nc" id="L341">                }</span>
            }

            // Get bookies list
<span class="nc" id="L345">            final String[] bookieStrs = args[0].split(&quot;,&quot;);</span>
<span class="nc" id="L346">            final Set&lt;BookieSocketAddress&gt; bookieAddrs = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            for (String bookieStr : bookieStrs) {</span>
<span class="nc" id="L348">                final String bookieStrParts[] = bookieStr.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (bookieStrParts.length != 2) {</span>
<span class="nc" id="L350">                    System.err.println(&quot;BookieSrcs has invalid bookie address format (host:port expected) : &quot;</span>
                            + bookieStr);
<span class="nc" id="L352">                    return -1;</span>
                }
<span class="nc" id="L354">                bookieAddrs.add(new BookieSocketAddress(bookieStrParts[0],</span>
<span class="nc" id="L355">                        Integer.parseInt(bookieStrParts[1])));</span>
            }

<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (!force) {</span>
<span class="nc" id="L359">                System.err.println(&quot;Bookies : &quot; + bookieAddrs);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (!IOUtils.confirmPrompt(&quot;Are you sure to recover them : (Y/N)&quot;)) {</span>
<span class="nc" id="L361">                    System.err.println(&quot;Give up!&quot;);</span>
<span class="nc" id="L362">                    return -1;</span>
                }
            }

<span class="nc" id="L366">            LOG.info(&quot;Constructing admin&quot;);</span>
<span class="nc" id="L367">            ClientConfiguration adminConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L368">            BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);</span>
<span class="nc" id="L369">            LOG.info(&quot;Construct admin : {}&quot;, admin);</span>
            try {
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if (query) {</span>
<span class="nc" id="L372">                    return bkQuery(admin, bookieAddrs);</span>
                }
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (null != ledgerId) {</span>
<span class="nc" id="L375">                    return bkRecoveryLedger(admin, ledgerId, bookieAddrs, dryrun, skipOpenLedgers, removeCookies);</span>
                }
<span class="nc" id="L377">                return bkRecovery(admin, bookieAddrs, dryrun, skipOpenLedgers, removeCookies);</span>
            } finally {
<span class="nc" id="L379">                admin.close();</span>
            }
        }

        private int bkQuery(BookKeeperAdmin bkAdmin, Set&lt;BookieSocketAddress&gt; bookieAddrs)
                throws InterruptedException, BKException {
<span class="nc" id="L385">            SortedMap&lt;Long, LedgerMetadata&gt; ledgersContainBookies =</span>
<span class="nc" id="L386">                    bkAdmin.getLedgersContainBookies(bookieAddrs);</span>
<span class="nc" id="L387">            System.err.println(&quot;NOTE: Bookies in inspection list are marked with '*'.&quot;);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            for (Map.Entry&lt;Long, LedgerMetadata&gt; ledger : ledgersContainBookies.entrySet()) {</span>
<span class="nc" id="L389">                System.out.println(&quot;ledger &quot; + ledger.getKey() + &quot; : &quot; + ledger.getValue().getState());</span>
<span class="nc" id="L390">                Map&lt;Long, Integer&gt; numBookiesToReplacePerEnsemble =</span>
<span class="nc" id="L391">                        inspectLedger(ledger.getValue(), bookieAddrs);</span>
<span class="nc" id="L392">                System.out.print(&quot;summary: [&quot;);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                for (Map.Entry&lt;Long, Integer&gt; entry : numBookiesToReplacePerEnsemble.entrySet()) {</span>
<span class="nc" id="L394">                    System.out.print(entry.getKey() + &quot;=&quot; + entry.getValue() + &quot;, &quot;);</span>
<span class="nc" id="L395">                }</span>
<span class="nc" id="L396">                System.out.println(&quot;]&quot;);</span>
<span class="nc" id="L397">                System.out.println();</span>
<span class="nc" id="L398">            }</span>
<span class="nc" id="L399">            System.err.println(&quot;Done&quot;);</span>
<span class="nc" id="L400">            return 0;</span>
        }

        private Map&lt;Long, Integer&gt; inspectLedger(LedgerMetadata metadata, Set&lt;BookieSocketAddress&gt; bookiesToInspect) {
<span class="nc" id="L404">            Map&lt;Long, Integer&gt; numBookiesToReplacePerEnsemble = new TreeMap&lt;Long, Integer&gt;();</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            for (Map.Entry&lt;Long, ArrayList&lt;BookieSocketAddress&gt;&gt; ensemble : metadata.getEnsembles().entrySet()) {</span>
<span class="nc" id="L406">                ArrayList&lt;BookieSocketAddress&gt; bookieList = ensemble.getValue();</span>
<span class="nc" id="L407">                System.out.print(ensemble.getKey() + &quot;:\t&quot;);</span>
<span class="nc" id="L408">                int numBookiesToReplace = 0;</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                for (BookieSocketAddress bookie: bookieList) {</span>
<span class="nc" id="L410">                    System.out.print(bookie);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">                    if (bookiesToInspect.contains(bookie)) {</span>
<span class="nc" id="L412">                        System.out.print(&quot;*&quot;);</span>
<span class="nc" id="L413">                        ++numBookiesToReplace;</span>
                    } else {
<span class="nc" id="L415">                        System.out.print(&quot; &quot;);</span>
                    }
<span class="nc" id="L417">                    System.out.print(&quot; &quot;);</span>
<span class="nc" id="L418">                }</span>
<span class="nc" id="L419">                System.out.println();</span>
<span class="nc" id="L420">                numBookiesToReplacePerEnsemble.put(ensemble.getKey(), numBookiesToReplace);</span>
<span class="nc" id="L421">            }</span>
<span class="nc" id="L422">            return numBookiesToReplacePerEnsemble;</span>
        }

        private int bkRecoveryLedger(BookKeeperAdmin bkAdmin,
                                     long lid,
                                     Set&lt;BookieSocketAddress&gt; bookieAddrs,
                                     boolean dryrun,
                                     boolean skipOpenLedgers,
                                     boolean removeCookies)
                throws InterruptedException, BKException, KeeperException {
<span class="nc" id="L432">            bkAdmin.recoverBookieData(lid, bookieAddrs, dryrun, skipOpenLedgers);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if (removeCookies) {</span>
<span class="nc" id="L434">                deleteCookies(bkAdmin.getConf(), bookieAddrs);</span>
            }
<span class="nc" id="L436">            return 0;</span>
        }

        private int bkRecovery(BookKeeperAdmin bkAdmin,
                               Set&lt;BookieSocketAddress&gt; bookieAddrs,
                               boolean dryrun,
                               boolean skipOpenLedgers,
                               boolean removeCookies)
                throws InterruptedException, BKException, KeeperException {
<span class="nc" id="L445">            bkAdmin.recoverBookieData(bookieAddrs, dryrun, skipOpenLedgers);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (removeCookies) {</span>
<span class="nc" id="L447">                deleteCookies(bkAdmin.getConf(), bookieAddrs);</span>
            }
<span class="nc" id="L449">            return 0;</span>
        }

        private void deleteCookies(ClientConfiguration conf,
                                   Set&lt;BookieSocketAddress&gt; bookieAddrs) throws BKException {
<span class="nc" id="L454">            ServerConfiguration serverConf = new ServerConfiguration(conf);</span>
<span class="nc" id="L455">            RegistrationManager rm = new ZKRegistrationManager();</span>
            try {
<span class="nc" id="L457">                rm.initialize(serverConf, () -&gt; {}, NullStatsLogger.INSTANCE);</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">                for (BookieSocketAddress addr : bookieAddrs) {</span>
<span class="nc" id="L459">                    deleteCookie(rm, addr);</span>
<span class="nc" id="L460">                }</span>
<span class="nc" id="L461">            } catch (BookieException be) {</span>
<span class="nc" id="L462">                BKException bke = new BKException.MetaStoreException();</span>
<span class="nc" id="L463">                bke.initCause(be);</span>
<span class="nc" id="L464">                throw bke;</span>
            } finally {
<span class="nc" id="L466">                rm.close();</span>
            }
<span class="nc" id="L468">        }</span>

        private void deleteCookie(RegistrationManager rm,
                                  BookieSocketAddress bookieSrc) throws BookieException {
            try {
<span class="nc" id="L473">                Versioned&lt;Cookie&gt; cookie = Cookie.readFromRegistrationManager(rm, bookieSrc);</span>
<span class="nc" id="L474">                cookie.getValue().deleteFromRegistrationManager(rm, bookieSrc, cookie.getVersion());</span>
<span class="nc" id="L475">            } catch (CookieNotFoundException nne) {</span>
<span class="nc" id="L476">                LOG.warn(&quot;No cookie to remove for {} : &quot;, bookieSrc, nne);</span>
<span class="nc" id="L477">            }</span>
<span class="nc" id="L478">        }</span>

    }

    /**
     * Ledger Command Handles ledger related operations.
     */
    class LedgerCmd extends MyCommand {
<span class="nc" id="L486">        Options lOpts = new Options();</span>

<span class="nc" id="L488">        LedgerCmd() {</span>
<span class="nc" id="L489">            super(CMD_LEDGER);</span>
<span class="nc" id="L490">            lOpts.addOption(&quot;m&quot;, &quot;meta&quot;, false, &quot;Print meta information&quot;);</span>
<span class="nc" id="L491">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L495">            String[] leftArgs = cmdLine.getArgs();</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">            if (leftArgs.length &lt;= 0) {</span>
<span class="nc" id="L497">                System.err.println(&quot;ERROR: missing ledger id&quot;);</span>
<span class="nc" id="L498">                printUsage();</span>
<span class="nc" id="L499">                return -1;</span>
            }

<span class="nc" id="L502">            boolean printMeta = false;</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;m&quot;)) {</span>
<span class="nc" id="L504">                printMeta = true;</span>
            }
            long ledgerId;
            try {
<span class="nc" id="L508">                ledgerId = Long.parseLong(leftArgs[0]);</span>
<span class="nc" id="L509">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L510">                System.err.println(&quot;ERROR: invalid ledger id &quot; + leftArgs[0]);</span>
<span class="nc" id="L511">                printUsage();</span>
<span class="nc" id="L512">                return -1;</span>
<span class="nc" id="L513">            }</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if (printMeta) {</span>
                // print meta
<span class="nc" id="L516">                readLedgerMeta(ledgerId);</span>
            }
            // dump ledger info
<span class="nc" id="L519">            readLedgerIndexEntries(ledgerId);</span>
<span class="nc" id="L520">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L525">            return &quot;Dump ledger index entries into readable format.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L530">            return &quot;ledger       [-m] &lt;ledger_id&gt;&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L535">            return lOpts;</span>
        }
    }

    /**
     * Command for reading ledger entries.
     */
    class ReadLedgerEntriesCmd extends MyCommand {
<span class="nc" id="L543">        Options lOpts = new Options();</span>

<span class="nc" id="L545">        ReadLedgerEntriesCmd() {</span>
<span class="nc" id="L546">            super(CMD_READ_LEDGER_ENTRIES);</span>
<span class="nc" id="L547">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L551">            return lOpts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L556">            return &quot;Read a range of entries from a ledger.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L561">            return &quot;readledger &lt;ledger_id&gt; [&lt;start_entry_id&gt; [&lt;end_entry_id&gt;]]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L566">            String[] leftArgs = cmdLine.getArgs();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (leftArgs.length &lt;= 0) {</span>
<span class="nc" id="L568">                System.err.println(&quot;ERROR: missing ledger id&quot;);</span>
<span class="nc" id="L569">                printUsage();</span>
<span class="nc" id="L570">                return -1;</span>
            }

            long ledgerId;
<span class="nc" id="L574">            long firstEntry = 0;</span>
<span class="nc" id="L575">            long lastEntry = -1;</span>
            try {
<span class="nc" id="L577">                ledgerId = Long.parseLong(leftArgs[0]);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                if (leftArgs.length &gt;= 2) {</span>
<span class="nc" id="L579">                    firstEntry = Long.parseLong(leftArgs[1]);</span>
                }
<span class="nc bnc" id="L581" title="All 2 branches missed.">                if (leftArgs.length &gt;= 3) {</span>
<span class="nc" id="L582">                    lastEntry = Long.parseLong(leftArgs[2]);</span>
                }
<span class="nc" id="L584">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L585">                System.err.println(&quot;ERROR: invalid number &quot; + nfe.getMessage());</span>
<span class="nc" id="L586">                printUsage();</span>
<span class="nc" id="L587">                return -1;</span>
<span class="nc" id="L588">            }</span>

<span class="nc" id="L590">            ClientConfiguration conf = new ClientConfiguration();</span>
<span class="nc" id="L591">            conf.addConfiguration(bkConf);</span>

<span class="nc" id="L593">            BookKeeperAdmin bk = null;</span>
            try {
<span class="nc" id="L595">                bk = new BookKeeperAdmin(conf);</span>
<span class="nc" id="L596">                Iterator&lt;LedgerEntry&gt; entries = bk.readEntries(ledgerId, firstEntry, lastEntry).iterator();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                while (entries.hasNext()) {</span>
<span class="nc" id="L598">                    LedgerEntry entry = entries.next();</span>
<span class="nc" id="L599">                    formatEntry(entry, true);</span>
<span class="nc" id="L600">                }</span>
<span class="nc" id="L601">            } catch (Exception e) {</span>
<span class="nc" id="L602">                LOG.error(&quot;Error reading entries from ledger {}&quot;, ledgerId, e.getCause());</span>
<span class="nc" id="L603">                return -1;</span>
            } finally {
<span class="nc bnc" id="L605" title="All 2 branches missed.">                if (bk != null) {</span>
<span class="nc" id="L606">                    bk.close();</span>
                }
            }

<span class="nc" id="L610">            return 0;</span>
        }

    }

    /**
     * Command for listing underreplicated ledgers.
     */
    class ListUnderreplicatedCmd extends MyCommand {
<span class="nc" id="L619">        Options opts = new Options();</span>

<span class="nc" id="L621">        public ListUnderreplicatedCmd() {</span>
<span class="nc" id="L622">            super(CMD_LISTUNDERREPLICATED);</span>
<span class="nc" id="L623">            opts.addOption(&quot;missingreplica&quot;, true, &quot;Bookie Id of missing replica&quot;);</span>
<span class="nc" id="L624">            opts.addOption(&quot;excludingmissingreplica&quot;, true, &quot;Bookie Id of missing replica to ignore&quot;);</span>
<span class="nc" id="L625">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L629">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L634">            return &quot;List ledgers marked as underreplicated, with optional options to specify missingreplica&quot;</span>
                + &quot; (BookieId) and to exclude missingreplica.&quot;;
        }

        @Override
        String getUsage() {
<span class="nc" id="L640">            return &quot;listunderreplicated [[-missingreplica &lt;bookieaddress&gt;]&quot;</span>
                + &quot; [-excludingmissingreplica &lt;bookieaddress&gt;]]&quot;;
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {

<span class="nc" id="L647">            final String includingBookieId = cmdLine.getOptionValue(&quot;missingreplica&quot;);</span>
<span class="nc" id="L648">            final String excludingBookieId = cmdLine.getOptionValue(&quot;excludingmissingreplica&quot;);</span>

<span class="nc" id="L650">            Predicate&lt;List&lt;String&gt;&gt; predicate = null;</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">            if (!StringUtils.isBlank(includingBookieId) &amp;&amp; !StringUtils.isBlank(excludingBookieId)) {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                predicate = replicasList -&gt; (replicasList.contains(includingBookieId)</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                        &amp;&amp; !replicasList.contains(excludingBookieId));</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            } else if (!StringUtils.isBlank(includingBookieId)) {</span>
<span class="nc" id="L655">                predicate = replicasList -&gt; replicasList.contains(includingBookieId);</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">            } else if (!StringUtils.isBlank(excludingBookieId)) {</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                predicate = replicasList -&gt; !replicasList.contains(excludingBookieId);</span>
            }

<span class="nc" id="L660">            ZooKeeper zk = null;</span>
            try {
<span class="nc" id="L662">                zk = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L663">                        .connectString(bkConf.getZkServers())</span>
<span class="nc" id="L664">                        .sessionTimeoutMs(bkConf.getZkTimeout())</span>
<span class="nc" id="L665">                        .build();</span>
<span class="nc" id="L666">                LedgerManagerFactory mFactory = LedgerManagerFactory.newLedgerManagerFactory(bkConf, zk);</span>
<span class="nc" id="L667">                LedgerUnderreplicationManager underreplicationManager = mFactory.newLedgerUnderreplicationManager();</span>
<span class="nc" id="L668">                Iterator&lt;Long&gt; iter = underreplicationManager.listLedgersToRereplicate(predicate);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">                while (iter.hasNext()) {</span>
<span class="nc" id="L670">                    System.out.println(iter.next());</span>
                }
            } finally {
<span class="nc bnc" id="L673" title="All 2 branches missed.">                if (zk != null) {</span>
<span class="nc" id="L674">                    zk.close();</span>
                }
            }

<span class="nc" id="L678">            return 0;</span>
        }
    }

    static final int LIST_BATCH_SIZE = 1000;
    /**
     * Command to list all ledgers in the cluster.
     */
    class ListLedgersCmd extends MyCommand {
<span class="nc" id="L687">        Options lOpts = new Options();</span>

<span class="nc" id="L689">        ListLedgersCmd() {</span>
<span class="nc" id="L690">            super(CMD_LISTLEDGERS);</span>
<span class="nc" id="L691">            lOpts.addOption(&quot;m&quot;, &quot;meta&quot;, false, &quot;Print metadata&quot;);</span>

<span class="nc" id="L693">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L697">            ZooKeeper zk = null;</span>
<span class="nc" id="L698">            LedgerManagerFactory mFactory = null;</span>
<span class="nc" id="L699">            LedgerManager m = null;</span>
            try {
<span class="nc" id="L701">                zk = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L702">                        .connectString(bkConf.getZkServers())</span>
<span class="nc" id="L703">                        .sessionTimeoutMs(bkConf.getZkTimeout())</span>
<span class="nc" id="L704">                        .build();</span>
<span class="nc" id="L705">                mFactory = LedgerManagerFactory.newLedgerManagerFactory(bkConf, zk);</span>
<span class="nc" id="L706">                m = mFactory.newLedgerManager();</span>
<span class="nc" id="L707">                LedgerRangeIterator iter = m.getLedgerRanges();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (cmdLine.hasOption(&quot;m&quot;)) {</span>
<span class="nc" id="L709">                    List&lt;ReadMetadataCallback&gt; futures = new ArrayList&lt;ReadMetadataCallback&gt;(LIST_BATCH_SIZE);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                    while (iter.hasNext()) {</span>
<span class="nc" id="L711">                        LedgerRange r = iter.next();</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                        for (Long lid : r.getLedgers()) {</span>
<span class="nc" id="L713">                            ReadMetadataCallback cb = new ReadMetadataCallback(lid);</span>
<span class="nc" id="L714">                            m.readLedgerMetadata(lid, cb);</span>
<span class="nc" id="L715">                            futures.add(cb);</span>
<span class="nc" id="L716">                        }</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                        if (futures.size() &gt;= LIST_BATCH_SIZE) {</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                            while (futures.size() &gt; 0) {</span>
<span class="nc" id="L719">                                ReadMetadataCallback cb = futures.remove(0);</span>
<span class="nc" id="L720">                                printLedgerMetadata(cb);</span>
<span class="nc" id="L721">                            }</span>
                        }
<span class="nc" id="L723">                    }</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">                    while (futures.size() &gt; 0) {</span>
<span class="nc" id="L725">                        ReadMetadataCallback cb = futures.remove(0);</span>
<span class="nc" id="L726">                        printLedgerMetadata(cb);</span>
<span class="nc" id="L727">                    }</span>
<span class="nc" id="L728">                } else {</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                    while (iter.hasNext()) {</span>
<span class="nc" id="L730">                        LedgerRange r = iter.next();</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                        for (Long lid : r.getLedgers()) {</span>
<span class="nc" id="L732">                            System.out.println(Long.toString(lid));</span>
<span class="nc" id="L733">                        }</span>
<span class="nc" id="L734">                    }</span>
                }
            } finally {
<span class="nc bnc" id="L737" title="All 2 branches missed.">                if (m != null) {</span>
                    try {
<span class="nc" id="L739">                      m.close();</span>
<span class="nc" id="L740">                      mFactory.uninitialize();</span>
<span class="nc" id="L741">                    } catch (IOException ioe) {</span>
<span class="nc" id="L742">                      LOG.error(&quot;Failed to close ledger manager : &quot;, ioe);</span>
<span class="nc" id="L743">                    }</span>
                }
<span class="nc bnc" id="L745" title="All 2 branches missed.">                if (zk != null) {</span>
<span class="nc" id="L746">                    zk.close();</span>
                }
            }

<span class="nc" id="L750">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L755">            return &quot;List all ledgers on the cluster (this may take a long time).&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L760">            return &quot;listledgers  [-meta]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L765">            return lOpts;</span>
        }
    }

    static void printLedgerMetadata(ReadMetadataCallback cb) throws Exception {
<span class="nc" id="L770">        LedgerMetadata md = cb.get();</span>
<span class="nc" id="L771">        System.out.println(&quot;ledgerID: &quot; + cb.getLedgerId());</span>
<span class="nc" id="L772">        System.out.println(new String(md.serialize(), UTF_8));</span>
<span class="nc" id="L773">    }</span>

    static class ReadMetadataCallback extends AbstractFuture&lt;LedgerMetadata&gt;
        implements GenericCallback&lt;LedgerMetadata&gt; {
        final long ledgerId;

<span class="nc" id="L779">        ReadMetadataCallback(long ledgerId) {</span>
<span class="nc" id="L780">            this.ledgerId = ledgerId;</span>
<span class="nc" id="L781">        }</span>

        long getLedgerId() {
<span class="nc" id="L784">            return ledgerId;</span>
        }

        public void operationComplete(int rc, LedgerMetadata result) {
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (rc != 0) {</span>
<span class="nc" id="L789">                setException(BKException.create(rc));</span>
            } else {
<span class="nc" id="L791">                set(result);</span>
            }
<span class="nc" id="L793">        }</span>
    }

    /**
     * Print the metadata for a ledger.
     */
    class LedgerMetadataCmd extends MyCommand {
<span class="nc" id="L800">        Options lOpts = new Options();</span>

<span class="nc" id="L802">        LedgerMetadataCmd() {</span>
<span class="nc" id="L803">            super(CMD_LEDGERMETADATA);</span>
<span class="nc" id="L804">            lOpts.addOption(&quot;l&quot;, &quot;ledgerid&quot;, true, &quot;Ledger ID&quot;);</span>
<span class="nc" id="L805">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L809">            final long lid = getOptionLongValue(cmdLine, &quot;ledgerid&quot;, -1);</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">            if (lid == -1) {</span>
<span class="nc" id="L811">                System.err.println(&quot;Must specify a ledger id&quot;);</span>
<span class="nc" id="L812">                return -1;</span>
            }

<span class="nc" id="L815">            ZooKeeper zk = null;</span>
<span class="nc" id="L816">            LedgerManagerFactory mFactory = null;</span>
<span class="nc" id="L817">            LedgerManager m = null;</span>
            try {
<span class="nc" id="L819">                zk = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L820">                        .connectString(bkConf.getZkServers())</span>
<span class="nc" id="L821">                        .sessionTimeoutMs(bkConf.getZkTimeout())</span>
<span class="nc" id="L822">                        .build();</span>
<span class="nc" id="L823">                mFactory = LedgerManagerFactory.newLedgerManagerFactory(bkConf, zk);</span>
<span class="nc" id="L824">                m = mFactory.newLedgerManager();</span>
<span class="nc" id="L825">                ReadMetadataCallback cb = new ReadMetadataCallback(lid);</span>
<span class="nc" id="L826">                m.readLedgerMetadata(lid, cb);</span>
<span class="nc" id="L827">                printLedgerMetadata(cb);</span>
            } finally {
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (m != null) {</span>
                    try {
<span class="nc" id="L831">                        m.close();</span>
<span class="nc" id="L832">                        mFactory.uninitialize();</span>
<span class="nc" id="L833">                    } catch (IOException ioe) {</span>
<span class="nc" id="L834">                        LOG.error(&quot;Failed to close ledger manager : &quot;, ioe);</span>
<span class="nc" id="L835">                    }</span>
                }
<span class="nc bnc" id="L837" title="All 2 branches missed.">                if (zk != null) {</span>
<span class="nc" id="L838">                    zk.close();</span>
                }
            }

<span class="nc" id="L842">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L847">            return &quot;Print the metadata for a ledger.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L852">            return &quot;ledgermetadata -ledgerid &lt;ledgerid&gt;&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L857">            return lOpts;</span>
        }
    }

    /**
     * Simple test to create a ledger and write to it.
     */
    class SimpleTestCmd extends MyCommand {
<span class="nc" id="L865">        Options lOpts = new Options();</span>

<span class="nc" id="L867">        SimpleTestCmd() {</span>
<span class="nc" id="L868">            super(CMD_SIMPLETEST);</span>
<span class="nc" id="L869">            lOpts.addOption(&quot;e&quot;, &quot;ensemble&quot;, true, &quot;Ensemble size (default 3)&quot;);</span>
<span class="nc" id="L870">            lOpts.addOption(&quot;w&quot;, &quot;writeQuorum&quot;, true, &quot;Write quorum size (default 2)&quot;);</span>
<span class="nc" id="L871">            lOpts.addOption(&quot;a&quot;, &quot;ackQuorum&quot;, true, &quot;Ack quorum size (default 2)&quot;);</span>
<span class="nc" id="L872">            lOpts.addOption(&quot;n&quot;, &quot;numEntries&quot;, true, &quot;Entries to write (default 1000)&quot;);</span>
<span class="nc" id="L873">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L877">            byte[] data = new byte[100]; // test data</span>

<span class="nc" id="L879">            int ensemble = getOptionIntValue(cmdLine, &quot;ensemble&quot;, 3);</span>
<span class="nc" id="L880">            int writeQuorum = getOptionIntValue(cmdLine, &quot;writeQuorum&quot;, 2);</span>
<span class="nc" id="L881">            int ackQuorum = getOptionIntValue(cmdLine, &quot;ackQuorum&quot;, 2);</span>
<span class="nc" id="L882">            int numEntries = getOptionIntValue(cmdLine, &quot;numEntries&quot;, 1000);</span>

<span class="nc" id="L884">            ClientConfiguration conf = new ClientConfiguration();</span>
<span class="nc" id="L885">            conf.addConfiguration(bkConf);</span>
<span class="nc" id="L886">            BookKeeper bk = new BookKeeper(conf);</span>
<span class="nc" id="L887">            LedgerHandle lh = bk.createLedger(ensemble, writeQuorum, ackQuorum,</span>
                                              BookKeeper.DigestType.MAC, new byte[0]);
<span class="nc" id="L889">            System.out.println(&quot;Ledger ID: &quot; + lh.getId());</span>
<span class="nc" id="L890">            long lastReport = System.nanoTime();</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            for (int i = 0; i &lt; numEntries; i++) {</span>
<span class="nc" id="L892">                lh.addEntry(data);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">                if (TimeUnit.SECONDS.convert(System.nanoTime() - lastReport,</span>
                                             TimeUnit.NANOSECONDS) &gt; 1) {
<span class="nc" id="L895">                    System.out.println(i + &quot; entries written&quot;);</span>
<span class="nc" id="L896">                    lastReport = System.nanoTime();</span>
                }
            }

<span class="nc" id="L900">            lh.close();</span>
<span class="nc" id="L901">            bk.close();</span>
<span class="nc" id="L902">            System.out.println(numEntries + &quot; entries written to ledger &quot; + lh.getId());</span>

<span class="nc" id="L904">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L909">            return &quot;Simple test to create a ledger and write entries to it.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L914">            return &quot;simpletest   [-ensemble N] [-writeQuorum N] [-ackQuorum N] [-numEntries N]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L919">            return lOpts;</span>
        }
    }

    /**
     * Command to run a bookie sanity test.
     */
    class BookieSanityTestCmd extends MyCommand {
<span class="nc" id="L927">        Options lOpts = new Options();</span>

<span class="nc" id="L929">        BookieSanityTestCmd() {</span>
<span class="nc" id="L930">            super(CMD_BOOKIESANITYTEST);</span>
<span class="nc" id="L931">            lOpts.addOption(&quot;e&quot;, &quot;entries&quot;, true, &quot;Total entries to be added for the test (default 10)&quot;);</span>
<span class="nc" id="L932">            lOpts.addOption(&quot;t&quot;, &quot;timeout&quot;, true, &quot;Timeout for write/read operations in seconds (default 1)&quot;);</span>
<span class="nc" id="L933">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L937">            return lOpts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L942">            return &quot;Sanity test for local bookie. Create ledger and write/reads entries on local bookie.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L947">            return &quot;bookiesanity [-entries N] [-timeout N]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L952">            int numberOfEntries = getOptionIntValue(cmdLine, &quot;entries&quot;, 10);</span>
<span class="nc" id="L953">            int timeoutSecs = getOptionIntValue(cmdLine, &quot;timeout&quot;, 1);</span>

<span class="nc" id="L955">            ClientConfiguration conf = new ClientConfiguration();</span>
<span class="nc" id="L956">            conf.addConfiguration(bkConf);</span>
<span class="nc" id="L957">            conf.setEnsemblePlacementPolicy(LocalBookieEnsemblePlacementPolicy.class);</span>
<span class="nc" id="L958">            conf.setAddEntryTimeout(timeoutSecs);</span>
<span class="nc" id="L959">            conf.setReadEntryTimeout(timeoutSecs);</span>

<span class="nc" id="L961">            BookKeeper bk = new BookKeeper(conf);</span>
<span class="nc" id="L962">            LedgerHandle lh = null;</span>
            try {
<span class="nc" id="L964">                lh = bk.createLedger(1, 1, DigestType.MAC, new byte[0]);</span>
<span class="nc" id="L965">                LOG.info(&quot;Created ledger {}&quot;, lh.getId());</span>

<span class="nc bnc" id="L967" title="All 2 branches missed.">                for (int i = 0; i &lt; numberOfEntries; i++) {</span>
<span class="nc" id="L968">                    String content = &quot;entry-&quot; + i;</span>
<span class="nc" id="L969">                    lh.addEntry(content.getBytes(UTF_8));</span>
                }

<span class="nc" id="L972">                LOG.info(&quot;Written {} entries in ledger {}&quot;, numberOfEntries, lh.getId());</span>

                // Reopen the ledger and read entries
<span class="nc" id="L975">                lh = bk.openLedger(lh.getId(), DigestType.MAC, new byte[0]);</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">                if (lh.getLastAddConfirmed() != (numberOfEntries - 1)) {</span>
<span class="nc" id="L977">                    throw new Exception(&quot;Invalid last entry found on ledger. expecting: &quot; + (numberOfEntries - 1)</span>
<span class="nc" id="L978">                            + &quot; -- found: &quot; + lh.getLastAddConfirmed());</span>
                }

<span class="nc" id="L981">                Enumeration&lt;LedgerEntry&gt; entries = lh.readEntries(0, numberOfEntries - 1);</span>
<span class="nc" id="L982">                int i = 0;</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                while (entries.hasMoreElements()) {</span>
<span class="nc" id="L984">                    LedgerEntry entry = entries.nextElement();</span>
<span class="nc" id="L985">                    String actualMsg = new String(entry.getEntry(), UTF_8);</span>
<span class="nc" id="L986">                    String expectedMsg = &quot;entry-&quot; + (i++);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">                    if (!expectedMsg.equals(actualMsg)) {</span>
<span class="nc" id="L988">                        throw new Exception(&quot;Failed validation of received message - Expected: &quot; + expectedMsg</span>
                                + &quot;, Actual: &quot; + actualMsg);
                    }
<span class="nc" id="L991">                }</span>

<span class="nc" id="L993">                LOG.info(&quot;Read {} entries from ledger {}&quot;, entries, lh.getId());</span>
<span class="nc" id="L994">            } catch (Exception e) {</span>
<span class="nc" id="L995">                LOG.warn(&quot;Error in bookie sanity test&quot;, e);</span>
<span class="nc" id="L996">                return -1;</span>
            } finally {
<span class="nc bnc" id="L998" title="All 2 branches missed.">                if (lh != null) {</span>
<span class="nc" id="L999">                    bk.deleteLedger(lh.getId());</span>
<span class="nc" id="L1000">                    LOG.info(&quot;Deleted ledger {}&quot;, lh.getId());</span>
                }

<span class="nc" id="L1003">                bk.close();</span>
            }

<span class="nc" id="L1006">            LOG.info(&quot;Bookie sanity test succeeded&quot;);</span>
<span class="nc" id="L1007">            return 0;</span>
        }
    }

    /**
     * Command to read entry log files.
     */
    class ReadLogCmd extends MyCommand {
<span class="nc" id="L1015">        Options rlOpts = new Options();</span>

<span class="nc" id="L1017">        ReadLogCmd() {</span>
<span class="nc" id="L1018">            super(CMD_READLOG);</span>
<span class="nc" id="L1019">            rlOpts.addOption(&quot;m&quot;, &quot;msg&quot;, false, &quot;Print message body&quot;);</span>
<span class="nc" id="L1020">            rlOpts.addOption(&quot;l&quot;, &quot;ledgerid&quot;, true, &quot;Ledger ID&quot;);</span>
<span class="nc" id="L1021">            rlOpts.addOption(&quot;e&quot;, &quot;entryid&quot;, true, &quot;Entry ID&quot;);</span>
<span class="nc" id="L1022">            rlOpts.addOption(&quot;sp&quot;, &quot;startpos&quot;, true, &quot;Start Position&quot;);</span>
<span class="nc" id="L1023">            rlOpts.addOption(&quot;ep&quot;, &quot;endpos&quot;, true, &quot;End Position&quot;);</span>
<span class="nc" id="L1024">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1028">            String[] leftArgs = cmdLine.getArgs();</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">            if (leftArgs.length &lt;= 0) {</span>
<span class="nc" id="L1030">                System.err.println(&quot;ERROR: missing entry log id or entry log file name&quot;);</span>
<span class="nc" id="L1031">                printUsage();</span>
<span class="nc" id="L1032">                return -1;</span>
            }

<span class="nc" id="L1035">            boolean printMsg = false;</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;m&quot;)) {</span>
<span class="nc" id="L1037">                printMsg = true;</span>
            }
            long logId;
            try {
<span class="nc" id="L1041">                logId = Long.parseLong(leftArgs[0]);</span>
<span class="nc" id="L1042">            } catch (NumberFormatException nfe) {</span>
                // not a entry log id
<span class="nc" id="L1044">                File f = new File(leftArgs[0]);</span>
<span class="nc" id="L1045">                String name = f.getName();</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">                if (!name.endsWith(&quot;.log&quot;)) {</span>
                    // not a log file
<span class="nc" id="L1048">                    System.err.println(&quot;ERROR: invalid entry log file name &quot; + leftArgs[0]);</span>
<span class="nc" id="L1049">                    printUsage();</span>
<span class="nc" id="L1050">                    return -1;</span>
                }
<span class="nc" id="L1052">                String idString = name.split(&quot;\\.&quot;)[0];</span>
<span class="nc" id="L1053">                logId = Long.parseLong(idString, 16);</span>
<span class="nc" id="L1054">            }</span>

<span class="nc" id="L1056">            final long lId = getOptionLongValue(cmdLine, &quot;ledgerid&quot;, -1);</span>
<span class="nc" id="L1057">            final long eId = getOptionLongValue(cmdLine, &quot;entryid&quot;, -1);</span>
<span class="nc" id="L1058">            final long startpos = getOptionLongValue(cmdLine, &quot;startpos&quot;, -1);</span>
<span class="nc" id="L1059">            final long endpos = getOptionLongValue(cmdLine, &quot;endpos&quot;, -1);</span>

            // scan entry log
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if (startpos != -1) {</span>
<span class="nc bnc" id="L1063" title="All 4 branches missed.">                if ((endpos != -1) &amp;&amp; (endpos &lt; startpos)) {</span>
<span class="nc" id="L1064">                    System.err</span>
<span class="nc" id="L1065">                            .println(&quot;ERROR: StartPosition of the range should be lesser than or equal to EndPosition&quot;);</span>
<span class="nc" id="L1066">                    return -1;</span>
                }
<span class="nc" id="L1068">                scanEntryLogForPositionRange(logId, startpos, endpos, printMsg);</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">            } else if (lId != -1) {</span>
<span class="nc" id="L1070">                scanEntryLogForSpecificEntry(logId, lId, eId, printMsg);</span>
            } else {
<span class="nc" id="L1072">                scanEntryLog(logId, printMsg);</span>
            }

<span class="nc" id="L1075">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1080">            return &quot;Scan an entry file and format the entries into readable format.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1085">            return &quot;readlog      [-msg] &lt;entry_log_id | entry_log_file_name&gt; [-ledgerid &lt;ledgerid&gt; &quot;</span>
                    + &quot;[-entryid &lt;entryid&gt;]] [-startpos &lt;startEntryLogBytePos&gt; [-endpos &lt;endEntryLogBytePos&gt;]]&quot;;
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1091">            return rlOpts;</span>
        }
    }

    /**
     * Command to read journal files.
     */
    class ReadJournalCmd extends MyCommand {
<span class="nc" id="L1099">        Options rjOpts = new Options();</span>

<span class="nc" id="L1101">        ReadJournalCmd() {</span>
<span class="nc" id="L1102">            super(CMD_READJOURNAL);</span>
<span class="nc" id="L1103">            rjOpts.addOption(&quot;dir&quot;, false, &quot;Journal directory (needed if more than one journal configured)&quot;);</span>
<span class="nc" id="L1104">            rjOpts.addOption(&quot;m&quot;, &quot;msg&quot;, false, &quot;Print message body&quot;);</span>
<span class="nc" id="L1105">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1109">            String[] leftArgs = cmdLine.getArgs();</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">            if (leftArgs.length &lt;= 0) {</span>
<span class="nc" id="L1111">                System.err.println(&quot;ERROR: missing journal id or journal file name&quot;);</span>
<span class="nc" id="L1112">                printUsage();</span>
<span class="nc" id="L1113">                return -1;</span>
            }

<span class="nc" id="L1116">            boolean printMsg = false;</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;m&quot;)) {</span>
<span class="nc" id="L1118">                printMsg = true;</span>
            }

<span class="nc" id="L1121">            Journal journal = null;</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">            if (getJournals().size() &gt; 1) {</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                if (!cmdLine.hasOption(&quot;dir&quot;)) {</span>
<span class="nc" id="L1124">                    System.err.println(&quot;ERROR: invalid or missing journal directory&quot;);</span>
<span class="nc" id="L1125">                    printUsage();</span>
<span class="nc" id="L1126">                    return -1;</span>
                }

<span class="nc" id="L1129">                File journalDirectory = new File(cmdLine.getOptionValue(&quot;dir&quot;));</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                for (Journal j : getJournals()) {</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">                    if (j.getJournalDirectory().equals(journalDirectory)) {</span>
<span class="nc" id="L1132">                        journal = j;</span>
<span class="nc" id="L1133">                        break;</span>
                    }
<span class="nc" id="L1135">                }</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">                if (journal == null) {</span>
<span class="nc" id="L1138">                    System.err.println(&quot;ERROR: journal directory not found&quot;);</span>
<span class="nc" id="L1139">                    printUsage();</span>
<span class="nc" id="L1140">                    return -1;</span>
                }
<span class="nc" id="L1142">            } else {</span>
<span class="nc" id="L1143">                journal = getJournals().get(0);</span>
            }

            long journalId;
            try {
<span class="nc" id="L1148">                journalId = Long.parseLong(leftArgs[0]);</span>
<span class="nc" id="L1149">            } catch (NumberFormatException nfe) {</span>
                // not a journal id
<span class="nc" id="L1151">                File f = new File(leftArgs[0]);</span>
<span class="nc" id="L1152">                String name = f.getName();</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">                if (!name.endsWith(&quot;.txn&quot;)) {</span>
                    // not a journal file
<span class="nc" id="L1155">                    System.err.println(&quot;ERROR: invalid journal file name &quot; + leftArgs[0]);</span>
<span class="nc" id="L1156">                    printUsage();</span>
<span class="nc" id="L1157">                    return -1;</span>
                }
<span class="nc" id="L1159">                String idString = name.split(&quot;\\.&quot;)[0];</span>
<span class="nc" id="L1160">                journalId = Long.parseLong(idString, 16);</span>
<span class="nc" id="L1161">            }</span>
            // scan journal
<span class="nc" id="L1163">            scanJournal(journal, journalId, printMsg);</span>
<span class="nc" id="L1164">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1169">            return &quot;Scan a journal file and format the entries into readable format.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1174">            return &quot;readjournal [-dir] [-msg] &lt;journal_id | journal_file_name&gt;&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1179">            return rjOpts;</span>
        }
    }

    /**
     * Command to print last log mark.
     */
    class LastMarkCmd extends MyCommand {
<span class="nc" id="L1187">        LastMarkCmd() {</span>
<span class="nc" id="L1188">            super(CMD_LASTMARK);</span>
<span class="nc" id="L1189">        }</span>

        @Override
        public int runCmd(CommandLine c) throws Exception {
<span class="nc" id="L1193">            printLastLogMark();</span>
<span class="nc" id="L1194">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1199">            return &quot;Print last log marker.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1204">            return &quot;lastmark&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1209">            return new Options();</span>
        }
    }

    /**
     * List available bookies.
     */
    class ListBookiesCmd extends MyCommand {
<span class="nc" id="L1217">        Options opts = new Options();</span>

<span class="nc" id="L1219">        ListBookiesCmd() {</span>
<span class="nc" id="L1220">            super(CMD_LISTBOOKIES);</span>
<span class="nc" id="L1221">            opts.addOption(&quot;rw&quot;, &quot;readwrite&quot;, false, &quot;Print readwrite bookies&quot;);</span>
<span class="nc" id="L1222">            opts.addOption(&quot;ro&quot;, &quot;readonly&quot;, false, &quot;Print readonly bookies&quot;);</span>
<span class="nc" id="L1223">            opts.addOption(&quot;h&quot;, &quot;hostnames&quot;, false,</span>
                    &quot;Also print hostname of the bookie&quot;);
<span class="nc" id="L1225">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1229">            boolean readwrite = cmdLine.hasOption(&quot;rw&quot;);</span>
<span class="nc" id="L1230">            boolean readonly = cmdLine.hasOption(&quot;ro&quot;);</span>

<span class="nc bnc" id="L1232" title="All 8 branches missed.">            if ((!readwrite &amp;&amp; !readonly) || (readwrite &amp;&amp; readonly)) {</span>
<span class="nc" id="L1233">                LOG.error(&quot;One and only one of -readwrite and -readonly must be specified&quot;);</span>
<span class="nc" id="L1234">                printUsage();</span>
<span class="nc" id="L1235">                return 1;</span>
            }
<span class="nc" id="L1237">            ClientConfiguration clientconf = new ClientConfiguration(bkConf)</span>
<span class="nc" id="L1238">                .setZkServers(bkConf.getZkServers());</span>
<span class="nc" id="L1239">            BookKeeperAdmin bka = new BookKeeperAdmin(clientconf);</span>

<span class="nc" id="L1241">            int count = 0;</span>
<span class="nc" id="L1242">            Collection&lt;BookieSocketAddress&gt; bookies = new ArrayList&lt;BookieSocketAddress&gt;();</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (cmdLine.hasOption(&quot;rw&quot;)) {</span>
<span class="nc" id="L1244">                Collection&lt;BookieSocketAddress&gt; availableBookies = bka</span>
<span class="nc" id="L1245">                        .getAvailableBookies();</span>
<span class="nc" id="L1246">                bookies.addAll(availableBookies);</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">            } else if (cmdLine.hasOption(&quot;ro&quot;)) {</span>
<span class="nc" id="L1248">                Collection&lt;BookieSocketAddress&gt; roBookies = bka</span>
<span class="nc" id="L1249">                        .getReadOnlyBookies();</span>
<span class="nc" id="L1250">                bookies.addAll(roBookies);</span>
            }
<span class="nc bnc" id="L1252" title="All 2 branches missed.">            for (BookieSocketAddress b : bookies) {</span>
<span class="nc" id="L1253">                System.out.print(b);</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                if (cmdLine.hasOption(&quot;h&quot;)) {</span>
<span class="nc" id="L1255">                    System.out.print(&quot;\t&quot; + b.getSocketAddress().getHostName());</span>
                }
<span class="nc" id="L1257">                System.out.println(&quot;&quot;);</span>
<span class="nc" id="L1258">                count++;</span>
<span class="nc" id="L1259">            }</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">            if (count == 0) {</span>
<span class="nc" id="L1261">                System.err.println(&quot;No bookie exists!&quot;);</span>
<span class="nc" id="L1262">                return 1;</span>
            }
<span class="nc" id="L1264">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1269">            return &quot;List the bookies, which are running as either readwrite or readonly mode.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1274">            return &quot;listbookies  [-readwrite|-readonly] [-hostnames]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1279">            return opts;</span>
        }
    }

    class ListDiskFilesCmd extends MyCommand {
<span class="nc" id="L1284">        Options opts = new Options();</span>

<span class="nc" id="L1286">        ListDiskFilesCmd() {</span>
<span class="nc" id="L1287">            super(CMD_LISTFILESONDISC);</span>
<span class="nc" id="L1288">            opts.addOption(&quot;txn&quot;, &quot;journal&quot;, false, &quot;Print list of Journal Files&quot;);</span>
<span class="nc" id="L1289">            opts.addOption(&quot;log&quot;, &quot;entrylog&quot;, false, &quot;Print list of EntryLog Files&quot;);</span>
<span class="nc" id="L1290">            opts.addOption(&quot;idx&quot;, &quot;index&quot;, false, &quot;Print list of Index files&quot;);</span>
<span class="nc" id="L1291">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {

<span class="nc" id="L1296">            boolean journal = cmdLine.hasOption(&quot;txn&quot;);</span>
<span class="nc" id="L1297">            boolean entrylog = cmdLine.hasOption(&quot;log&quot;);</span>
<span class="nc" id="L1298">            boolean index = cmdLine.hasOption(&quot;idx&quot;);</span>
<span class="nc" id="L1299">            boolean all = false;</span>

<span class="nc bnc" id="L1301" title="All 8 branches missed.">            if (!journal &amp;&amp; !entrylog &amp;&amp; !index &amp;&amp; !all) {</span>
<span class="nc" id="L1302">                all = true;</span>
            }

<span class="nc bnc" id="L1305" title="All 4 branches missed.">            if (all || journal) {</span>
<span class="nc" id="L1306">                File[] journalDirs = bkConf.getJournalDirs();</span>
<span class="nc" id="L1307">                List&lt;File&gt; journalFiles = listFilesAndSort(journalDirs, &quot;txn&quot;);</span>
<span class="nc" id="L1308">                System.out.println(&quot;--------- Printing the list of Journal Files ---------&quot;);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">                for (File journalFile : journalFiles) {</span>
<span class="nc" id="L1310">                    System.out.println(journalFile.getName());</span>
<span class="nc" id="L1311">                }</span>
<span class="nc" id="L1312">                System.out.println();</span>
            }
<span class="nc bnc" id="L1314" title="All 4 branches missed.">            if (all || entrylog) {</span>
<span class="nc" id="L1315">                File[] ledgerDirs = bkConf.getLedgerDirs();</span>
<span class="nc" id="L1316">                List&lt;File&gt; ledgerFiles = listFilesAndSort(ledgerDirs, &quot;log&quot;);</span>
<span class="nc" id="L1317">                System.out.println(&quot;--------- Printing the list of EntryLog/Ledger Files ---------&quot;);</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                for (File ledgerFile : ledgerFiles) {</span>
<span class="nc" id="L1319">                    System.out.println(ledgerFile.getName());</span>
<span class="nc" id="L1320">                }</span>
<span class="nc" id="L1321">                System.out.println();</span>
            }
<span class="nc bnc" id="L1323" title="All 4 branches missed.">            if (all || index) {</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">                File[] indexDirs = (bkConf.getIndexDirs() == null) ? bkConf.getLedgerDirs() : bkConf.getIndexDirs();</span>
<span class="nc" id="L1325">                List&lt;File&gt; indexFiles = listFilesAndSort(indexDirs, &quot;idx&quot;);</span>
<span class="nc" id="L1326">                System.out.println(&quot;--------- Printing the list of Index Files ---------&quot;);</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">                for (File indexFile : indexFiles) {</span>
<span class="nc" id="L1328">                    System.out.println(indexFile.getName());</span>
<span class="nc" id="L1329">                }</span>
            }
<span class="nc" id="L1331">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1336">            return &quot;List the files in JournalDirectory/LedgerDirectories/IndexDirectories.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1341">            return &quot;listfilesondisc  [-journal|-entrylog|-index]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1346">            return opts;</span>
        }
    }


    /**
     * Command to print help message.
     */
    class HelpCmd extends MyCommand {
<span class="nc" id="L1355">        HelpCmd() {</span>
<span class="nc" id="L1356">            super(CMD_HELP);</span>
<span class="nc" id="L1357">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1361">            String[] args = cmdLine.getArgs();</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">            if (args.length == 0) {</span>
<span class="nc" id="L1363">                printShellUsage();</span>
<span class="nc" id="L1364">                return 0;</span>
            }
<span class="nc" id="L1366">            String cmdName = args[0];</span>
<span class="nc" id="L1367">            Command cmd = commands.get(cmdName);</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">            if (null == cmd) {</span>
<span class="nc" id="L1369">                System.err.println(&quot;Unknown command &quot; + cmdName);</span>
<span class="nc" id="L1370">                printShellUsage();</span>
<span class="nc" id="L1371">                return -1;</span>
            }
<span class="nc" id="L1373">            cmd.printUsage();</span>
<span class="nc" id="L1374">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1379">            return &quot;Describe the usage of this program or its subcommands.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1384">            return &quot;help         [COMMAND]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1389">            return new Options();</span>
        }
    }

    /**
     * Command for administration of autorecovery.
     */
    class AutoRecoveryCmd extends MyCommand {
<span class="nc" id="L1397">        Options opts = new Options();</span>

<span class="nc" id="L1399">        public AutoRecoveryCmd() {</span>
<span class="nc" id="L1400">            super(CMD_AUTORECOVERY);</span>
<span class="nc" id="L1401">            opts.addOption(&quot;e&quot;, &quot;enable&quot;, false,</span>
                           &quot;Enable auto recovery of underreplicated ledgers&quot;);
<span class="nc" id="L1403">            opts.addOption(&quot;d&quot;, &quot;disable&quot;, false,</span>
                           &quot;Disable auto recovery of underreplicated ledgers&quot;);
<span class="nc" id="L1405">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1409">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1414">            return &quot;Enable or disable autorecovery in the cluster.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1419">            return &quot;autorecovery [-enable|-disable]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1424">            boolean disable = cmdLine.hasOption(&quot;d&quot;);</span>
<span class="nc" id="L1425">            boolean enable = cmdLine.hasOption(&quot;e&quot;);</span>

<span class="nc bnc" id="L1427" title="All 4 branches missed.">            if (enable &amp;&amp; disable) {</span>
<span class="nc" id="L1428">                LOG.error(&quot;Only one of -enable and -disable can be specified&quot;);</span>
<span class="nc" id="L1429">                printUsage();</span>
<span class="nc" id="L1430">                return 1;</span>
            }
<span class="nc" id="L1432">            ZooKeeper zk = null;</span>
            try {
<span class="nc" id="L1434">                zk = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L1435">                        .connectString(bkConf.getZkServers())</span>
<span class="nc" id="L1436">                        .sessionTimeoutMs(bkConf.getZkTimeout())</span>
<span class="nc" id="L1437">                        .build();</span>
<span class="nc" id="L1438">                LedgerManagerFactory mFactory = LedgerManagerFactory.newLedgerManagerFactory(bkConf, zk);</span>
<span class="nc" id="L1439">                LedgerUnderreplicationManager underreplicationManager = mFactory.newLedgerUnderreplicationManager();</span>
<span class="nc bnc" id="L1440" title="All 4 branches missed.">                if (!enable &amp;&amp; !disable) {</span>
<span class="nc" id="L1441">                    boolean enabled = underreplicationManager.isLedgerReplicationEnabled();</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">                    System.out.println(&quot;Autorecovery is &quot; + (enabled ? &quot;enabled.&quot; : &quot;disabled.&quot;));</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">                } else if (enable) {</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                    if (underreplicationManager.isLedgerReplicationEnabled()) {</span>
<span class="nc" id="L1445">                        LOG.warn(&quot;Autorecovery already enabled. Doing nothing&quot;);</span>
                    } else {
<span class="nc" id="L1447">                        LOG.info(&quot;Enabling autorecovery&quot;);</span>
<span class="nc" id="L1448">                        underreplicationManager.enableLedgerReplication();</span>
                    }
                } else {
<span class="nc bnc" id="L1451" title="All 2 branches missed.">                    if (!underreplicationManager.isLedgerReplicationEnabled()) {</span>
<span class="nc" id="L1452">                        LOG.warn(&quot;Autorecovery already disabled. Doing nothing&quot;);</span>
                    } else {
<span class="nc" id="L1454">                        LOG.info(&quot;Disabling autorecovery&quot;);</span>
<span class="nc" id="L1455">                        underreplicationManager.disableLedgerReplication();</span>
                    }
                }
            } finally {
<span class="nc bnc" id="L1459" title="All 2 branches missed.">                if (zk != null) {</span>
<span class="nc" id="L1460">                    zk.close();</span>
                }
            }

<span class="nc" id="L1464">            return 0;</span>
        }
    }

    /**
     * Setter and Getter for LostBookieRecoveryDelay value (in seconds) in Zookeeper.
     */
    class LostBookieRecoveryDelayCmd extends MyCommand {
<span class="nc" id="L1472">        Options opts = new Options();</span>

<span class="nc" id="L1474">        public LostBookieRecoveryDelayCmd() {</span>
<span class="nc" id="L1475">            super(CMD_LOSTBOOKIERECOVERYDELAY);</span>
<span class="nc" id="L1476">            opts.addOption(&quot;g&quot;, &quot;get&quot;, false, &quot;Get LostBookieRecoveryDelay value (in seconds)&quot;);</span>
<span class="nc" id="L1477">            opts.addOption(&quot;s&quot;, &quot;set&quot;, true, &quot;Set LostBookieRecoveryDelay value (in seconds)&quot;);</span>
<span class="nc" id="L1478">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1482">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1487">            return &quot;Setter and Getter for LostBookieRecoveryDelay value (in seconds) in Zookeeper.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1492">            return &quot;lostbookierecoverydelay [-get|-set &lt;value&gt;]&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1497">            boolean getter = cmdLine.hasOption(&quot;g&quot;);</span>
<span class="nc" id="L1498">            boolean setter = cmdLine.hasOption(&quot;s&quot;);</span>

<span class="nc bnc" id="L1500" title="All 8 branches missed.">            if ((!getter &amp;&amp; !setter) || (getter &amp;&amp; setter)) {</span>
<span class="nc" id="L1501">                LOG.error(&quot;One and only one of -get and -set must be specified&quot;);</span>
<span class="nc" id="L1502">                printUsage();</span>
<span class="nc" id="L1503">                return 1;</span>
            }
<span class="nc" id="L1505">            ClientConfiguration adminConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L1506">            BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);</span>
            try {
<span class="nc bnc" id="L1508" title="All 2 branches missed.">                if (getter) {</span>
<span class="nc" id="L1509">                    int lostBookieRecoveryDelay = admin.getLostBookieRecoveryDelay();</span>
<span class="nc" id="L1510">                    LOG.info(&quot;LostBookieRecoveryDelay value in ZK: {}&quot;, String.valueOf(lostBookieRecoveryDelay));</span>
<span class="nc" id="L1511">                } else {</span>
<span class="nc" id="L1512">                    int lostBookieRecoveryDelay = Integer.parseInt(cmdLine.getOptionValue(&quot;set&quot;));</span>
<span class="nc" id="L1513">                    admin.setLostBookieRecoveryDelay(lostBookieRecoveryDelay);</span>
<span class="nc" id="L1514">                    LOG.info(&quot;Successfully set LostBookieRecoveryDelay value in ZK: {}&quot;,</span>
<span class="nc" id="L1515">                            String.valueOf(lostBookieRecoveryDelay));</span>
                }
            } finally {
<span class="nc bnc" id="L1518" title="All 2 branches missed.">                if (admin != null) {</span>
<span class="nc" id="L1519">                    admin.close();</span>
                }
            }
<span class="nc" id="L1522">            return 0;</span>
        }
    }


    /**
     * Print which node has the auditor lock.
     */
    class WhoIsAuditorCmd extends MyCommand {
<span class="nc" id="L1531">        Options opts = new Options();</span>

<span class="nc" id="L1533">        public WhoIsAuditorCmd() {</span>
<span class="nc" id="L1534">            super(CMD_WHOISAUDITOR);</span>
<span class="nc" id="L1535">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1539">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1544">            return &quot;Print the node which holds the auditor lock.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1549">            return &quot;whoisauditor&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1554">            ZooKeeper zk = null;</span>
            try {
<span class="nc" id="L1556">                zk = ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L1557">                        .connectString(bkConf.getZkServers())</span>
<span class="nc" id="L1558">                        .sessionTimeoutMs(bkConf.getZkTimeout())</span>
<span class="nc" id="L1559">                        .build();</span>
<span class="nc" id="L1560">                BookieSocketAddress bookieId = AuditorElector.getCurrentAuditor(bkConf, zk);</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">                if (bookieId == null) {</span>
<span class="nc" id="L1562">                    LOG.info(&quot;No auditor elected&quot;);</span>
<span class="nc" id="L1563">                    return -1;</span>
                }
<span class="nc" id="L1565">                LOG.info(&quot;Auditor: {}/{}:{}&quot;,</span>
                         new Object[] {
<span class="nc" id="L1567">                             bookieId.getSocketAddress().getAddress().getCanonicalHostName(),</span>
<span class="nc" id="L1568">                             bookieId.getSocketAddress().getAddress().getHostAddress(),</span>
<span class="nc" id="L1569">                             bookieId.getSocketAddress().getPort() });</span>
            } finally {
<span class="nc bnc" id="L1571" title="All 2 branches missed.">                if (zk != null) {</span>
<span class="nc" id="L1572">                    zk.close();</span>
                }
            }

<span class="nc" id="L1576">            return 0;</span>
        }
    }

    /**
     * Update cookie command.
     */
    class UpdateCookieCmd extends MyCommand {
<span class="nc" id="L1584">        Options opts = new Options();</span>

<span class="nc" id="L1586">        UpdateCookieCmd() {</span>
<span class="nc" id="L1587">            super(CMD_UPDATECOOKIE);</span>
<span class="nc" id="L1588">            opts.addOption(&quot;b&quot;, &quot;bookieId&quot;, true, &quot;Bookie Id&quot;);</span>
<span class="nc" id="L1589">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1593">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1598">            return &quot;Update bookie id in cookie.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1603">            return &quot;updatecookie -bookieId &lt;hostname|ip&gt;&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1608">            final String bookieId = cmdLine.getOptionValue(&quot;bookieId&quot;);</span>
<span class="nc bnc" id="L1609" title="All 2 branches missed.">            if (StringUtils.isBlank(bookieId)) {</span>
<span class="nc" id="L1610">                LOG.error(&quot;Invalid argument list!&quot;);</span>
<span class="nc" id="L1611">                this.printUsage();</span>
<span class="nc" id="L1612">                return -1;</span>
            }
<span class="nc bnc" id="L1614" title="All 4 branches missed.">            if (!StringUtils.equals(bookieId, &quot;hostname&quot;) &amp;&amp; !StringUtils.equals(bookieId, &quot;ip&quot;)) {</span>
<span class="nc" id="L1615">                LOG.error(&quot;Invalid option value:&quot; + bookieId);</span>
<span class="nc" id="L1616">                this.printUsage();</span>
<span class="nc" id="L1617">                return -1;</span>
            }
<span class="nc" id="L1619">            boolean useHostName = getOptionalValue(bookieId, &quot;hostname&quot;);</span>
<span class="nc bnc" id="L1620" title="All 4 branches missed.">            if (!bkConf.getUseHostNameAsBookieID() &amp;&amp; useHostName) {</span>
<span class="nc" id="L1621">                LOG.error(&quot;Expects configuration useHostNameAsBookieID=true as the option value passed is 'hostname'&quot;);</span>
<span class="nc" id="L1622">                return -1;</span>
<span class="nc bnc" id="L1623" title="All 4 branches missed.">            } else if (bkConf.getUseHostNameAsBookieID() &amp;&amp; !useHostName) {</span>
<span class="nc" id="L1624">                LOG.error(&quot;Expects configuration useHostNameAsBookieID=false as the option value passed is 'ip'&quot;);</span>
<span class="nc" id="L1625">                return -1;</span>
            }
<span class="nc" id="L1627">            return updateBookieIdInCookie(bookieId, useHostName);</span>
        }

        private int updateBookieIdInCookie(final String bookieId, final boolean useHostname) throws BookieException,
                InterruptedException {
<span class="nc" id="L1632">            RegistrationManager rm = new ZKRegistrationManager();</span>
            try {
<span class="nc" id="L1634">                rm.initialize(bkConf, () -&gt; {}, NullStatsLogger.INSTANCE);</span>
<span class="nc" id="L1635">                ServerConfiguration conf = new ServerConfiguration(bkConf);</span>
<span class="nc" id="L1636">                String newBookieId = Bookie.getBookieAddress(conf).toString();</span>
                // read oldcookie
<span class="nc" id="L1638">                Versioned&lt;Cookie&gt; oldCookie = null;</span>
                try {
<span class="nc bnc" id="L1640" title="All 2 branches missed.">                    conf.setUseHostNameAsBookieID(!useHostname);</span>
<span class="nc" id="L1641">                    oldCookie = Cookie.readFromRegistrationManager(rm, conf);</span>
<span class="nc" id="L1642">                } catch (CookieNotFoundException nne) {</span>
<span class="nc" id="L1643">                    LOG.error(&quot;Either cookie already updated with UseHostNameAsBookieID={} or no cookie exists!&quot;,</span>
<span class="nc" id="L1644">                            useHostname, nne);</span>
<span class="nc" id="L1645">                    return -1;</span>
<span class="nc" id="L1646">                }</span>
<span class="nc" id="L1647">                Cookie newCookie = Cookie.newBuilder(oldCookie.getValue()).setBookieHost(newBookieId).build();</span>
<span class="nc" id="L1648">                boolean hasCookieUpdatedInDirs = verifyCookie(newCookie, journalDirectories[0]);</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">                for (File dir : ledgerDirectories) {</span>
<span class="nc" id="L1650">                    hasCookieUpdatedInDirs &amp;= verifyCookie(newCookie, dir);</span>
                }
<span class="nc bnc" id="L1652" title="All 2 branches missed.">                if (indexDirectories != ledgerDirectories) {</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                    for (File dir : indexDirectories) {</span>
<span class="nc" id="L1654">                        hasCookieUpdatedInDirs &amp;= verifyCookie(newCookie, dir);</span>
                    }
                }

<span class="nc bnc" id="L1658" title="All 2 branches missed.">                if (hasCookieUpdatedInDirs) {</span>
                    try {
<span class="nc" id="L1660">                        conf.setUseHostNameAsBookieID(useHostname);</span>
<span class="nc" id="L1661">                        Cookie.readFromRegistrationManager(rm, conf);</span>
                        // since newcookie exists, just do cleanup of oldcookie and return
<span class="nc bnc" id="L1663" title="All 2 branches missed.">                        conf.setUseHostNameAsBookieID(!useHostname);</span>
<span class="nc" id="L1664">                        oldCookie.getValue().deleteFromRegistrationManager(rm, conf, oldCookie.getVersion());</span>
<span class="nc" id="L1665">                        return 0;</span>
<span class="nc" id="L1666">                    } catch (CookieNotFoundException nne) {</span>
<span class="nc bnc" id="L1667" title="All 2 branches missed.">                        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L1668">                            LOG.debug(&quot;Ignoring, cookie will be written to zookeeper&quot;);</span>
                        }
<span class="nc" id="L1670">                    }</span>
                } else {
                    // writes newcookie to local dirs
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                    for (File journalDirectory : journalDirectories) {</span>
<span class="nc" id="L1674">                        newCookie.writeToDirectory(journalDirectory);</span>
<span class="nc" id="L1675">                        LOG.info(&quot;Updated cookie file present in journalDirectory {}&quot;, journalDirectory);</span>
                    }
<span class="nc bnc" id="L1677" title="All 2 branches missed.">                    for (File dir : ledgerDirectories) {</span>
<span class="nc" id="L1678">                        newCookie.writeToDirectory(dir);</span>
                    }
<span class="nc" id="L1680">                    LOG.info(&quot;Updated cookie file present in ledgerDirectories {}&quot;, ledgerDirectories);</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">                    if (ledgerDirectories != indexDirectories) {</span>
<span class="nc bnc" id="L1682" title="All 2 branches missed.">                        for (File dir : indexDirectories) {</span>
<span class="nc" id="L1683">                            newCookie.writeToDirectory(dir);</span>
                        }
<span class="nc" id="L1685">                        LOG.info(&quot;Updated cookie file present in indexDirectories {}&quot;, indexDirectories);</span>
                    }
                }
                // writes newcookie to zookeeper
<span class="nc" id="L1689">                conf.setUseHostNameAsBookieID(useHostname);</span>
<span class="nc" id="L1690">                newCookie.writeToRegistrationManager(rm, conf, Version.NEW);</span>

                // delete oldcookie
<span class="nc bnc" id="L1693" title="All 2 branches missed.">                conf.setUseHostNameAsBookieID(!useHostname);</span>
<span class="nc" id="L1694">                oldCookie.getValue().deleteFromRegistrationManager(rm, conf, oldCookie.getVersion());</span>
<span class="nc" id="L1695">            } catch (IOException ioe) {</span>
<span class="nc" id="L1696">                LOG.error(&quot;IOException during cookie updation!&quot;, ioe);</span>
<span class="nc" id="L1697">                return -1;</span>
            } finally {
<span class="nc bnc" id="L1699" title="All 2 branches missed.">                if (rm != null) {</span>
<span class="nc" id="L1700">                    rm.close();</span>
                }
            }
<span class="nc" id="L1703">            return 0;</span>
        }

        private boolean verifyCookie(Cookie oldCookie, File dir) throws IOException {
            try {
<span class="nc" id="L1708">                Cookie cookie = Cookie.readFromDirectory(dir);</span>
<span class="nc" id="L1709">                cookie.verify(oldCookie);</span>
<span class="nc" id="L1710">            } catch (InvalidCookieException e) {</span>
<span class="nc" id="L1711">                return false;</span>
<span class="nc" id="L1712">            }</span>
<span class="nc" id="L1713">            return true;</span>
        }
    }

    /**
     * Expand the storage directories owned by a bookie.
     */
    class ExpandStorageCmd extends MyCommand {
<span class="nc" id="L1721">        Options opts = new Options();</span>

<span class="nc" id="L1723">        ExpandStorageCmd() {</span>
<span class="nc" id="L1724">            super(CMD_EXPANDSTORAGE);</span>
<span class="nc" id="L1725">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1729">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1734">            return &quot;Add new empty ledger/index directories. Update the directories&quot;</span>
                   + &quot;info in the conf file before running the command.&quot;;
        }

        @Override
        String getUsage() {
<span class="nc" id="L1740">            return &quot;expandstorage&quot;;</span>
        }

        @Override
        int runCmd(CommandLine cmdLine) {
<span class="nc" id="L1745">            ServerConfiguration conf = new ServerConfiguration(bkConf);</span>
<span class="nc" id="L1746">            RegistrationManager rm = new ZKRegistrationManager();</span>
            try {
                try {
<span class="nc" id="L1749">                    rm.initialize(bkConf, () -&gt; {}, NullStatsLogger.INSTANCE);</span>
<span class="nc" id="L1750">                } catch (BookieException e) {</span>
<span class="nc" id="L1751">                    LOG.error(&quot;Exception while establishing zookeeper connection.&quot;, e);</span>
<span class="nc" id="L1752">                    return -1;</span>
<span class="nc" id="L1753">                }</span>

<span class="nc" id="L1755">                List&lt;File&gt; allLedgerDirs = Lists.newArrayList();</span>
<span class="nc" id="L1756">                allLedgerDirs.addAll(Arrays.asList(ledgerDirectories));</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">                if (indexDirectories != ledgerDirectories) {</span>
<span class="nc" id="L1758">                    allLedgerDirs.addAll(Arrays.asList(indexDirectories));</span>
                }

                try {
<span class="nc" id="L1762">                    conf.setAllowStorageExpansion(true);</span>
<span class="nc" id="L1763">                    Bookie.checkEnvironmentWithStorageExpansion(conf, rm,</span>
<span class="nc" id="L1764">                        Lists.newArrayList(journalDirectories), allLedgerDirs);</span>
<span class="nc" id="L1765">                } catch (BookieException e) {</span>
<span class="nc" id="L1766">                    LOG.error(</span>
                        &quot;Exception while updating cookie for storage expansion&quot;, e);
<span class="nc" id="L1768">                    return -1;</span>
<span class="nc" id="L1769">                }</span>
<span class="nc" id="L1770">                return 0;</span>
            } finally {
<span class="nc" id="L1772">                rm.close();</span>
            }
        }
    }

    /**
     * Update ledger command.
     */
    class UpdateLedgerCmd extends MyCommand {
<span class="nc" id="L1781">        private final Options opts = new Options();</span>

<span class="nc" id="L1783">        UpdateLedgerCmd() {</span>
<span class="nc" id="L1784">            super(CMD_UPDATELEDGER);</span>
<span class="nc" id="L1785">            opts.addOption(&quot;b&quot;, &quot;bookieId&quot;, true, &quot;Bookie Id&quot;);</span>
<span class="nc" id="L1786">            opts.addOption(&quot;s&quot;, &quot;updatespersec&quot;, true, &quot;Number of ledgers updating per second (default: 5 per sec)&quot;);</span>
<span class="nc" id="L1787">            opts.addOption(&quot;l&quot;, &quot;limit&quot;, true, &quot;Maximum number of ledgers to update (default: no limit)&quot;);</span>
<span class="nc" id="L1788">            opts.addOption(&quot;v&quot;, &quot;verbose&quot;, true, &quot;Print status of the ledger updation (default: false)&quot;);</span>
<span class="nc" id="L1789">            opts.addOption(&quot;p&quot;, &quot;printprogress&quot;, true,</span>
                    &quot;Print messages on every configured seconds if verbose turned on (default: 10 secs)&quot;);
<span class="nc" id="L1791">        }</span>

        @Override
        Options getOptions() {
<span class="nc" id="L1795">            return opts;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1800">            return &quot;Update bookie id in ledgers (this may take a long time).&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1805">            return &quot;updateledger -bookieId &lt;hostname|ip&gt; [-updatespersec N] [-limit N] [-verbose true/false] &quot;</span>
                   + &quot;[-printprogress N]&quot;;
        }

        @Override
        int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1811">            final String bookieId = cmdLine.getOptionValue(&quot;bookieId&quot;);</span>
<span class="nc bnc" id="L1812" title="All 2 branches missed.">            if (StringUtils.isBlank(bookieId)) {</span>
<span class="nc" id="L1813">                LOG.error(&quot;Invalid argument list!&quot;);</span>
<span class="nc" id="L1814">                this.printUsage();</span>
<span class="nc" id="L1815">                return -1;</span>
            }
<span class="nc bnc" id="L1817" title="All 4 branches missed.">            if (!StringUtils.equals(bookieId, &quot;hostname&quot;) &amp;&amp; !StringUtils.equals(bookieId, &quot;ip&quot;)) {</span>
<span class="nc" id="L1818">                LOG.error(&quot;Invalid option value {} for bookieId, expected hostname/ip&quot;, bookieId);</span>
<span class="nc" id="L1819">                this.printUsage();</span>
<span class="nc" id="L1820">                return -1;</span>
            }
<span class="nc" id="L1822">            boolean useHostName = getOptionalValue(bookieId, &quot;hostname&quot;);</span>
<span class="nc bnc" id="L1823" title="All 4 branches missed.">            if (!bkConf.getUseHostNameAsBookieID() &amp;&amp; useHostName) {</span>
<span class="nc" id="L1824">                LOG.error(&quot;Expects configuration useHostNameAsBookieID=true as the option value passed is 'hostname'&quot;);</span>
<span class="nc" id="L1825">                return -1;</span>
<span class="nc bnc" id="L1826" title="All 4 branches missed.">            } else if (bkConf.getUseHostNameAsBookieID() &amp;&amp; !useHostName) {</span>
<span class="nc" id="L1827">                LOG.error(&quot;Expects configuration useHostNameAsBookieID=false as the option value passed is 'ip'&quot;);</span>
<span class="nc" id="L1828">                return -1;</span>
            }
<span class="nc" id="L1830">            final int rate = getOptionIntValue(cmdLine, &quot;updatespersec&quot;, 5);</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">            if (rate &lt;= 0) {</span>
<span class="nc" id="L1832">                LOG.error(&quot;Invalid updatespersec {}, should be &gt; 0&quot;, rate);</span>
<span class="nc" id="L1833">                return -1;</span>
            }
<span class="nc" id="L1835">            final int limit = getOptionIntValue(cmdLine, &quot;limit&quot;, Integer.MIN_VALUE);</span>
<span class="nc bnc" id="L1836" title="All 4 branches missed.">            if (limit &lt;= 0 &amp;&amp; limit != Integer.MIN_VALUE) {</span>
<span class="nc" id="L1837">                LOG.error(&quot;Invalid limit {}, should be &gt; 0&quot;, limit);</span>
<span class="nc" id="L1838">                return -1;</span>
            }
<span class="nc" id="L1840">            final boolean verbose = getOptionBooleanValue(cmdLine, &quot;verbose&quot;, false);</span>
            final long printprogress;
<span class="nc bnc" id="L1842" title="All 2 branches missed.">            if (!verbose) {</span>
<span class="nc bnc" id="L1843" title="All 2 branches missed.">                if (cmdLine.hasOption(&quot;printprogress&quot;)) {</span>
<span class="nc" id="L1844">                    LOG.warn(&quot;Ignoring option 'printprogress', this is applicable when 'verbose' is true&quot;);</span>
                }
<span class="nc" id="L1846">                printprogress = Integer.MIN_VALUE;</span>
            } else {
                // defaulting to 10 seconds
<span class="nc" id="L1849">                printprogress = getOptionLongValue(cmdLine, &quot;printprogress&quot;, 10);</span>
            }
<span class="nc" id="L1851">            final ClientConfiguration conf = new ClientConfiguration();</span>
<span class="nc" id="L1852">            conf.addConfiguration(bkConf);</span>
<span class="nc" id="L1853">            final BookKeeper bk = new BookKeeper(conf);</span>
<span class="nc" id="L1854">            final BookKeeperAdmin admin = new BookKeeperAdmin(conf);</span>
<span class="nc" id="L1855">            final UpdateLedgerOp updateLedgerOp = new UpdateLedgerOp(bk, admin);</span>
<span class="nc" id="L1856">            final ServerConfiguration serverConf = new ServerConfiguration(bkConf);</span>
<span class="nc" id="L1857">            final BookieSocketAddress newBookieId = Bookie.getBookieAddress(serverConf);</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">            serverConf.setUseHostNameAsBookieID(!useHostName);</span>
<span class="nc" id="L1859">            final BookieSocketAddress oldBookieId = Bookie.getBookieAddress(serverConf);</span>

<span class="nc" id="L1861">            UpdateLedgerNotifier progressable = new UpdateLedgerNotifier() {</span>
<span class="nc" id="L1862">                long lastReport = System.nanoTime();</span>

                @Override
                public void progress(long updated, long issued) {
<span class="nc bnc" id="L1866" title="All 2 branches missed.">                    if (printprogress &lt;= 0) {</span>
<span class="nc" id="L1867">                        return; // disabled</span>
                    }
<span class="nc bnc" id="L1869" title="All 2 branches missed.">                    if (TimeUnit.MILLISECONDS.toSeconds(MathUtils.elapsedMSec(lastReport)) &gt;= printprogress) {</span>
<span class="nc" id="L1870">                        LOG.info(&quot;Number of ledgers issued={}, updated={}&quot;, issued, updated);</span>
<span class="nc" id="L1871">                        lastReport = MathUtils.nowInNano();</span>
                    }
<span class="nc" id="L1873">                }</span>
            };
            try {
<span class="nc" id="L1876">                updateLedgerOp.updateBookieIdInLedgers(oldBookieId, newBookieId, rate, limit, progressable);</span>
<span class="nc" id="L1877">            } catch (BKException | IOException e) {</span>
<span class="nc" id="L1878">                LOG.error(&quot;Failed to update ledger metadata&quot;, e);</span>
<span class="nc" id="L1879">                return -1;</span>
<span class="nc" id="L1880">            }</span>
<span class="nc" id="L1881">            return 0;</span>
        }

    }

    /**
     * Command to delete a given ledger.
     */
    class DeleteLedgerCmd extends MyCommand {
<span class="nc" id="L1890">        Options lOpts = new Options();</span>

<span class="nc" id="L1892">        DeleteLedgerCmd() {</span>
<span class="nc" id="L1893">            super(CMD_DELETELEDGER);</span>
<span class="nc" id="L1894">            lOpts.addOption(&quot;l&quot;, &quot;ledgerid&quot;, true, &quot;Ledger ID&quot;);</span>
<span class="nc" id="L1895">            lOpts.addOption(&quot;f&quot;, &quot;force&quot;, false, &quot;Whether to force delete the Ledger without prompt..?&quot;);</span>
<span class="nc" id="L1896">        }</span>

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1900">            final String lidStr = cmdLine.getOptionValue(&quot;ledgerid&quot;);</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">            if (StringUtils.isBlank(lidStr)) {</span>
<span class="nc" id="L1902">                LOG.error(&quot;Invalid argument list!&quot;);</span>
<span class="nc" id="L1903">                this.printUsage();</span>
<span class="nc" id="L1904">                return -1;</span>
            }

            final long lid;
            try {
<span class="nc" id="L1909">                lid = Long.parseLong(lidStr);</span>
<span class="nc" id="L1910">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1911">                System.err.println(&quot;ERROR: invalid ledger id &quot; + lidStr);</span>
<span class="nc" id="L1912">                printUsage();</span>
<span class="nc" id="L1913">                return -1;</span>
<span class="nc" id="L1914">            }</span>

<span class="nc" id="L1916">            boolean force = cmdLine.hasOption(&quot;f&quot;);</span>
<span class="nc" id="L1917">            boolean confirm = false;</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">            if (!force) {</span>
<span class="nc" id="L1919">                confirm = IOUtils.confirmPrompt(&quot;Are you sure to delete Ledger : &quot; + lid + &quot;?&quot;);</span>
            }

<span class="nc" id="L1922">            BookKeeper bk = null;</span>
            try {
<span class="nc bnc" id="L1924" title="All 4 branches missed.">                if (force || confirm) {</span>
<span class="nc" id="L1925">                    ClientConfiguration conf = new ClientConfiguration();</span>
<span class="nc" id="L1926">                    conf.addConfiguration(bkConf);</span>
<span class="nc" id="L1927">                    bk = new BookKeeper(conf);</span>
<span class="nc" id="L1928">                    bk.deleteLedger(lid);</span>
                }
            } finally {
<span class="nc bnc" id="L1931" title="All 2 branches missed.">                if (bk != null) {</span>
<span class="nc" id="L1932">                    bk.close();</span>
                }
            }

<span class="nc" id="L1936">            return 0;</span>
        }

        @Override
        String getDescription() {
<span class="nc" id="L1941">            return &quot;Delete a ledger.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1946">            return &quot;deleteledger -ledgerid &lt;ledgerid&gt; [-force]&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1951">            return lOpts;</span>
        }
    }

    /*
     * Command to retrieve bookie information like free disk space, etc from all
     * the bookies in the cluster.
     */
    class BookieInfoCmd extends MyCommand {
<span class="nc" id="L1960">        Options lOpts = new Options();</span>

<span class="nc" id="L1962">        BookieInfoCmd() {</span>
<span class="nc" id="L1963">            super(CMD_BOOKIEINFO);</span>
<span class="nc" id="L1964">        }</span>

        @Override
        String getDescription() {
<span class="nc" id="L1968">            return &quot;Retrieve bookie info such as free and total disk space.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L1973">            return &quot;bookieinfo&quot;;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L1978">            return lOpts;</span>
        }

        String getReadable(long val) {
<span class="nc" id="L1982">            String unit[] = {&quot;&quot;, &quot;KB&quot;, &quot;MB&quot;, &quot;GB&quot;, &quot;TB&quot; };</span>
<span class="nc" id="L1983">            int cnt = 0;</span>
<span class="nc" id="L1984">            double d = val;</span>
<span class="nc bnc" id="L1985" title="All 4 branches missed.">            while (d &gt;= 1000 &amp;&amp; cnt &lt; unit.length - 1) {</span>
<span class="nc" id="L1986">                d = d / 1000;</span>
<span class="nc" id="L1987">                cnt++;</span>
            }
<span class="nc" id="L1989">            DecimalFormat df = new DecimalFormat(&quot;#.###&quot;);</span>
<span class="nc" id="L1990">            df.setRoundingMode(RoundingMode.DOWN);</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">            return cnt &gt; 0 ? &quot;(&quot; + df.format(d) + unit[cnt] + &quot;)&quot; : unit[cnt];</span>
        }

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L1996">            ClientConfiguration clientConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L1997">            clientConf.setDiskWeightBasedPlacementEnabled(true);</span>
<span class="nc" id="L1998">            BookKeeper bk = new BookKeeper(clientConf);</span>

<span class="nc" id="L2000">            Map&lt;BookieSocketAddress, BookieInfo&gt; map = bk.getBookieInfo();</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">            if (map.size() == 0) {</span>
<span class="nc" id="L2002">                System.out.println(&quot;Failed to retrieve bookie information from any of the bookies&quot;);</span>
<span class="nc" id="L2003">                bk.close();</span>
<span class="nc" id="L2004">                return 0;</span>
            }

<span class="nc" id="L2007">            System.out.println(&quot;Free disk space info:&quot;);</span>
<span class="nc" id="L2008">            long totalFree = 0, total = 0;</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">            for (Map.Entry&lt;BookieSocketAddress, BookieInfo&gt; e : map.entrySet()) {</span>
<span class="nc" id="L2010">                BookieInfo bInfo = e.getValue();</span>
<span class="nc" id="L2011">                System.out.println(e.getKey() + &quot;:\tFree: &quot; + bInfo.getFreeDiskSpace()</span>
<span class="nc" id="L2012">                        + getReadable(bInfo.getFreeDiskSpace()) + &quot;\tTotal: &quot; + bInfo.getTotalDiskSpace()</span>
<span class="nc" id="L2013">                        + getReadable(bInfo.getTotalDiskSpace()));</span>
<span class="nc" id="L2014">                totalFree += bInfo.getFreeDiskSpace();</span>
<span class="nc" id="L2015">                total += bInfo.getTotalDiskSpace();</span>
<span class="nc" id="L2016">            }</span>
<span class="nc" id="L2017">            System.out.println(&quot;Total free disk space in the cluster:\t&quot; + totalFree + getReadable(totalFree));</span>
<span class="nc" id="L2018">            System.out.println(&quot;Total disk capacity in the cluster:\t&quot; + total + getReadable(total));</span>
<span class="nc" id="L2019">            bk.close();</span>
<span class="nc" id="L2020">            return 0;</span>
        }
    }

    /**
     * Command to trigger AuditTask by resetting lostBookieRecoveryDelay to its current value.
     */
    class TriggerAuditCmd extends MyCommand {
<span class="nc" id="L2028">        Options opts = new Options();</span>

<span class="nc" id="L2030">        TriggerAuditCmd() {</span>
<span class="nc" id="L2031">            super(CMD_TRIGGERAUDIT);</span>
<span class="nc" id="L2032">        }</span>

        @Override
        String getDescription() {
<span class="nc" id="L2036">            return &quot;Force trigger the Audit by resetting the lostBookieRecoveryDelay.&quot;;</span>
        }

        @Override
        String getUsage() {
<span class="nc" id="L2041">            return CMD_TRIGGERAUDIT;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L2046">            return opts;</span>
        }

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L2051">            ClientConfiguration adminConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L2052">            BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);</span>
            try {
<span class="nc" id="L2054">                admin.triggerAudit();</span>
            } finally {
<span class="nc bnc" id="L2056" title="All 2 branches missed.">                if (admin != null) {</span>
<span class="nc" id="L2057">                    admin.close();</span>
                }
            }
<span class="nc" id="L2060">            return 0;</span>
        }
    }

    /**
     * Command to trigger AuditTask by resetting lostBookieRecoveryDelay and then make sure the
     * ledgers stored in the bookie are properly replicated.
     */
    class DecommissionBookieCmd extends MyCommand {
<span class="nc" id="L2069">        Options lOpts = new Options();</span>

<span class="nc" id="L2071">        DecommissionBookieCmd() {</span>
<span class="nc" id="L2072">            super(CMD_DECOMMISSIONBOOKIE);</span>
<span class="nc" id="L2073">        }</span>

        @Override
        String getDescription() {
<span class="nc" id="L2077">            return &quot;Force trigger the Audittask and make sure all the ledgers stored in the decommissioning bookie&quot;</span>
                + &quot; are replicated.&quot;;
        }

        @Override
        String getUsage() {
<span class="nc" id="L2083">            return CMD_DECOMMISSIONBOOKIE;</span>
        }

        @Override
        Options getOptions() {
<span class="nc" id="L2088">            return lOpts;</span>
        }

        @Override
        public int runCmd(CommandLine cmdLine) throws Exception {
<span class="nc" id="L2093">            ClientConfiguration adminConf = new ClientConfiguration(bkConf);</span>
<span class="nc" id="L2094">            BookKeeperAdmin admin = new BookKeeperAdmin(adminConf);</span>
            try {
<span class="nc" id="L2096">                BookieSocketAddress thisBookieAddress = Bookie.getBookieAddress(bkConf);</span>
<span class="nc" id="L2097">                admin.decommissionBookie(thisBookieAddress);</span>
<span class="nc" id="L2098">                return 0;</span>
<span class="nc" id="L2099">            } catch (Exception e) {</span>
<span class="nc" id="L2100">                LOG.error(&quot;Received exception in DecommissionBookieCmd &quot;, e);</span>
<span class="nc" id="L2101">                return -1;</span>
            } finally {
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                if (admin != null) {</span>
<span class="nc" id="L2104">                    admin.close();</span>
                }
            }
        }
    }

    /**
     * A facility for reporting update ledger progress.
     */
    public interface UpdateLedgerNotifier {
        void progress(long updated, long issued);
    }

<span class="nc" id="L2117">    final Map&lt;String, MyCommand&gt; commands = new HashMap&lt;String, MyCommand&gt;();</span>
    {
<span class="nc" id="L2119">        commands.put(CMD_METAFORMAT, new MetaFormatCmd());</span>
<span class="nc" id="L2120">        commands.put(CMD_BOOKIEFORMAT, new BookieFormatCmd());</span>
<span class="nc" id="L2121">        commands.put(CMD_RECOVER, new RecoverCmd());</span>
<span class="nc" id="L2122">        commands.put(CMD_LEDGER, new LedgerCmd());</span>
<span class="nc" id="L2123">        commands.put(CMD_READ_LEDGER_ENTRIES, new ReadLedgerEntriesCmd());</span>
<span class="nc" id="L2124">        commands.put(CMD_LISTLEDGERS, new ListLedgersCmd());</span>
<span class="nc" id="L2125">        commands.put(CMD_LISTUNDERREPLICATED, new ListUnderreplicatedCmd());</span>
<span class="nc" id="L2126">        commands.put(CMD_WHOISAUDITOR, new WhoIsAuditorCmd());</span>
<span class="nc" id="L2127">        commands.put(CMD_LEDGERMETADATA, new LedgerMetadataCmd());</span>
<span class="nc" id="L2128">        commands.put(CMD_SIMPLETEST, new SimpleTestCmd());</span>
<span class="nc" id="L2129">        commands.put(CMD_BOOKIESANITYTEST, new BookieSanityTestCmd());</span>
<span class="nc" id="L2130">        commands.put(CMD_READLOG, new ReadLogCmd());</span>
<span class="nc" id="L2131">        commands.put(CMD_READJOURNAL, new ReadJournalCmd());</span>
<span class="nc" id="L2132">        commands.put(CMD_LASTMARK, new LastMarkCmd());</span>
<span class="nc" id="L2133">        commands.put(CMD_AUTORECOVERY, new AutoRecoveryCmd());</span>
<span class="nc" id="L2134">        commands.put(CMD_LISTBOOKIES, new ListBookiesCmd());</span>
<span class="nc" id="L2135">        commands.put(CMD_LISTFILESONDISC, new ListDiskFilesCmd());</span>
<span class="nc" id="L2136">        commands.put(CMD_UPDATECOOKIE, new UpdateCookieCmd());</span>
<span class="nc" id="L2137">        commands.put(CMD_EXPANDSTORAGE, new ExpandStorageCmd());</span>
<span class="nc" id="L2138">        commands.put(CMD_UPDATELEDGER, new UpdateLedgerCmd());</span>
<span class="nc" id="L2139">        commands.put(CMD_DELETELEDGER, new DeleteLedgerCmd());</span>
<span class="nc" id="L2140">        commands.put(CMD_BOOKIEINFO, new BookieInfoCmd());</span>
<span class="nc" id="L2141">        commands.put(CMD_DECOMMISSIONBOOKIE, new DecommissionBookieCmd());</span>
<span class="nc" id="L2142">        commands.put(CMD_HELP, new HelpCmd());</span>
<span class="nc" id="L2143">        commands.put(CMD_LOSTBOOKIERECOVERYDELAY, new LostBookieRecoveryDelayCmd());</span>
<span class="nc" id="L2144">        commands.put(CMD_TRIGGERAUDIT, new TriggerAuditCmd());</span>
<span class="nc" id="L2145">    }</span>

    @Override
    public void setConf(CompositeConfiguration conf) throws Exception {
<span class="nc" id="L2149">        bkConf.loadConf(conf);</span>
<span class="nc" id="L2150">        journalDirectories = Bookie.getCurrentDirectories(bkConf.getJournalDirs());</span>
<span class="nc" id="L2151">        ledgerDirectories = Bookie.getCurrentDirectories(bkConf.getLedgerDirs());</span>
<span class="nc bnc" id="L2152" title="All 2 branches missed.">        if (null == bkConf.getIndexDirs()) {</span>
<span class="nc" id="L2153">            indexDirectories = ledgerDirectories;</span>
        } else {
<span class="nc" id="L2155">            indexDirectories = Bookie.getCurrentDirectories(bkConf.getIndexDirs());</span>
        }
<span class="nc" id="L2157">        formatter = EntryFormatter.newEntryFormatter(bkConf, ENTRY_FORMATTER_CLASS);</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L2159">            LOG.debug(&quot;Using entry formatter {}&quot;, formatter.getClass().getName());</span>
        }
<span class="nc" id="L2161">        pageSize = bkConf.getPageSize();</span>
<span class="nc" id="L2162">        entriesPerPage = pageSize / 8;</span>
<span class="nc" id="L2163">    }</span>

    private void printShellUsage() {
<span class="nc" id="L2166">        System.err.println(</span>
                &quot;Usage: BookieShell [-conf configuration] &lt;command&gt;&quot;);
<span class="nc" id="L2168">        System.err.println();</span>
<span class="nc" id="L2169">        List&lt;String&gt; commandNames = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">        for (MyCommand c : commands.values()) {</span>
<span class="nc" id="L2171">            commandNames.add(&quot;       &quot; + c.getUsage());</span>
<span class="nc" id="L2172">        }</span>
<span class="nc" id="L2173">        Collections.sort(commandNames);</span>
<span class="nc bnc" id="L2174" title="All 2 branches missed.">        for (String s : commandNames) {</span>
<span class="nc" id="L2175">            System.err.println(s);</span>
<span class="nc" id="L2176">        }</span>
<span class="nc" id="L2177">    }</span>

    @VisibleForTesting
    public int execute(String... args) throws Exception {
<span class="nc" id="L2181">        return run(args);</span>
    }

    @Override
    public int run(String[] args) throws Exception {
<span class="nc bnc" id="L2186" title="All 2 branches missed.">        if (args.length &lt;= 0) {</span>
<span class="nc" id="L2187">            printShellUsage();</span>
<span class="nc" id="L2188">            return -1;</span>
        }
<span class="nc" id="L2190">        String cmdName = args[0];</span>
<span class="nc" id="L2191">        Command cmd = commands.get(cmdName);</span>
<span class="nc bnc" id="L2192" title="All 2 branches missed.">        if (null == cmd) {</span>
<span class="nc" id="L2193">            System.err.println(&quot;ERROR: Unknown command &quot; + cmdName);</span>
<span class="nc" id="L2194">            printShellUsage();</span>
<span class="nc" id="L2195">            return -1;</span>
        }
        // prepare new args
<span class="nc" id="L2198">        String[] newArgs = new String[args.length - 1];</span>
<span class="nc" id="L2199">        System.arraycopy(args, 1, newArgs, 0, newArgs.length);</span>
<span class="nc" id="L2200">        return cmd.runCmd(newArgs);</span>
    }

    /**
     * Returns the sorted list of the files in the given folders with the given file extensions.
     * Sorting is done on the basis of CreationTime if the CreationTime is not available or if they are equal
     * then sorting is done by LastModifiedTime
     * @param folderNames - array of folders which we need to look recursively for files with given extensions
     * @param extensions - the file extensions, which we are interested in
     * @return sorted list of files
     */
    public static List&lt;File&gt; listFilesAndSort(File[] folderNames, String... extensions) {
<span class="nc" id="L2212">        List&lt;File&gt; completeFilesList = new ArrayList&lt;File&gt;();</span>
<span class="nc bnc" id="L2213" title="All 2 branches missed.">        for (int i = 0; i &lt; folderNames.length; i++) {</span>
<span class="nc" id="L2214">            Collection&lt;File&gt; filesCollection = FileUtils.listFiles(folderNames[i], extensions, true);</span>
<span class="nc" id="L2215">            completeFilesList.addAll(filesCollection);</span>
        }
<span class="nc" id="L2217">        Collections.sort(completeFilesList, new FilesTimeComparator());</span>
<span class="nc" id="L2218">        return completeFilesList;</span>
    }

    private static class FilesTimeComparator implements Comparator&lt;File&gt;, Serializable {

        private static final long serialVersionUID = 1L;

        @Override
        public int compare(File file1, File file2) {
<span class="nc" id="L2227">            Path file1Path = Paths.get(file1.getAbsolutePath());</span>
<span class="nc" id="L2228">            Path file2Path = Paths.get(file2.getAbsolutePath());</span>
            try {
<span class="nc" id="L2230">                BasicFileAttributes file1Attributes = Files.readAttributes(file1Path, BasicFileAttributes.class);</span>
<span class="nc" id="L2231">                BasicFileAttributes file2Attributes = Files.readAttributes(file2Path, BasicFileAttributes.class);</span>
<span class="nc" id="L2232">                FileTime file1CreationTime = file1Attributes.creationTime();</span>
<span class="nc" id="L2233">                FileTime file2CreationTime = file2Attributes.creationTime();</span>
<span class="nc" id="L2234">                int compareValue = file1CreationTime.compareTo(file2CreationTime);</span>
                /*
                 * please check https://docs.oracle.com/javase/7/docs/api/java/nio/file/attribute/BasicFileAttributes.html#creationTime()
                 * So not all file system implementation store creation time, in that case creationTime()
                 * method may return FileTime representing the epoch (1970-01-01T00:00:00Z). So in that case
                 * it would be better to compare lastModifiedTime
                 */
<span class="nc bnc" id="L2241" title="All 2 branches missed.">                if (compareValue == 0) {</span>
<span class="nc" id="L2242">                    FileTime file1LastModifiedTime = file1Attributes.lastModifiedTime();</span>
<span class="nc" id="L2243">                    FileTime file2LastModifiedTime = file2Attributes.lastModifiedTime();</span>
<span class="nc" id="L2244">                    compareValue = file1LastModifiedTime.compareTo(file2LastModifiedTime);</span>
                }
<span class="nc" id="L2246">                return compareValue;</span>
<span class="nc" id="L2247">            } catch (IOException e) {</span>
<span class="nc" id="L2248">                return 0;</span>
            }
        }
    }

    public static void main(String argv[]) throws Exception {
<span class="nc" id="L2254">        BookieShell shell = new BookieShell();</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">        if (argv.length &lt;= 0) {</span>
<span class="nc" id="L2256">            shell.printShellUsage();</span>
<span class="nc" id="L2257">            System.exit(-1);</span>
        }

<span class="nc" id="L2260">        CompositeConfiguration conf = new CompositeConfiguration();</span>
        // load configuration
<span class="nc bnc" id="L2262" title="All 2 branches missed.">        if (&quot;-conf&quot;.equals(argv[0])) {</span>
<span class="nc bnc" id="L2263" title="All 2 branches missed.">            if (argv.length &lt;= 1) {</span>
<span class="nc" id="L2264">                shell.printShellUsage();</span>
<span class="nc" id="L2265">                System.exit(-1);</span>
            }
<span class="nc" id="L2267">            conf.addConfiguration(new PropertiesConfiguration(</span>
<span class="nc" id="L2268">                                  new File(argv[1]).toURI().toURL()));</span>

<span class="nc" id="L2270">            String[] newArgv = new String[argv.length - 2];</span>
<span class="nc" id="L2271">            System.arraycopy(argv, 2, newArgv, 0, newArgv.length);</span>
<span class="nc" id="L2272">            argv = newArgv;</span>
        }


<span class="nc" id="L2276">        shell.setConf(conf);</span>
<span class="nc" id="L2277">        int res = shell.run(argv);</span>
<span class="nc" id="L2278">        System.exit(res);</span>
<span class="nc" id="L2279">    }</span>

    ///
    /// Bookie File Operations
    ///

    /**
     * Get the ledger file of a specified ledger.
     *
     * @param ledgerId Ledger Id
     *
     * @return file object.
     */
    private File getLedgerFile(long ledgerId) {
<span class="nc" id="L2293">        String ledgerName = IndexPersistenceMgr.getLedgerName(ledgerId);</span>
<span class="nc" id="L2294">        File lf = null;</span>
<span class="nc bnc" id="L2295" title="All 2 branches missed.">        for (File d : indexDirectories) {</span>
<span class="nc" id="L2296">            lf = new File(d, ledgerName);</span>
<span class="nc bnc" id="L2297" title="All 2 branches missed.">            if (lf.exists()) {</span>
<span class="nc" id="L2298">                break;</span>
            }
<span class="nc" id="L2300">            lf = null;</span>
        }
<span class="nc" id="L2302">        return lf;</span>
    }

    /**
     * Get FileInfo for a specified ledger.
     *
     * @param ledgerId Ledger Id
     * @return read only file info instance
     */
    ReadOnlyFileInfo getFileInfo(long ledgerId) throws IOException {
<span class="nc" id="L2312">        File ledgerFile = getLedgerFile(ledgerId);</span>
<span class="nc bnc" id="L2313" title="All 2 branches missed.">        if (null == ledgerFile) {</span>
<span class="nc" id="L2314">            throw new FileNotFoundException(&quot;No index file found for ledger &quot; + ledgerId</span>
                    + &quot;. It may be not flushed yet.&quot;);
        }
<span class="nc" id="L2317">        ReadOnlyFileInfo fi = new ReadOnlyFileInfo(ledgerFile, null);</span>
<span class="nc" id="L2318">        fi.readHeader();</span>
<span class="nc" id="L2319">        return fi;</span>
    }

    private synchronized void initEntryLogger() throws IOException {
<span class="nc bnc" id="L2323" title="All 2 branches missed.">        if (null == entryLogger) {</span>
            // provide read only entry logger
<span class="nc" id="L2325">            entryLogger = new ReadOnlyEntryLogger(bkConf);</span>
        }
<span class="nc" id="L2327">    }</span>

    /**
     * Scan over entry log.
     *
     * @param logId Entry Log Id
     * @param scanner Entry Log Scanner
     */
    protected void scanEntryLog(long logId, EntryLogScanner scanner) throws IOException {
<span class="nc" id="L2336">        initEntryLogger();</span>
<span class="nc" id="L2337">        entryLogger.scanEntryLog(logId, scanner);</span>
<span class="nc" id="L2338">    }</span>

    private synchronized List&lt;Journal&gt; getJournals() throws IOException {
<span class="nc bnc" id="L2341" title="All 2 branches missed.">        if (null == journals) {</span>
<span class="nc" id="L2342">            journals = Lists.newArrayListWithCapacity(bkConf.getJournalDirs().length);</span>
<span class="nc bnc" id="L2343" title="All 2 branches missed.">            for (File journalDir : bkConf.getJournalDirs()) {</span>
<span class="nc" id="L2344">                journals.add(new Journal(journalDir, bkConf, new LedgerDirsManager(bkConf, bkConf.getLedgerDirs(),</span>
<span class="nc" id="L2345">                    new DiskChecker(bkConf.getDiskUsageThreshold(), bkConf.getDiskUsageWarnThreshold()))));</span>
            }
        }
<span class="nc" id="L2348">        return journals;</span>
    }

    /**
     * Scan journal file.
     *
     * @param journalId Journal File Id
     * @param scanner Journal File Scanner
     */
    protected void scanJournal(Journal journal, long journalId, JournalScanner scanner) throws IOException {
<span class="nc" id="L2358">        journal.scanJournal(journalId, 0L, scanner);</span>
<span class="nc" id="L2359">    }</span>

    ///
    /// Bookie Shell Commands
    ///

    /**
     * Read ledger meta.
     *
     * @param ledgerId Ledger Id
     */
    protected void readLedgerMeta(long ledgerId) throws Exception {
<span class="nc" id="L2371">        System.out.println(&quot;===== LEDGER: &quot; + ledgerId + &quot; =====&quot;);</span>
<span class="nc" id="L2372">        FileInfo fi = getFileInfo(ledgerId);</span>
<span class="nc" id="L2373">        byte[] masterKey = fi.getMasterKey();</span>
<span class="nc bnc" id="L2374" title="All 2 branches missed.">        if (null == masterKey) {</span>
<span class="nc" id="L2375">            System.out.println(&quot;master key  : NULL&quot;);</span>
        } else {
<span class="nc" id="L2377">            System.out.println(&quot;master key  : &quot; + bytes2Hex(fi.getMasterKey()));</span>
        }
<span class="nc" id="L2379">        long size = fi.size();</span>
<span class="nc bnc" id="L2380" title="All 2 branches missed.">        if (size % 8 == 0) {</span>
<span class="nc" id="L2381">            System.out.println(&quot;size        : &quot; + size);</span>
        } else {
<span class="nc" id="L2383">            System.out.println(&quot;size : &quot; + size + &quot; (not aligned with 8, may be corrupted or under flushing now)&quot;);</span>
        }
<span class="nc" id="L2385">        System.out.println(&quot;entries     : &quot; + (size / 8));</span>
<span class="nc" id="L2386">        System.out.println(&quot;isFenced    : &quot; + fi.isFenced());</span>
<span class="nc" id="L2387">    }</span>

    /**
     * Read ledger index entires.
     *
     * @param ledgerId Ledger Id
     * @throws IOException
     */
    protected void readLedgerIndexEntries(long ledgerId) throws IOException {
<span class="nc" id="L2396">        System.out.println(&quot;===== LEDGER: &quot; + ledgerId + &quot; =====&quot;);</span>
<span class="nc" id="L2397">        FileInfo fi = getFileInfo(ledgerId);</span>
<span class="nc" id="L2398">        long size = fi.size();</span>
<span class="nc" id="L2399">        System.out.println(&quot;size        : &quot; + size);</span>
<span class="nc" id="L2400">        long curSize = 0;</span>
<span class="nc" id="L2401">        long curEntry = 0;</span>
<span class="nc" id="L2402">        LedgerEntryPage lep = new LedgerEntryPage(pageSize, entriesPerPage);</span>
<span class="nc" id="L2403">        lep.usePage();</span>
        try {
<span class="nc bnc" id="L2405" title="All 2 branches missed.">            while (curSize &lt; size) {</span>
<span class="nc" id="L2406">                lep.setLedgerAndFirstEntry(ledgerId, curEntry);</span>
<span class="nc" id="L2407">                lep.readPage(fi);</span>

                // process a page
<span class="nc bnc" id="L2410" title="All 2 branches missed.">                for (int i = 0; i &lt; entriesPerPage; i++) {</span>
<span class="nc" id="L2411">                    long offset = lep.getOffset(i * 8);</span>
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                    if (0 == offset) {</span>
<span class="nc" id="L2413">                        System.out.println(&quot;entry &quot; + curEntry + &quot;\t:\tN/A&quot;);</span>
                    } else {
<span class="nc" id="L2415">                        long entryLogId = offset &gt;&gt; 32L;</span>
<span class="nc" id="L2416">                        long pos = offset &amp; 0xffffffffL;</span>
<span class="nc" id="L2417">                        System.out.println(&quot;entry &quot; + curEntry + &quot;\t:\t(log:&quot; + entryLogId + &quot;, pos: &quot; + pos + &quot;)&quot;);</span>
                    }
<span class="nc" id="L2419">                    ++curEntry;</span>
                }

<span class="nc" id="L2422">                curSize += pageSize;</span>
            }
<span class="nc" id="L2424">        } catch (IOException ie) {</span>
<span class="nc" id="L2425">            LOG.error(&quot;Failed to read index page : &quot;, ie);</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">            if (curSize + pageSize &lt; size) {</span>
<span class="nc" id="L2427">                System.out.println(&quot;Failed to read index page @ &quot; + curSize + &quot;, the index file may be corrupted : &quot;</span>
<span class="nc" id="L2428">                        + ie.getMessage());</span>
            } else {
<span class="nc" id="L2430">                System.out.println(&quot;Failed to read last index page @ &quot; + curSize + &quot;, the index file may be corrupted &quot;</span>
<span class="nc" id="L2431">                        + &quot;or last index page is not fully flushed yet : &quot; + ie.getMessage());</span>
            }
<span class="nc" id="L2433">        }</span>
<span class="nc" id="L2434">    }</span>

    /**
     * Scan over an entry log file.
     *
     * @param logId
     *          Entry Log File id.
     * @param printMsg
     *          Whether printing the entry data.
     */
    protected void scanEntryLog(long logId, final boolean printMsg) throws Exception {
<span class="nc" id="L2445">        System.out.println(&quot;Scan entry log &quot; + logId + &quot; (&quot; + Long.toHexString(logId) + &quot;.log)&quot;);</span>
<span class="nc" id="L2446">        scanEntryLog(logId, new EntryLogScanner() {</span>
            @Override
            public boolean accept(long ledgerId) {
<span class="nc" id="L2449">                return true;</span>
            }
            @Override
            public void process(long ledgerId, long startPos, ByteBuffer entry) {
<span class="nc" id="L2453">                formatEntry(startPos, entry, printMsg);</span>
<span class="nc" id="L2454">            }</span>
        });
<span class="nc" id="L2456">    }</span>

    /**
     * Scan over an entry log file for a particular entry.
     *
     * @param logId Entry Log File id.
     * @param ledgerId id of the ledger
     * @param entryId entryId of the ledger we are looking for (-1 for all of the entries of the ledger)
     * @param printMsg Whether printing the entry data.
     * @throws Exception
     */
    protected void scanEntryLogForSpecificEntry(long logId, final long ledgerId, final long entryId,
                                                final boolean printMsg) throws Exception {
<span class="nc bnc" id="L2469" title="All 2 branches missed.">        System.out.println(&quot;Scan entry log &quot; + logId + &quot; (&quot; + Long.toHexString(logId) + &quot;.log)&quot; + &quot; for LedgerId &quot;</span>
                + ledgerId + ((entryId == -1) ? &quot;&quot; : &quot; for EntryId &quot; + entryId));
<span class="nc" id="L2471">        final MutableBoolean entryFound = new MutableBoolean(false);</span>
<span class="nc" id="L2472">        scanEntryLog(logId, new EntryLogScanner() {</span>
            @Override
            public boolean accept(long ledgerId) {
<span class="nc bnc" id="L2475" title="All 4 branches missed.">                return (((!entryFound.booleanValue()) || (entryId == -1)));</span>
            }

            @Override
            public void process(long ledgerId, long startPos, ByteBuffer entry) {
<span class="nc" id="L2480">                long entrysLedgerId = entry.getLong();</span>
<span class="nc" id="L2481">                long entrysEntryId = entry.getLong();</span>
<span class="nc" id="L2482">                entry.rewind();</span>
<span class="nc bnc" id="L2483" title="All 6 branches missed.">                if ((ledgerId == entrysLedgerId) &amp;&amp; ((entrysEntryId == entryId)) || (entryId == -1)) {</span>
<span class="nc" id="L2484">                    entryFound.setValue(true);</span>
<span class="nc" id="L2485">                    formatEntry(startPos, entry, printMsg);</span>
                }
<span class="nc" id="L2487">            }</span>
        });
<span class="nc bnc" id="L2489" title="All 2 branches missed.">        if (!entryFound.booleanValue()) {</span>
<span class="nc bnc" id="L2490" title="All 2 branches missed.">            System.out.println(&quot;LedgerId &quot; + ledgerId + ((entryId == -1) ? &quot;&quot; : &quot; EntryId &quot; + entryId)</span>
<span class="nc" id="L2491">                    + &quot; is not available in the entry log &quot; + logId + &quot; (&quot; + Long.toHexString(logId) + &quot;.log)&quot;);</span>
        }
<span class="nc" id="L2493">    }</span>

    /**
     * Scan over an entry log file for entries in the given position range.
     *
     * @param logId Entry Log File id.
     * @param rangeStartPos Start position of the entry we are looking for
     * @param rangeEndPos End position of the entry we are looking for (-1 for till the end of the entrylog)
     * @param printMsg Whether printing the entry data.
     * @throws Exception
     */
    protected void scanEntryLogForPositionRange(long logId, final long rangeStartPos, final long rangeEndPos,
                                                final boolean printMsg) throws Exception {
<span class="nc" id="L2506">        System.out.println(&quot;Scan entry log &quot; + logId + &quot; (&quot; + Long.toHexString(logId) + &quot;.log)&quot; + &quot; for PositionRange: &quot;</span>
                + rangeStartPos + &quot; - &quot; + rangeEndPos);
<span class="nc" id="L2508">        final MutableBoolean entryFound = new MutableBoolean(false);</span>
<span class="nc" id="L2509">        scanEntryLog(logId, new EntryLogScanner() {</span>
<span class="nc" id="L2510">            private MutableBoolean stopScanning = new MutableBoolean(false);</span>

            @Override
            public boolean accept(long ledgerId) {
<span class="nc bnc" id="L2514" title="All 2 branches missed.">                return !stopScanning.booleanValue();</span>
            }

            @Override
            public void process(long ledgerId, long entryStartPos, ByteBuffer entry) {
<span class="nc bnc" id="L2519" title="All 2 branches missed.">                if (!stopScanning.booleanValue()) {</span>
<span class="nc bnc" id="L2520" title="All 4 branches missed.">                    if ((rangeEndPos != -1) &amp;&amp; (entryStartPos &gt; rangeEndPos)) {</span>
<span class="nc" id="L2521">                        stopScanning.setValue(true);</span>
                    } else {
<span class="nc" id="L2523">                        int entrySize = entry.limit();</span>
                        /**
                         * entrySize of an entry (inclusive of payload and
                         * header) value is stored as int value in log file, but
                         * it is not counted in the entrySize, hence for calculating
                         * the end position of the entry we need to add additional
                         * 4 (intsize of entrySize). Please check
                         * EntryLogger.scanEntryLog.
                         */
<span class="nc" id="L2532">                        long entryEndPos = entryStartPos + entrySize + 4 - 1;</span>
<span class="nc bnc" id="L2533" title="All 6 branches missed.">                        if (((rangeEndPos == -1) || (entryStartPos &lt;= rangeEndPos)) &amp;&amp; (rangeStartPos &lt;= entryEndPos)) {</span>
<span class="nc" id="L2534">                            formatEntry(entryStartPos, entry, printMsg);</span>
<span class="nc" id="L2535">                            entryFound.setValue(true);</span>
                        }
                    }
                }
<span class="nc" id="L2539">            }</span>
        });
<span class="nc bnc" id="L2541" title="All 2 branches missed.">        if (!entryFound.booleanValue()) {</span>
<span class="nc" id="L2542">            System.out.println(&quot;Entry log &quot; + logId + &quot; (&quot; + Long.toHexString(logId)</span>
                    + &quot;.log) doesn't has any entry in the range &quot; + rangeStartPos + &quot; - &quot; + rangeEndPos
                    + &quot;. Probably the position range, you have provided is lesser than the LOGFILE_HEADER_SIZE (1024) &quot;
                    + &quot;or greater than the current log filesize.&quot;);
        }
<span class="nc" id="L2547">    }</span>

    /**
     * Scan a journal file.
     *
     * @param journalId Journal File Id
     * @param printMsg Whether printing the entry data.
     */
    protected void scanJournal(Journal journal, long journalId, final boolean printMsg) throws Exception {
<span class="nc" id="L2556">        System.out.println(&quot;Scan journal &quot; + journalId + &quot; (&quot; + Long.toHexString(journalId) + &quot;.txn)&quot;);</span>
<span class="nc" id="L2557">        scanJournal(journal, journalId, new JournalScanner() {</span>
<span class="nc" id="L2558">            boolean printJournalVersion = false;</span>
            @Override
            public void process(int journalVersion, long offset, ByteBuffer entry) throws IOException {
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                if (!printJournalVersion) {</span>
<span class="nc" id="L2562">                    System.out.println(&quot;Journal Version : &quot; + journalVersion);</span>
<span class="nc" id="L2563">                    printJournalVersion = true;</span>
                }
<span class="nc" id="L2565">                formatEntry(offset, entry, printMsg);</span>
<span class="nc" id="L2566">            }</span>
        });
<span class="nc" id="L2568">    }</span>

    /**
     * Print last log mark.
     */
    protected void printLastLogMark() throws IOException {
<span class="nc bnc" id="L2574" title="All 2 branches missed.">        for (Journal journal : getJournals()) {</span>
<span class="nc" id="L2575">            LogMark lastLogMark = journal.getLastLogMark().getCurMark();</span>
<span class="nc" id="L2576">            System.out.println(&quot;LastLogMark: Journal Id - &quot; + lastLogMark.getLogFileId() + &quot;(&quot;</span>
<span class="nc" id="L2577">                    + Long.toHexString(lastLogMark.getLogFileId()) + &quot;.txn), Pos - &quot;</span>
<span class="nc" id="L2578">                    + lastLogMark.getLogFileOffset());</span>
<span class="nc" id="L2579">        }</span>
<span class="nc" id="L2580">    }</span>

    /**
     * Format the entry into a readable format.
     *
     * @param entry
     *          ledgerentry to print
     * @param printMsg
     *          Whether printing the message body
     */
    private void formatEntry(LedgerEntry entry, boolean printMsg) {
<span class="nc" id="L2591">        long ledgerId = entry.getLedgerId();</span>
<span class="nc" id="L2592">        long entryId = entry.getEntryId();</span>
<span class="nc" id="L2593">        long entrySize = entry.getLength();</span>
<span class="nc" id="L2594">        System.out</span>
<span class="nc" id="L2595">                .println(&quot;--------- Lid=&quot; + ledgerId + &quot;, Eid=&quot; + entryId + &quot;, EntrySize=&quot; + entrySize + &quot; ---------&quot;);</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">        if (printMsg) {</span>
<span class="nc" id="L2597">            formatter.formatEntry(entry.getEntry());</span>
        }
<span class="nc" id="L2599">    }</span>

    /**
     * Format the message into a readable format.
     *
     * @param pos
     *          File offset of the message stored in entry log file
     * @param recBuff
     *          Entry Data
     * @param printMsg
     *          Whether printing the message body
     */
    private void formatEntry(long pos, ByteBuffer recBuff, boolean printMsg) {
<span class="nc" id="L2612">        long ledgerId = recBuff.getLong();</span>
<span class="nc" id="L2613">        long entryId = recBuff.getLong();</span>
<span class="nc" id="L2614">        int entrySize = recBuff.limit();</span>

<span class="nc" id="L2616">        System.out.println(&quot;--------- Lid=&quot; + ledgerId + &quot;, Eid=&quot; + entryId</span>
                         + &quot;, ByteOffset=&quot; + pos + &quot;, EntrySize=&quot; + entrySize + &quot; ---------&quot;);
<span class="nc bnc" id="L2618" title="All 2 branches missed.">        if (entryId == Bookie.METAENTRY_ID_LEDGER_KEY) {</span>
<span class="nc" id="L2619">            int masterKeyLen = recBuff.getInt();</span>
<span class="nc" id="L2620">            byte[] masterKey = new byte[masterKeyLen];</span>
<span class="nc" id="L2621">            recBuff.get(masterKey);</span>
<span class="nc" id="L2622">            System.out.println(&quot;Type:           META&quot;);</span>
<span class="nc" id="L2623">            System.out.println(&quot;MasterKey:      &quot; + bytes2Hex(masterKey));</span>
<span class="nc" id="L2624">            System.out.println();</span>
<span class="nc" id="L2625">            return;</span>
        }
<span class="nc bnc" id="L2627" title="All 2 branches missed.">        if (entryId == Bookie.METAENTRY_ID_FENCE_KEY) {</span>
<span class="nc" id="L2628">            System.out.println(&quot;Type:           META&quot;);</span>
<span class="nc" id="L2629">            System.out.println(&quot;Fenced&quot;);</span>
<span class="nc" id="L2630">            System.out.println();</span>
<span class="nc" id="L2631">            return;</span>
        }
        // process a data entry
<span class="nc" id="L2634">        long lastAddConfirmed = recBuff.getLong();</span>
<span class="nc" id="L2635">        System.out.println(&quot;Type:           DATA&quot;);</span>
<span class="nc" id="L2636">        System.out.println(&quot;LastConfirmed:  &quot; + lastAddConfirmed);</span>
<span class="nc bnc" id="L2637" title="All 2 branches missed.">        if (!printMsg) {</span>
<span class="nc" id="L2638">            System.out.println();</span>
<span class="nc" id="L2639">            return;</span>
        }
        // skip digest checking
<span class="nc" id="L2642">        recBuff.position(32 + 8);</span>
<span class="nc" id="L2643">        System.out.println(&quot;Data:&quot;);</span>
<span class="nc" id="L2644">        System.out.println();</span>
        try {
<span class="nc" id="L2646">            byte[] ret = new byte[recBuff.remaining()];</span>
<span class="nc" id="L2647">            recBuff.get(ret);</span>
<span class="nc" id="L2648">            formatter.formatEntry(ret);</span>
<span class="nc" id="L2649">        } catch (Exception e) {</span>
<span class="nc" id="L2650">            System.out.println(&quot;N/A. Corrupted.&quot;);</span>
<span class="nc" id="L2651">        }</span>
<span class="nc" id="L2652">        System.out.println();</span>
<span class="nc" id="L2653">    }</span>

    static String bytes2Hex(byte[] data) {
<span class="nc" id="L2656">        StringBuilder sb = new StringBuilder(data.length * 2);</span>
<span class="nc" id="L2657">        Formatter formatter = new Formatter(sb);</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">        for (byte b : data) {</span>
<span class="nc" id="L2659">            formatter.format(&quot;%02x&quot;, b);</span>
        }
<span class="nc" id="L2661">        formatter.close();</span>
<span class="nc" id="L2662">        return sb.toString();</span>
    }

    private static int getOptionIntValue(CommandLine cmdLine, String option, int defaultVal) {
<span class="nc bnc" id="L2666" title="All 2 branches missed.">        if (cmdLine.hasOption(option)) {</span>
<span class="nc" id="L2667">            String val = cmdLine.getOptionValue(option);</span>
            try {
<span class="nc" id="L2669">                return Integer.parseInt(val);</span>
<span class="nc" id="L2670">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L2671">                System.err.println(&quot;ERROR: invalid value for option &quot; + option + &quot; : &quot; + val);</span>
<span class="nc" id="L2672">                return defaultVal;</span>
            }
        }
<span class="nc" id="L2675">        return defaultVal;</span>
    }

    private static long getOptionLongValue(CommandLine cmdLine, String option, long defaultVal) {
<span class="nc bnc" id="L2679" title="All 2 branches missed.">        if (cmdLine.hasOption(option)) {</span>
<span class="nc" id="L2680">            String val = cmdLine.getOptionValue(option);</span>
            try {
<span class="nc" id="L2682">                return Long.parseLong(val);</span>
<span class="nc" id="L2683">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L2684">                System.err.println(&quot;ERROR: invalid value for option &quot; + option + &quot; : &quot; + val);</span>
<span class="nc" id="L2685">                return defaultVal;</span>
            }
        }
<span class="nc" id="L2688">        return defaultVal;</span>
    }

    private static boolean getOptionBooleanValue(CommandLine cmdLine, String option, boolean defaultVal) {
<span class="nc bnc" id="L2692" title="All 2 branches missed.">        if (cmdLine.hasOption(option)) {</span>
<span class="nc" id="L2693">            String val = cmdLine.getOptionValue(option);</span>
<span class="nc" id="L2694">            return Boolean.parseBoolean(val);</span>
        }
<span class="nc" id="L2696">        return defaultVal;</span>
    }

    private static boolean getOptionalValue(String optValue, String optName) {
<span class="nc bnc" id="L2700" title="All 2 branches missed.">        if (StringUtils.equals(optValue, optName)) {</span>
<span class="nc" id="L2701">            return true;</span>
        }
<span class="nc" id="L2703">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>